
<script type="text/javascript" src="//static.cottagelabs.com/bootstrap-datepicker/bootstrap-datepicker.min.js"></script>
<link rel="stylesheet" href="//static.cottagelabs.com/bootstrap-datepicker/bootstrap-datepicker3.min.css">


<div class="container-fluid" id="no" style="display:none;">
  <div class="row">
    <div class="col-md-12">
      <div class="jumbotron">
        <h2>You cannot access admin</h2>
      </div>
    </div>
  </div>
</div>


<div class="container-fluid" id="export" style="display:none;">
  <div class="row">
    <div class="col-md-12">
      <input type="text" class="form-control holder holder-search" style="display:none;">
      <h1>EXPORT</h1>
      
      <div class="row">
        <div class="col-md-12">
          <select id="what" class="form-control">
            <option value="">Export what?</option>
            <option value="account">Users</option>
            <option value="request">Requests</option>
            <option value="availability">Availabilities</option>
            <option value="support">Supports</option>
          </select>          
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-6">
          <input type="text" id="from" class="form-control datepicker" placeholder="From" style="margin-bottom:2px;">
        </div>
        <div class="col-md-6">
          <input type="text" id="to" class="form-control datepicker" placeholder="To">
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-6">
          <select id="filter" class="form-control" style="margin-bottom:2px;">
            <option value="">Filter by:</option>
          </select>
        </div>
        <div class="col-md-6">
          <select id="value" class="form-control">
            <option value="">for value:</option>
          </select>
        </div>
      </div>
      
      <div class="row">
        <div class="col-md-6">
          <input type="radio" name="format" value="csv" checked="checked"> CSV &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          <input type="radio" name="format" value="json"> JSON
        </div>
        <div class="col-md-6">
          <input type="radio" name="data" value="records" checked="checked"> Records &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          <input type="radio" name="data" value="summary"> Summary &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
          <a class="btn btn-primary" href="#" id="go" target="_blank">Export</a>
        </div>
      </div>

    </div>
  </div>
</div>






<script>
  jQuery(document).ready(function() {
    if (!clogin.loggedin()) {
      $('#no').show();
      window.location = '/account?next=/export';
    }

    var api = 'https://api.openaccessbutton.org';
    if (window.location.host.indexOf('openaccessbutton.org') === -1) {
      api = 'https://dev.api.cottagelabs.com/service/oab';
      clogin.api = 'https://dev.api.cottagelabs.com/accounts';
    }
    
    $('.datepicker').datepicker({
      format:'dd/mm/yyyy',
      autoclose:true
    });

    var time = function(timestamp){
      var d = new Date(timestamp);
      var year = d.getFullYear();
      var month = d.getMonth() + 1;
      var date = d.getDate();
      //var hour = a.getHours();
      //var min = a.getMinutes();
      //var sec = a.getSeconds();
      var time = date + '/' + month + '/' + year; // + ' ' + hour + ':' + min + ':' + sec ;
      return time;
    }

    var changed = {from:undefined,to:undefined};
    var change_date = function(e) {
      changed[$(this).attr('id')] = $(this).val();
    }
    $('.datepicker').bind('change',change_date);

    var what = function(e) {
      $('.datepicker').val('');
      $('#filter').html('<option value="">Filter by:</option>');
      $('#value').html('<option value="">for value:</option>');
      var w = $(this).val();
      if (w) {
        $.ajax({
          type:'GET',
          url: api+'/minmax/' + w + '/createdAt?apikey='+clogin.apikey,
          success: function(data) {
            var min = time(data.min);
            $('#from').val(min);
            $('#from').datepicker('setStartDate',min);
            $('#to').datepicker('setStartDate',min);
            var max = time(data.max);
            $('#to').val(max);
            $('#from').datepicker('setEndDate',max);
            $('#to').datepicker('setEndDate',max);
            changed.from = undefined; // no need to set a date range unless the user changes the date range, so unset on first load
            changed.to = undefined;
          }
        });
        $.ajax({
          type:'GET',
          url: api+'/keys/' + w + '?apikey='+clogin.apikey,
          success: function(data) {
            for ( var k in data ) {
              $('#filter').append('<option>' + data[k] + '</option>');
            }
          }
        });
      }
    }
    $('#what').bind('change',what);
    
    var filter = function(e) {
      $('#value').html('<option value="">for value:</option>');
      var w = $('#what').val();
      var k = $(this).val();
      $.ajax({
        type:'GET',
        url: api+'/terms/' + w + '/' + k + '.exact?apikey='+clogin.apikey,
        success: function(data) {
          for ( var k in data ) {
            $('#value').append('<option value="' + data[k].term + '">' + data[k].term + ' (' + data[k].count + ')</option>');
          }
        }
      });      
    }
    $('#filter').bind('change',filter);
        
    var go = function() {
      var size = 10; // perhaps there needs to be a download batch size option, and/or a check on how many records are available to download
      // build a query URL, which prob needs apikey too, then pass it to convert to CSV
      // or if JSON, still need to convert into proper objects, not just ES query result
      // also, what fields are to be displayed in the export anyway?
      var fields = {
        account: [],
        request: [],
        support: [],
        availability: []
      }
      var endpoint = 'requests';
      if ($('#what').val() === 'account') endpoint = 'users';
      if ($('#what').val() === 'availability') endpoint = 'availabilities';
      if ($('#what').val() === 'support') endpoint = 'supports';
      var url = api + '/' + endpoint + '?size=' + size;
      if ( $('#value').val() ) url += '&q=' + $('#filter').val() + ':"' + $('#value').val() + '"';
      if (false) {} // TODO if there is a changed.from and/or changed.to selected, apply a date range filter to the query
      if ($('#what').val() === 'account') url += '&apikey=' + clogin.apikey;
      var curl = clogin.api.replace('/accounts','/convert?from=json&to=csv&subset=hits.hits._source&url='+encodeURIComponent(url));
      $(this).attr('href',curl);
    }
    $('#go').bind('click',go);
    
    clogin.afterLogin = function() {
      if (!clogin.hasRole('openaccessbutton.admin')) window.location = '/';
      $('#no').hide();
      $('#export').show();
    }
    clogin.login();
    
    
  });
</script>


