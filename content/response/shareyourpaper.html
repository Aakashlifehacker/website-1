<script src="/static/request_response.js"></script>

<style>
  .panels {
    margin:20px 0px 20px 0px;
    min-height:300px;
  }

</style>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">

      <div id="missing" style="display:none;">
          <p>Sorry, we have no record of expecting to receive any items at this URL. If you think we should be, please <a href="mailto:requests@openaccessbutton.org">get in touch</a>, mention this URL and include any files or links you'd like shared.</p>
      </div>

      <!--

      <div id="request" style="display:none;">
      </div>

    -->

    <div id="shareyourpaper" style="display:none;">
      <p>Step: 1 of 1</p>
      <h2>
        You can freely share your paper now!
      </h2>

    </div>

      <div id="error" style="display:none;">
          <p>
            Sorry, there has been a submission error. Please <a href="mailto:requests@openaccessbutton.org?subject=Submission%20error&body=Dear%20Natalia%2C%20%0A%0AThere%20has%20been%20a%20submission%20error%20when%20I%20tried%20to%20upload%20my%20article%20to%3A%20%3C%3Ccopy%20and%20paste%20the%20link%20to%20the%20page%3E%3E%0A%0AThe%20article%20I%20was%20trying%20to%20upload%20is%20attached.">get in touch</a>
            and let us know what you were trying to upload (please attach it), and the URL of this page.</p>
      </div>

      <div class="panels" id="upload" style="margin-bottom:100px;">
        <div class="row">
          <div class="col-md-12">
            <!-- hiding to simplify
            <p>
              Thank you for responding to our request. Let’s help more people get access to this research.
            </p>
          -->

          <p id="sherpa_green" style="display:none">
            To enable colleagues and the public to freely download and cite your paper your journal lets you freely share a version of your paper. <b>To upload</b>:
            <br>

            <ul>
              <li><b>✓ Find the version that was accepted. It’s usually not a PDF.<b></li>
                <p>
                  This is the only version you’re able to share legally. The accepted version, or ‘post-print’ is version after peer-review, and before typesetting, that was accepted for publication.
                </p>
              <li><b>✓ Check there isn’t publisher branding or typesetting<b></li>
                <p>
                  To prevent confusion with the final published pdf, which will be linked to for those who can afford to access it.
                </p>
            </ul>

          </p>
          <p id="sherpa_blue" style="display:none">
            <ul>
              <li><b>✓ Find the version that was accepted. It’s usually not a PDF.<b></li>
                <p>
                  This is the only version you’re able to share legally. The accepted version, or ‘post-print’ is version after peer-review, and before typesetting, that was accepted for publication.
                </p>
              <li><b>✓ Check there isn’t publisher branding or typesetting<b></li>
                <p>
                  To prevent confusion with the final published pdf, which will be linked to for those who can afford to access it.
                </p>
            </ul>
          </p>
          <p id="sherpa_yellow" style="display:none">
            You can legally share the submitted version of your article! <a data-toggle="modal" data-target="#preprint" title="preprint">Here is what that is, and how to find it.</a>
          </p>
          <p id="sherpa_unknown" style="display:none">
            If you're unsure what version you can legally share <a href="mailto:requests@openaccessbutton.org?subject=What%20version%20of%20my%20article%20can%20I%20share%3F&body=Dear%20Natalia%2C%20%0A%0AI'd%20like%20to%20know%20what%20version%20of%20my%20article%20I%20can%20share,%20can%20you%20please%20help?%20The%20link%20to%20my%20deposit%20page%20is%20here%3A%20%3C%3Ccopy%20link%20of%20the%20page%20you're%20on%3E%3E">get in touch with us</a> or your librarian for advice on what you can deposit.
          </p>

          <!-- Original Responses
            <p id="sherpa_green" style="display:none;text-align:center;">
              You can legally share the accepted version of your article! <a data-toggle="modal" data-target="#accepted" title="accepted">Here is what that is, and how to find it.</a>
            </p>
            <p id="sherpa_blue" style="display:none;text-align:center;">
              You can legally share the accepted version of your article! <a data-toggle="modal" data-target="#accepted" title="accepted">Here is what that is, and how to find it.</a>
            </p>
            <p id="sherpa_yellow" style="display:none;text-align:center;">
              You can legally share the submitted version of your article! <a data-toggle="modal" data-target="#preprint" title="preprint">Here is what that is, and how to find it.</a>
            </p>
            <p id="sherpa_unknown" style="display:none;text-align:center;">
              If you're unsure what version you can legally share <a href="mailto:requests@openaccessbutton.org?subject=What%20version%20of%20my%20article%20can%20I%20share%3F&body=Dear%20Natalia%2C%20%0A%0AI'd%20like%20to%20know%20what%20version%20of%20my%20article%20I%20can%20share,%20can%20you%20please%20help?%20The%20link%20to%20my%20deposit%20page%20is%20here%3A%20%3C%3Ccopy%20link%20of%20the%20page%20you're%20on%3E%3E">get in touch with us</a> or your librarian for advice on what you can deposit.
            </p>
          -->

          </div>
        </div>
        <div class="row">
          <div class="col-md-6" style="display:none">

            <h3>Share by URL</h3>
            <p class="typearticle">
              If the article is already publicly available online please share a full text link to a repository or your website.
            </p>

            <input style="margin-bottom:5px;" id="url" type="text" class="form-control" placeholder="Enter the publicly available URL here">
            <p class="admin" style="display:none;color:orange;"><input type="checkbox" id="urlnotfromauthor"> Tick if URL not provided by author</p>
            <a href="#" class="btn btn-warning btn-block admin" style="display:none;margin-top:5px;" id="adminsubmiturl">submit URL as Admin</a>
            <a href="#" class="btn btn-action btn-block" style="margin-top:5px;margin-bottom:30px;" id="submiturl">Submit your URL</a>
            <p id="warn" style="display:none;">
              Papers posted on ResearchGate and Academia.edu are often illegal and aren't properly preserved. Most publishers allow
              you to publicly share the accepted version of your paper in a repository. We suggest checking
              <a target="_blank" href="http://www.sherpa.ac.uk/romeo/">SHERPA/RoMEO</a> or looking at your publishing agreement to determine what you're allowed to post and where.
              If you want it to be available to everyone, forever, we suggest uploading a copy to
              <a target="_blank" href="https://zenodo.org/">Zenodo</a>. If you give us a copy, we'll upload it to Zenodo for you! If you're sure the copy your entering is legal, you can hit submit again and we'll accept it!
            </p>
          </div>

          <div class="col-md-6">
            <h4>We’ll then preserve, and promote your work.</h4>
            <form id="fileupload" enctype="multipart/form-data" method="POST">
              <input type="file" name="file" id="file" class="form-control" style="margin-bottom:5px;">
              <input type="hidden" name="service" value="openaccessbutton">
              <input type="hidden" name="dirId" id="dirId" value="">
              <p class="typearticle">
                By uploading you're agreeing to licence your article <a id="licenselink" href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY</a> on <a target="_blank" href="https://zenodo.org" target="_blank">Zenodo</a>.
              </p>
              <!--
              <input style="margin-top:5px;margin-bottom:5px;" id="title" type="text" class="form-control" placeholder="Enter the title here">
              <input style="margin-top:5px;margin-bottom:5px;" id="firstname" type="text" class="form-control" placeholder="first name">
              <input style="margin-top:5px;margin-bottom:5px;" id="lastname" type="text" class="form-control" placeholder="last name">
              <textarea id="description" class="form-control" style="min-height:150px;margin-top:5px;" placeholder="Please provide an abstract / brief description"></textarea>
              -->
              <p class="admin" style="display:none;color:orange;"><input type="checkbox" id="filenotfromauthor"> Tick if file not provided by author</p>
              <input type="submit" class="btn btn-warning btn-block admin" style="margin-top:5px;display:none;" id="adminsubmitfile" value="Upload file as Admin">
              <input type="submit" class="btn btn-action btn-block" style="margin-top:5px;" id="submitfile" value="Upload your file">
              <p><a href="">Or, give us a link to your paper</a></p>
            </form>
          </div>
        <!--
        <div class="col-md-12" id="refusepls" style="display:none;">
            <h3>Can't share?</h3>
            <p class="typearticle">
              If you are the author and you can't share your article, or don't want to, you can <a href="#" id="showrefuse">click here</a> and we'll let the requestor know.
            </p>
        </div>
      -->
      </div>

      </div>

      <div class="panels" id="loading" style="display:none;">
        <img style="height:20px;" src="/static/spin_orange.svg"><br>
        <p>Loading, please wait a minute (or longer if your file was large)</p>
      </div>

      <div class="panels" id="submitted">
          <h3>Thank you for submitting your content!</h3>
          <p>
            The link to your content
            <span class="noturl" style="display:none;">, saved
            <span class="typearticle">on Zenodo</span>,
            </span> will appear on the
            <a class="requestlink" href="/request">request</a>
            page in a few minutes.
          </p>
          <!-- <p>
            We will inform our community that you have provided this,
            and it will be validated to ensure it is what is needed.
          </p> -->
      </div>

      <!-- no longer in use


      <div class="panels" id="validating">
          <h3>This content has been made freely available!</h3>
          <p>
            Please view the request (above) for a link to the article.
          </p>
      </div>


      <div class="panels" id="validated">
          <h3>There is no further action to take.</h3>
          <p>
            This content has already been received and validated. Please view the original request (above) for further information.
          </p>
      </div>

    -->

      <div class="admin" style="display:none;color:orange;">
        <a href="#" class="btn btn-warning showupload" style="display:none;">Show upload form</a>
      </div>

      <!-- no longer in use

      <div class="panels" id="hold">
          <h3>Thank you for your response.</h3>
          <p>
            We will put this request on hold for <span id="holdlength">X</span> days.
          </p>
      </div>

      <div class="panels" id="confirmrefuse">
          <p>
            We are sorry that you are unable to provide the content. We will let requestors know it cannot be made available, and display that on the request page.
          </p>
          <p>Please complete your email address below to allow us to confirm that you cannot provide the content:</p>

          <div class="input-group">
            <input type="text" id="confirmemail" class="form-control" ></input>
            <div class="input-group-btn">
              <a class="btn btn-action btn-block" style="padding-left:3px;padding-right:3px;" href="#" id="dorefuse">Confirm</a>
            </div>
          </div>

          <p id="noconfirm" style="display:none;">Sorry, that email does not match. Please try again, or try our <a href="/feedback#noshare?confirmed=false">feedback</a> page if you continue to have difficulties.</p>
      </div>

      <div class="panels" id="refused">
        <p>Thanks for letting us know you can't provide this content.</p>
        <p>It would be great if you could give us some more <a id="refusefeedback" href="/feedback#noshare">feedback</a> about why you could not share the content.</p>
      </div>

    -->

      <div id="foradmin" style="display:none;"></div>
    </div>
  </div>
</div>


<!-- Instructions for finding stuff -->

<div class="modal fade" id="preprint" tabindex="-1" role="dialog" aria-labelledby="preprintLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h3 class="modal-title" id="preprintLabel">Finding the submitted version</h3>
      </div>
      <div class="modal-body">
        <p><i>Also known as: Pre-print, author's manuscript, original manuscript, first draft.</i></p>
        <p>This is the draft of the manuscript before formal peer-review, or the first version sent to the journal for consideration.</p>
        <p>It is usually a .DOCX file, and shouldn't have publisher logos or formatting.</p>
        <img src="/static/RightandWrong.png" style="width:100%;" class="responsive">
        <h3>To find it</h3>
        <ul>
          <li>Search your email, hard-drive and cloud storage</li>
          <li>Ask your co-authors if they have a copy</li>
          <li>Retrieve a copy from the journal's submission system</li>
          <li>Contact the journal by email and ask for a copy of the accepted version</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="accepted" tabindex="-1" role="dialog" aria-labelledby="acceptedLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h3 class="modal-title" id="acceptedLabel">Finding the accepted version</h3>
      </div>
      <div class="modal-body">
        <p><i>Also known as: AAM, post-print, author accepted manuscript, accepted author manuscript.</i></p>
        <p>This is the final version of the manuscript after formal peer-review but before being type-set by the publisher. It contains all revisions made during the peer-review process.</p>
        <p>It is usually a .DOCX file, and shouldn't have publisher logos or formatting.</p>
        <img src="/static/RightandWrong.png" style="width:100%" class="responsive">
        <h3>To find it</h3>
        <ul>
          <li>Search your email, hard-drive and cloud storage</li>
          <li>Ask your co-authors if they have a copy</li>
          <li>Retrieve a copy from the journal's submission system</li>
          <li>Contact the journal by email and ask for a copy of the accepted version</li>
        </ul>
        </div>
    </div>
  </div>
</div>

<!-- End of instructions -->


<script>
  $.fn.setCursorPosition = function(pos) {
    this.each(function(index, elem) {
      if (elem.setSelectionRange) {
        elem.setSelectionRange(pos, pos);
      } else if (elem.createTextRange) {
        var range = elem.createTextRange();
        range.collapse(true);
        range.moveEnd('character', pos);
        range.moveStart('character', pos);
        range.select();
      }
    });
    return this;
  };

  jQuery(document).ready(function() {

    $('.typearticle').hide();
    $('.panels').hide();
    var rid = window.location.pathname.split('/')[2];
    var clickedadmin = false;
    var firstsubmit = true;

    var showrefuse = function(e) {
      e.preventDefault();
      $('.panels').hide();
      $('#confirmrefuse').show();
      $('#confirmemail').focus().val('@' + rec.email.split('@')[1]).setCursorPosition(0);
    }
    $('#showrefuse').bind('click',showrefuse);
    var dorefuse = function(e) {
      e.preventDefault();
      if ($('#confirmemail').val() === rec.email) {
        $.ajax({
          type: 'GET',
          url: api + '/receive/' + rid + '/refuse?email=' + encodeURIComponent(rec.email),
          success: function() {
            $('.panels').hide();
            $('#refused').show();
            $('#refusefeedback').attr('href','/feedback#noshare?request=' + rec._id);
            //window.location = '/feedback#noshare?request=' + rec._id;
          }
        });
      } else {
        $('#noconfirm').show();
        $('#confirmemail').focus().val('@' + rec.email.split('@')[1]).setCursorPosition(0);
      }
    }
    $('#dorefuse').bind('click',dorefuse);

    var submitresponse = function(e,upload) {
      try { if (e) e.preventDefault(); } catch(err) {}
      var warns = ['researchgate.','academia.edu','readcube.'];
      if (firstsubmit) {
        firstsubmit = false;
        for ( var w in warns ) {
          if ( $('#url').val().indexOf(warns[w]) !== -1 ) {
            $('#warn').show();
            return;
          }
        }
      }
      // once the file is successfully posted, submit to the receive endpoint and show confirmation
      // the receive endpoint will trigger forwarding to zenodo or osf
      var data = {};
      if ($('#url').val()) data.url = $('#url').val();
      if (data.url && data.url.indexOf('http') !== 0) data.url = 'http://' + data.url;
      if ($('#description').val()) data.description = $('#description').val();
      if ($('#title').val()) data.title = $('#title').val();
      if ($('#firstname').val()) data.firstname = $('#firstname').val();
      if ($('#lastname').val()) data.lastname = $('#lastname').val();
      var opts = {
        type: 'POST',
        url: api + '/receive/' + rid,
        cache: false,
        processData: false,
        success: function() {
          $('.panels').hide();
          if (!$('#url').val()) $('.noturl').show();
          $('#submitted').show();
        },
        error: function() { $('.panels').hide(); $('#error').show(); }
      }
      if (clickedadmin) {
        if ( $('#urlnotfromauthor').is(':checked') || $('#filenotfromauthor').is(':checked') ) data.notfromauthor = true;
        data.admin = true;
        opts.beforeSend = function (request) { request.setRequestHeader("x-apikey", noddy.apikey); };
      }
      if (upload) {
        for ( var d in data ) upload.append(d,data[d]);
        opts.data = upload;
        opts.contentType = false;
      } else {
        opts.data = JSON.stringify(data);
        opts.contentType = 'application/json';
        opts.dataType = 'json';
      }
      $.ajax(opts);
      clickedadmin = false;
    }
    $('#submiturl').bind('click',submitresponse);
    $('#adminsubmiturl').bind('click',function(e) { clickedadmin = true; submitresponse(); });
    $('form#fileupload').submit(function(e) {
      if (e) e.preventDefault();
      submitresponse(undefined,new FormData(this));
      return false;
    });
    $('#adminsubmitfile').bind('click',function(e) { clickedadmin = true; });

    var romeo = function(data,color) {
      if (data !== undefined && ['green','blue','yellow'].indexOf(color) === -1) {
        try {
          color = data.publishers[0].publisher[0].romeocolour[0];
        } catch(err) {}
      }
      if (color && ['green','blue','yellow'].indexOf(color) >= 0) {
        $('#sherpa_'+color).show();
      } else {
        $('#sherpa_unknown').show();
      }
    }

    details = function(data) {
      rec = data;
      if (rec.license) $('#licenselink').replaceWith(rec.license);
      var dets = '<div>';
      dets += '<h2 style="text-align:center;"><a target="_blank" href="/request/' + rec._id + '">';
      dets += rec.title ? rec.title : (rec.url.indexOf('h') !== 0 && rec.url.indexOf('1') !== 0 ? rec.url : 'Untitled article');
      dets += '</a></h2>';
      dets += '<h2 style="text-align:center;margin-bottom:25px;">Can be freely, legally, and quickly shared</h2>';
      dets += '</div>';
      $('#request').html(dets).show();
      $('.requestlink').attr('href','/request/'+rec._id);
      $('.type' + rec.type).show();
      if (rec.title) $('#title').val(rec.title);
      if (rec.author && rec.email) {
        for ( var a in rec.author ) {
          if (rec.author[a].family && rec.email.toLowerCase().indexOf(rec.author[a].family.toLowerCase()) !== -1 ) {
            $('#lastname').val(rec.author[a].family);
            if (rec.author[a].given) $('#firstname').val(rec.author[a].given);
          }
        }
      }
      if (rec.email) $('#refusepls').show();

      if (rec.status === 'received') {
        $('.showupload').show();
        rec.received && rec.received.validated === false ? $('#validating').show() : $('#validated').show();
        if (rec.received && rec.received.url) {
          //$('div.admin').append('<p>Submitted URL: <a target="_blank" href="' + rec.received.url + '">' + rec.received.url + '</a></p>');
        }
      } else if (window.location.href.indexOf('hold=') !== -1) {
        $('.showupload').show();
        var hold = parseInt(window.location.href.split('hold=')[1].split('&')[0].replace('day','').replace('s',''));
        $.ajax({type: 'GET',url: api + '/receive/' + rid + '/'+hold});
        $('#holdlength').html(hold);
        $('#hold').show();
      } else if (window.location.href.indexOf('refuse=') !== -1) {
        $('#confirmrefuse').show();
      } else {
        $('#upload').show();
      }
      if (rec.journal) {
        if (rec.sherpa) {
          romeo(undefined,rec.sherpa.color);
        } else {
          $.ajax({
            type: 'GET',
            url: api.replace('/service/oab','') + '/use/sherpa/romeo/search?jtitle=' + rec.journal,
            success: romeo
          });
        }
      } else {
        $('#sherpa_unknown').show();
      }
      if (noddy.hasRole('openaccessbutton.admin')) {
        $('.admin').show();
        $('.showupload').bind('click',function(e) { e.preventDefault(); $('.panels').hide(); $('#upload').show(); });
        $('#foradmin').show().append(admin(rec));
        $('#admin').show();
      }
    }

    var start = function() {
      console.log(rid)
      $.ajax({
        type: 'GET',
        url: api + '/receive/' + rid,
        success: details,
        error: function() { $('.panels').hide(); $('#missing').show(); }
      });
    }

    noddy.afterLogin = function() { start(); }
    noddy.nologin = function() { start() }
    noddy.login();
  });
</script>
