
<!-- Start of openaccessbutton Zendesk Widget script -->
<script>/*<![CDATA[*/window.zEmbed||function(e,t){var n,o,d,i,s,a=[],r=document.createElement("iframe");window.zEmbed=function(){a.push(arguments)},window.zE=window.zE||window.zEmbed,r.src="javascript:false",r.title="",r.role="presentation",(r.frameElement||r).style.cssText="display: none",d=document.getElementsByTagName("script"),d=d[d.length-1],d.parentNode.insertBefore(r,d),i=r.contentWindow,s=i.document;try{o=s}catch(e){n=document.domain,r.src='javascript:var d=document.open();d.domain="'+n+'";void(0);',o=s}o.open()._l=function(){var o=this.createElement("script");n&&(this.domain=n),o.id="js-iframe-async",o.src=e,this.t=+new Date,this.zendeskHost=t,this.zEQueue=a,this.body.appendChild(o)},o.write('<body onload="document._l();">'),o.close()}("https://assets.zendesk.com/embeddable_framework/main.js","openaccessbutton.zendesk.com");
/*]]>*/</script>
<!-- End of openaccessbutton Zendesk Widget script -->

<style>
  .panels {
    margin:20px 0px 20px 0px;
    min-height:300px;
  }
</style>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">

      <div id="missing" style="display:none;">
          <p>Sorry, we have no record of expecting to receive any items at this URL. If you think we should be, please <a href="mailto:requests@openaccessbutton.org">get in touch</a> and mention this URL.</p>
      </div>

      <div id="request" style="display:none;">
      </div>

      <div id="error" style="display:none;">
          <p>
            Sorry, there has been a submission error. Please <a href="mailto:requests@openaccessbutton.org">get in touch</a>
            and let us know what you were trying to upload, and the URL of this page.</p>
      </div>

      <div class="panels" id="upload" style="margin-bottom:100px;">
        <div class="row">
          <div class="col-md-12">
            <!-- hiding to simplify
            <p>
              Thank you for responding to our request. Let’s help more people get access to this research.
            </p>
          -->
            <p id="sherpa_green" style="display:none;text-align:center;">
              You can legally give us the accepted version of your article!
            </p>
            <p id="sherpa_blue" style="display:none;text-align:center;">
              You can legally give us the accepted version of your article!
            </p>
            <p id="sherpa_yellow" style="display:none;text-align:center;">
              You can legally give us the submitted version of your article!
            </p>
            <p id="sherpa_unknown" style="display:none;text-align:center;">
              If you're unsure what you can legally send us get in touch with us or your librarian for advice on what you can deposit.
            </p>

          </div>
        </div>
        <div class="row">
          <div class="col-md-6">

            <h3>Share by URL</h3>
            <p class="typearticle">
              Is the requested article publicly available online? That’s great! Just give us the URL. We suggest a link to the full text on a repository or your website, preferably a PDF or HTML version. <!--If your article isn't in a repository, please consider uploading it instead.-->
            </p>

            <p class="typedata">
              Is the requested data publicly available online? That’s great! Just give us the URL. We suggest a link to a repository record. <!--If your data isn't in a repository, please consider uploading it instead.-->
            </p>

            <input style="margin-bottom:5px;" id="url" type="text" class="form-control" placeholder="Enter the publicly available URL here">
            <p class="admin" style="display:none;color:orange;"><input type="checkbox" id="urlnotfromauthor"> Tick if URL not provided by author</p>
            <a href="#" class="btn btn-warning btn-block admin" style="display:none;margin-top:5px;" id="adminsubmiturl">submit URL as Admin</a>
            <a href="#" class="btn btn-action btn-block" style="margin-top:5px;margin-bottom:30px;" id="submiturl">Submit your URL</a>
            <p id="warn" style="display:none;">
              Papers posted on ResearchGate and Academia.edu are often illegal and aren't properly preserved. Most publishers allow
              you to publicly share the accepted version of your paper in a repository. We suggest checking
              <a target="_blank" href="http://www.sherpa.ac.uk/romeo/">SHERPA/RoMEO</a> or looking at your publishing agreement to determine what you're allowed to post and where.
              If you want it to be available to everyone, forever, we suggest uploading a copy to
              <a target="_blank" href="https://zenodo.org/">Zenodo</a>. If you give us a copy, we'll upload it to Zenodo for you! If you're sure the copy your entering is legal, you can hit submit again and we'll accept it!
            </p>
          </div>

          <div class="col-md-6">
            <h3>Upload a file</h3>
            <p class="typearticle">
              If you want to upload your article, we’ll send it to <a target="_blank" href="https://zenodo.org" target="_blank">Zenodo</a>. Zenodo will preserve and make it available under a <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC-BY</a> license.
            </p>

            <p class="typedata">
              If you want to upload your data, we’ll send it to the <a href="https://osf.io">Open Science Framework</a>.
              OSF will preserve your data and make it publicly available under a
              <a target="_blank" href="https://creativecommons.org/publicdomain/zero/1.0/">CC-0 license</a>,
              the recommended license for sharing data. Once you submit the data we’ll ask our community to validate it. If you have more than one file, please create a zip folder to upload.<br><br>
              Need some help organizing your data first? Ask your library if they have a research data management specialist who can help.
            </p>

            <form id="fileupload" enctype="multipart/form-data" method="POST" style="margin-top:32px;">
              <input type="file" name="file" id="file" class="form-control" style="margin-bottom:5px;">
              <input type="hidden" name="service" value="openaccessbutton">
              <input type="hidden" name="dirId" id="dirId" value="">
              <!--
              <input style="margin-top:5px;margin-bottom:5px;" id="title" type="text" class="form-control" placeholder="Enter the title here">
              <input style="margin-top:5px;margin-bottom:5px;" id="firstname" type="text" class="form-control" placeholder="first name">
              <input style="margin-top:5px;margin-bottom:5px;" id="lastname" type="text" class="form-control" placeholder="last name">
              <textarea id="description" class="form-control" style="min-height:150px;margin-top:5px;" placeholder="Please provide an abstract / brief description"></textarea>
              -->
              <p class="admin" style="display:none;color:orange;"><input type="checkbox" id="filenotfromauthor"> Tick if file not provided by author</p>
              <input type="submit" class="btn btn-warning btn-block admin" style="margin-top:5px;display:none;" id="adminsubmitfile" value="Upload file as Admin">
              <input type="submit" class="btn btn-action btn-block" style="margin-top:5px;" id="submitfile" value="Upload your file">
            </form>
          </div>
          <div class="row">
        <div class="col-md-12">
          <h3>Refuse this request</h3>
          <p class="typearticle">
            If you are the author and you can't share your article, or don't want to, you can <a href="?refuse=true">click here</a> and we'll let the requestor know.
          </p>
          <p class="typedata">
            If you can't share your data, or don't want to, you can simply <a href="?refuse=true">click here</a> and we'll let the requestor know.
          </p>
        </div>
              </div>
        </div>

      </div>

      <div class="panels" id="loading" style="display:none;">
        <img style="height:20px;" src="/static/spin_orange.svg"><br>
        <p>Loading, please wait a minute (or longer if your file was large)</p>
      </div>

      <div class="panels" id="submitted">
          <h3>Thank you for submitting your content!</h3>
          <p>
            The link to your content
            <span class="noturl" style="display:none;">, saved
            <span class="typearticle">on Zenodo</span>
            <span class="typedata">at the Open Science Foundation</span>,
            </span> will appear on the
            <a class="requestlink" href="/request">request</a>
            page in a few minutes.
          </p>
          <p>
            We will inform our community that you have provided this,
            and it will be validated to ensure it is what is needed.
          </p>
      </div>

      <div class="panels" id="validating">
          <h3>This content has already been received</h3>
          <p>
            It is awaiting validation from the requestor. Please view the original request (above) for further information.
          </p>
      </div>

      <div class="panels" id="validated">
          <h3>There is no further action to take.</h3>
          <p>
            This content has already been received and validated. Please view the original request (above) for further information.
          </p>
      </div>

      <div class="admin" style="display:none;color:orange;">
        <a href="#" class="btn btn-warning showupload" style="display:none;">Show upload form</a>
      </div>

      <div class="panels" id="hold">
          <h3>Thank you for your response.</h3>
          <p>
            We will put this request on hold for <span id="holdlength">X</span> days.
          </p>
      </div>

      <div class="panels" id="refuse">
          <h3>Thank you for your response</h3>
          <p>
            We are sorry that you are unable to provide the content. We will let requestors know it cannot be made available, and display that publically on the request page.
          </p>
      </div>

    </div>
  </div>
</div>






<script>
  jQuery(document).ready(function() {

    $('.typearticle').hide();
    $('.typedata').hide();
    $('.panels').hide();
    var request;
    var rid = window.location.pathname.split('/')[2];
    var clickedadmin = false;
    var firstsubmit = true;

    var submit = function(e,upload) {
      try { if (e) e.preventDefault(); } catch(err) {}
      var warns = ['researchgate.com','academia.edu','readcube.com'];
      if (firstsubmit) {
        firstsubmit = false;
        for ( var w in warns ) {
          if ( $('#url').val().indexOf(warns[w]) !== -1 ) {
            $('#warn').show();
            return;
          }
        }
      }
      // once the file is successfully posted, submit to the receive endpoint and show confirmation
      // the receive endpoint will trigger forwarding to zenodo or osf
      var data = {};
      if ($('#url').val()) data.url = $('#url').val();
      if (data.url && data.url.indexOf('http') !== 0) data.url = 'http://' + data.url;
      if ($('#description').val()) data.description = $('#description').val();
      if ($('#title').val()) data.title = $('#title').val();
      if ($('#firstname').val()) data.firstname = $('#firstname').val();
      if ($('#lastname').val()) data.lastname = $('#lastname').val();
      var opts = {
        type: 'POST',
        url: api + '/receive/' + rid,
        cache: false,
        processData: false,
        success: function() {
          $('.panels').hide();
          if (!$('#url').val()) $('.noturl').show();
          $('#submitted').show();
        },
        error: function() { $('.panels').hide(); $('#error').show(); }
      }
      if (clickedadmin) {
        if ( $('#urlnotfromauthor').is(':checked') || $('#filenotfromauthor').is(':checked') ) data.notfromauthor = true;
        data.admin = true;
        opts.beforeSend = function (request) { request.setRequestHeader("x-apikey", noddy.apikey); };
      }
      if (upload) {
        for ( var d in data ) upload.append(d,data[d]);
        opts.data = upload;
        opts.contentType = false;
      } else {
        opts.data = JSON.stringify(data);
        opts.contentType = 'application/json';
        opts.dataType = 'json';
      }
      $.ajax(opts);
      clickedadmin = false;
    }
    $('#submiturl').bind('click',submit);
    $('#adminsubmiturl').bind('click',function(e) { clickedadmin = true; submit(); });
    $('form#fileupload').submit(function(e) {
      if (e) e.preventDefault();
      submit(undefined,new FormData(this));
      return false;
    });
    $('#adminsubmitfile').bind('click',function(e) { clickedadmin = true; });

    var romeo = function(data,color) {
      if (data !== undefined && color === undefined) {
        try {
          color = data.data.publishers[0].publisher[0].romeocolour[0];
        } catch(err) {}
      }
      if (color && ['green','blue','yellow'].indexOf(color)) {
        $('#sherpa_'+color).show();
      } else {
        $('#sherpa_unknown').show();
      }
    }

    var details = function(data) {
      request = data;
      var dets = '<div>';
      dets += '<h2 style="text-align:center;margin-top:25px;margin-bottom:25px;font-size:4em;">You can freely, legally, and quickly share</h2>';
      dets += '<h2 style="text-align:center;"><a target="_blank" href="/request/' + request._id + '">';
      dets += request.title ? request.title : (request.url.indexOf('h') !== 0 && request.url.indexOf('1') !== 0 ? request.url : 'Untitled article');
      dets += '</a></h2>';
      dets += '</div>';
      $('#request').html(dets).show();
      $('.requestlink').attr('href','/request/'+request._id);
      $('.type' + request.type).show();
      if (request.title) $('#title').val(request.title);
      if (request.author) {
        for ( var a in request.author ) {
          if (request.author[a].family && request.email.toLowerCase().indexOf(request.author[a].family.toLowerCase()) !== -1 ) {
            $('#lastname').val(request.author[a].family);
            if (request.author[a].given) $('#firstname').val(request.author[a].given);
          }
        }
      }

      if (request.status === 'received') {
        $('.showupload').show();
        request.received && request.received.validated === false ? $('#validating').show() : $('#validated').show();
        if (request.received && request.received.url) {
          //$('div.admin').append('<p>Submitted URL: <a target="_blank" href="' + request.received.url + '">' + request.received.url + '</a></p>');
        }
      } else if (window.location.href.indexOf('hold=') !== -1) {
        $('.showupload').show();
        var hold = parseInt(window.location.href.split('hold=')[1].split('&')[0].replace('day','').replace('s',''));
        $.ajax({type: 'GET',url: api + '/receive/' + rid + '/'+hold});
        $('#holdlength').html(hold);
        $('#hold').show();
      } else if (window.location.href.indexOf('refuse=') !== -1) {
        $('.showupload').show();
        $.ajax({type: 'GET',url: api + '/receive/' + rid + '/refuse'});
        $('#refuse').show();
      } else {
        $('#upload').show();
      }
      if (request.journal) {
        if (request.sherpa) {
          romeo(undefined,request.sherpa.color);
        } else {
          $.ajax({
            type: 'GET',
            url: api.replace('/service/oab','') + '/use/sherpa/romeo/search?jtitle=' + request.journal,
            success: romeo
          });
        }
      }
    }
    $.ajax({
      type: 'GET',
      url: api + '/receive/' + rid,
      success: details,
      error: function() { $('.panels').hide(); $('#missing').show(); }
    });

    noddy.afterLogin = function() {
      if (noddy.hasRole('openaccessbutton.admin')) {
        $('.admin').show();
        $('.showupload').bind('click',function(e) { e.preventDefault(); $('.panels').hide(); $('#upload').show(); });
      }
    }
    noddy.login();
  });
</script>
