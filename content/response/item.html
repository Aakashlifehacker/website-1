
<style>
  .panels {
    margin:20px 0px 20px 0px;
    min-height:300px;
  }
</style>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">

      <div id="missing" style="display:none;">
        <div class="jumbotron">
          <p>Sorry, we have no record of expecting to receive any items at this URL. If you think we should be, please <a href="mailto:requests@openaccessbutton.org">get in touch</a> and mention this URL.</p>
        </div>
      </div>

      <div id="request" style="display:none;">
      </div>

      <div id="error" style="display:none;">
        <div class="jumbotron">
          <p>
            Sorry, there has been a file upload error. Please <a href="mailto:requests@openaccessbutton.org">get in touch</a>
            and let us know what you were trying to upload, and the URL of this page.</p>
        </div>
      </div>

      <div class="panels" id="upload" style="margin-bottom:100px;">
        <h3>Thank you for responding to our request</h3>
        <p>
          To complete the request we either need a URL where the content can be found or for you to upload it.
        </p>

        <p class="typearticle">
          It's best if the URL goes to a web page where the article full text
          can be publicly accessed without restriction.
          <br>
          If you don't have it online yet we can send your article to <a  href="https://zenodo.org">Zenodo</a> for safe keeping. Here it will be hosted, preserved, and identified.
        </p>

        <p class="typedata">
          It's best if the URL goes to a web page where the data
          can be publicly accessed without restriction.
          <br>
          If you don't have it online anywhere yet we will send your data to the <a href="https://osf.io">Open Science Framework</a>.
          The Open Science Framework will host, preserve, and identify your data. We’ll use the paper title and abstract to provide initial metadata and licence the data <a href="https://creativecommons.org/publicdomain/zero/1.0/">CC-0</a> <a href "http://pantonprinciples.org/"></a>(the recommended licence for sharing data)</a>. You’ll be able to change this later if you wish.
          <br>
          Once you submit the data, we'll send it to the requestor. When they've checked it's what they need you'll receive an Open Data Badge.
          <br>
          If you have more than one file, or a folder of files, please zip them first.
        </p>

        <input style="margin-top:50px;" id="url" type="text" class="form-control" placeholder="Enter the content's URL here, or:">
        <input type="file" id="file" class="form-control" style="margin-top:5px;">
        <textarea id="description" class="form-control" style="min-height:120px;margin-top:5px;" placeholder="Please provide a brief description or further information here, if necessary"></textarea>
        <a href="#" class="btn btn-action btn-block" style="margin-top:5px;" id="submit">Submit</a>
        <div class="panels" id="loading" style="display:none;">
          <img style="height:20px;" src="//static.cottagelabs.com/spin_grey.svg">
        </div>
      </div>

      <div class="panels" id="submitted">
        <div class="jumbotron">
          <h3>Thank you for submitting your content!</h3>
          <p>
            The link to your content saved 
            <span class="typearticle">on Zenodo</span> will appear on the 
            <span class="typedata">at the Open Science Foundation</span> will appear on the 
            <a class="requestlink" href="/request" style="color:white;">request</a> 
            page in a few minutes.
          </p>
          <p>
            We will inform our community that you have provided this,
            and it will be validated to ensure it is what is needed.
          </p>
        </div>
      </div>

      <div class="panels" id="validating">
        <div class="jumbotron">
          <h3>This content has already been received</h3>
          <p>
            It is awaiting validation from the requestor. Please view the original request (above) for further information.
          </p>
        </div>
      </div>

      <div class="panels" id="validated">
        <div class="jumbotron">
          <h3>There is no further action to take.</h3>
          <p>
            This content has already been received and validated. Please view the original request (above) for further information.
          </p>
        </div>
      </div>

      <div class="panels" id="hold">
        <div class="jumbotron">
          <h3>Thank you for your response.</h3>
          <p>
            We will put this request on hold for <span id="holdlength">X</span> days.
          </p>
        </div>
      </div>

      <div class="panels" id="refuse">
        <div class="jumbotron">
          <h3>Thank you for your response</h3>
          <p>
            We are sorry that you are unable to provide the content. We will let requestors know it cannot be made available, and display that publically on the request page.
          </p>
        </div>
      </div>

    </div>
  </div>
</div>






<script>
  jQuery(document).ready(function() {
    var api = 'https://lapi.cottagelabs.com/service/oab'; // to ensure this works for now, use only the LOCAL CL api address
    var uploadapi = 'https://accounts.cottagelabs.com/upload';
    if (window.location.host.indexOf('openaccessbutton.org') === -1) {
      api = 'https://dev.api.cottagelabs.com/service/oab';
    }

    $('.typearticle').hide();
    $('.typedata').hide();
    $('.panels').hide();
    var request;
    var rid = window.location.pathname.split('/')[2];

    var submitreceive = function() {
      // once the file is successfully posted, submit to the receive endpoint and show confirmation
      // the receive endpoint will trigger forwarding to zenodo or osf
      var data = {};
      if ($('#url').val()) data.url = $('#url').val();
      if ($('#description').val()) data.description = $('#description').val();
      // TODO really this should have a way to upload files built into it, and grab the #file and put it in the content var
      // but for now that is handled separately via the file upload API
      /*$.ajax({
        type: 'POST',
        url: api + '/receive/' + rid,
        cache: false,
        processData: false,
        contentType: 'application/json',
        dataType: 'json',
        data: JSON.stringify(data)
      });*/      
      $('.panels').hide(); $('#submitted').show();
    }
    var submit = function(e) {
      $('#loading').show();
      e.preventDefault();
      // if url provided rather than file upload, skip this and call submitreceive directly (backend will grab from the URL)
      if ($('#url').val()) {
        submitreceive();
      } else {
        submitreceive(); // just for now, while testing UI
        /*$.ajax({
          type: 'POST',
          url: uploadapi + '/openaccessbutton/' + rid,
          success: submitreceive,
          error: function() { $('.panels').hide(); $('#error').show(); }
        });*/      
      }
    }
    $('#submit').bind('click',submit);

    var details = function(data) {
      request = data;
      var dets = '<div class="jumbotron" style="margin-top:-10px;">';
      dets += '<h3 style="text-align:center;">Request for ' + request.type + '</h3>';
      dets += '<h2 style="text-align:center;"><a style="color:white;" target="_blank" href="/request/' + request._id + '">';
      dets += request.title ? request.title : 'Untitled article';
      dets += '</a></h2>';
      dets += '</div>';
      $('#request').html(dets).show();
      $('.requestlink').attr('href','/request/'+request._id);
      $('.type' + request.type).show();

      if (request.status === 'received') {
        request.received.validated === false ? $('#validating').show() : $('#validated').show();
      } else if (window.location.href.indexOf('hold=') !== -1) {
        var hold = parseInt(window.location.href.split('hold=')[1].split('&')[0].replace('day','').replace('s',''));
        $.ajax({type: 'GET',url: api + '/receive/' + rid + '/'+hold});
        $('#holdlength').html(hold);
        $('#hold').show();
      } else if (window.location.href.indexOf('refuse=') !== -1) {
        $.ajax({type: 'GET',url: api + '/receive/' + rid + '/refuse'});
        $('#refuse').show();
      } else {
        $('#upload').show();
      }
    }
    $.ajax({
      type: 'GET',
      url: api + '/receive/' + rid,
      success: details,
      error: function() { $('.panels').hide(); $('#missing').show(); }
    });

  });
</script>
