
<link rel="stylesheet" href="/static/oabutton_rebrand.css"> <!-- gets the new css (still also uses the old css, just overwrites where necessary) -->

<style>
  #topnav {
    display: none;
  }
  #footer {
    display: none;
  }
</style>

<div id="rebrand" class="container-fluid">

  <div id="demo" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">
        <div id="instantill"></div>
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <h2><span class="glyphicon glyphicon-arrow-left"></span> Try it now</h2>

          <p>On the left is a demo of InstantILL running real code.
          You can learn more of how it works, and what it feels like yourself.
          Type in any article that interests you, or try these:</p>

          <ul>
            <li><a class="green view" href="#illsetup"><span class="glyphicon glyphicon-arrow-right"></span> Interlibrary loans</a></li>
            <li><a class="green view" href="#subscriptionsetup"><span class="glyphicon glyphicon-arrow-right"></span> Subscriptions</a></li>
            <li><a class="green view" href="#websiteembedsetup"><span class="glyphicon glyphicon-arrow-right"></span> Website &amp; Brand</a></li>
            <li><a class="green view" href="#workflowsetup"><span class="glyphicon glyphicon-arrow-right"></span> Workflow</a></li>
          </ul>
        </div>

        <div class="greenbottom">
          <p><a class="green light" href="#">Get help</a> | <a class="green light" href="#">FAQ</a></p>
        </div>
      </div>
    </div>
  </div>

  <div id="illsetup" class="section onlyyou">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">
        <p>Hmmm... I want InstantILL to be visible here</p>
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <p><a class="green view previous" href="#"><span class="glyphicon glyphicon-arrow-left"></span>  Go back</a></p>
          <h2>Interlibrary loan: Submission</h2>
          <p>
            InstantILL uses your existing Interlibrary Loan systems to manage authentication, fulfillment, and payment, or can submit to an email address.
          </p>

          <p><b>What is your ILL article form link?</b><p>
          <input id="ill_redirect_base_url" type="text" class="form-control setting green" placeholder="URL">
          <!-- TODO: placeholder text is grey, user entry is green. This kinda makes sense but decide joe -->
          <p>
          OR
          <p>
          <p><b>What email address do you want ILLs forwarded to? (optional for email alternative)</b></p>
          <input id="email" type="text" class="form-control setting green" placeholder="default is your OAB account email address">
          <p>
            If everything works, hit next! If it doesn’t, <a href="#illsetup-advanced" class="green">see advanced settings</a>.
          </p>

        </div>

        <div class="greenbottom">
          <p><a class="btn btn-rebrand btn-block save preview" href="#">Save &amp; preview</a></p>
          <p><br><a class="green view next" href="#"><span class="glyphicon glyphicon-arrow-right"></span> Next</a></p>
          <p><a class="green light" href="#">Get help</a> | <a class="green light" href="#">FAQ</a></p>
        </div>
      </div>
    </div>
  </div>

  <div id="illsetup" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">
        <p>Hmmm... I want InstantILL to be visible here</p>
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <p><a class="green view previous" href="#"><span class="glyphicon glyphicon-arrow-left"></span>  Go back</a></p>
          <h2>Interlibrary loan: Settings</h2>
          <p>
            Now that you can submit requests, you can adjust some key details about loans. Everything is optional, and we’ve set common defaults.
          </p>

          <p><b>Name of your institution</b><p>
          <input id="ill_institution" type="text" class="form-control setting green" placeholder="Institution name">
          <br>
          <p><b>What do your article ILLs cost, please include your currency symbol? e.g $4</b><p>
          <input id="cost" type="text" class="form-control setting green" placeholder="default free">
          <br>
          <p><b>How long do your ILLs take to process on average? e.g 24 hours</b><p>
          <input id="time" type="text" class="form-control setting green" placeholder="default 24 hours">
          <br>
          <p><b>What email address do you want users referred to? (optional for if there is a problem)</b><p>
          <input id="problem_email" type="text" class="form-control setting green" placeholder="no default, the user will be told to contact their library">
          <br>
          <p><b>Terms and conditions URL (optional for email alternative)</b><p>
          <input id="terms" type="text" class="form-control setting green" placeholder="">
          <br>
          <p><b>Book request URL (optional for if the user wants a book)</b><p>
          <input id="book" type="text" class="form-control setting green" placeholder="e.g https://ill.ulib.iupui.edu/ILLiad/IUP/illiad.dll?Action=10&Form=21">
          <br>
          <p><b>Other request URL (optional for if the user wants something other than article or book)</b><p>
          <input id="other" type="text" class="form-control setting green" placeholder="e.g https://ill.ulib.iupui.edu/ILLiad/IUP/illiad.dll?Action=10&Form=10">
          <br>

        </div>

        <div class="greenbottom">
          <p><a class="btn btn-rebrand btn-block save preview" href="#">Save &amp; preview</a></p>
          <p><br><a class="green view next" href="#"><span class="glyphicon glyphicon-arrow-right"></span> Next</a></p>
          <p><a class="green light" href="#">Get help</a> | <a class="green light" href="#">FAQ</a></p>
        </div>
      </div>
    </div>
  </div>

  <div id="illsetup-advanced" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">
        <p>Hmmm... I want InstantILL to be visible here</p>
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <p><a class="green view previous" href="#"><span class="glyphicon glyphicon-arrow-left"></span>  Go back</a></p>
          <h2>Interlibrary loan: Advanced</h2>
          <p>
            InstantILL uses your existing Interlibrary Loan systems to manage authentication, fulfillment, and payment, or can submit to an email address.
          </p>

          Add any additional params your base URL needs, such as a=b&c=d<br>
          <input id="ill_redirect_params" type="text" class="form-control setting" placeholder="Add any additional params your base URL needs"><br>
          <!--<input id="method" type="text" class="form-control setting" placeholder="default GET"><br>-->
          Add the param used to provide a service ID (which will be InstantILL)<br>
          <input id="sid" type="text" class="form-control setting green" placeholder="default sid">

          <br>
          Title<br>
          <input id="title" type="text" class="form-control setting green" placeholder="default atitle">
          <br>
          Journal title<br>
          <input id="journal" type="text" class="form-control setting green" placeholder="default title">
          <br>
          DOI<br>
          <input id="doi" type="text" class="form-control setting green" placeholder="default rft_id">
          <br>
          Author<br>
          <input id="author" type="text" class="form-control setting green" placeholder="default au">
          <br>
          ISSN<br>
          <input id="issn" type="text" class="form-control setting green" placeholder="default issn">
          <br>
          Volume<br>
          <input id="volume" type="text" class="form-control setting green" placeholder="default volume">
          <br>
          Issue<br>
          <input id="issue" type="text" class="form-control setting green" placeholder="default issue">
          <br>
          Page<br>
          <input id="page" type="text" class="form-control setting green" placeholder="default pages">
          <br>
          Published<br>
          <input id="published" type="text" class="form-control setting green" placeholder="default date">
          <br>
          PMID<br>
          <input id="pmid" type="text" class="form-control setting green" placeholder="default pmid">
          <br>
          <!--<input id="pmcid" type="text" class="form-control setting" placeholder="default pmcid"><br>-->
          Year
          <input id="year" type="text" class="form-control setting green" placeholder="default rft.year">
          <br>



          </p>
        </div>

        <div class="greenbottom">
          <p><a class="btn btn-rebrand btn-block save preview" href="#">Save &amp; preview</a></p>
          <p><br><a class="green view next" href="#"><span class="glyphicon glyphicon-arrow-right"></span> Next</a></p>
          <p><a class="green light" href="#">Get help</a> | <a class="green light" href="#">FAQ</a></p>
        </div>
      </div>
    </div>
  </div>

  <div id="subscriptionsetup" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">
        <p>Hmmm, I wish InstantILL was here.</p>
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <p><a class="green view previous" href="#"><span class="glyphicon glyphicon-arrow-left"></span>Go back</a></p>
          <h2>Subscriptions</h2>
          <p>
            We use your link resolver to understand what you do and don’t have access to. Then, we figure out the best link and send your patrons to it through your proxy.
            <p><b>What is you link resolver URL?</b></p>
            <input id="subscription" type="text" class="form-control setting green" placeholder="e.g http://rx8kl6yf4x.search.serialssolutions.com">
          </p>
        </div>
        <div class="greenbottom">
          <p><a class="btn btn-rebrand btn-block save preview" href="#">Save &amp; preview</a></p>
          <p><br><a class="green view next" href="#"><span class="glyphicon glyphicon-arrow-right"></span> Next</a></p>
          <p><a class="green light" href="#">Get help</a> | <a class="green light" href="#">FAQ</a></p>
        </div>
      </div>
    </div>
  </div>

  <div id="websiteembedsetup" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">
        <p>I am website embed / brand section</p>
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <p><a class="green view previous" href="#"><span class="glyphicon glyphicon-arrow-left"></span>  Go back</a></p>
          <h2>Website &amp; Brand</h2>

          <p>
            InstantILL can be integrated onto any webpage on your website, and blend in with your brand.
          </p>
          <p>
            To do that you can follow these simple instructions or we’ve drafted an email you can <a href="mailto:" class="light">send your developer</a>.
          </p>

          <p>
            First, include the following in the source code (HTML) of your page:
          </p>
          <!-- TODO: I can't get 'onlyyou' to work on the below without blowing shit up -->
          <pre class="stickidin">
&lt;script src="{{site_url}}/static/instantill.js"&gt;&lt;/script&gt;&lt;script&gt;jQuery(document).ready(function(){instantill();});&lt;/script&gt;
&lt;div id="instantill"&gt;&lt;/div&gt;</pre>


        <p>
          If you still can't see the search box on your page you may need to manually include jquery by adding the following line <b>above</b> the one you already added:
        </p>
        <!-- TODO: Ask why we don't include by default -->
        <pre>
&lt;script src="https://openaccessbutton.org/static/jquery-1.10.2.min.js"&gt;&lt;/script&gt;</pre>


        <p>You can control where the search widget gets displayed by moving:</p>
          <pre>
&lt;div id="instantill"&gt;&lt;/div&gt;</pre>

        <p>
          If you don’t think it’s styled corrected, a developer can help you. If you have one, great, if not <a href="mailto:joe@openaccessbutton.org" class="light">reach out</a>.
        </p>

        <p>You should now be good to go!</p>

        <h3>Some advice</h3>

        <p>We suggest:</p>
        <ul>
          <li>Calling your page ‘Get a paper’</li>
          <li>No need to mention 'InstantILL' to patrons</li>
        </ul>

        </div>
        <div class="greenbottom">
          <p><br><a class="green view next" href="#"><span class="glyphicon glyphicon-arrow-right"></span> Next</a></p>
          <p><a class="green light" href="#">Get help</a> | <a class="green light" href="#">FAQ</a></p>
        </div>
      </div>
    </div>
  </div>

  <div id="workflowsetup" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">
        <p>I am wokflow integration section</p>
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <p><a class="green view previous" href="#"><span class="glyphicon glyphicon-arrow-left"></span>  Go back</a></p>
          <h2>Workflow</h2>
          <p>
            You can link to InstantILL from any library system to integrate it into your existing workflows, say from library search or a link resolver.
          </p>
          <p>
            It will run automatically on the embedded page if it sees any of the following parameters in the URL: 'doi','title','url','atitle','rft_id','journal','issn','year','author'. You can change these, or turn this off entriely below.
          </p>
          <p id="embeddedexample" style="display:none;"></p>
          <!-- TODO: ask mark what does the above do? -->
          <p><b>
            If you're only linking to InstantILL in the middle of a workflow, you may not want the instructions to show.
          </b></p>
          <p>
            <input id="intropara" type="checkbox" class="setting">
            Do not show InstantILL's introductory statement.
          </p>
          <p>
            <input id="autorun" type="checkbox" class="setting">
            Do not automatically run
          </p>
          <p><b>Adjust what triggers InstantILL</b></p>
          <p>
            <input id="autorunparams" type="text" class="form-control setting green" placeholder="defaults as above"><br>
          </p>
          <p>
            The defaults listed above will be used if this box is left empty.
            Enter any that you want to use, separated by a comma. If you want to use a custom parameter to pass to one of our defaults listed above, provide your parameter name followed by an "=" and the default name you want it to match. For example if you wanted to use our default "doi" and "title" but with your own custom journal parameter, you could specify this as doi,title,mycustomparam=journal.
            <!-- TODO: why don't we use a list similar to how we do ILLs here? -->
          </p>

        </div>
        <div class="greenbottom">
          <p><a class="green light" href="#">Get help</a> | <a class="green light" href="#">FAQ</a></p>
        </div>
      </div>
    </div>
  </div>

</div>



<!-- functions you can trigger:

Put a div with ID "instantill" in the place where you want the instantill demo to show up. Note this can only appear in one place at a time.

The page tries to execute a login on page load.
If it succeeds it will try to replace the content of any element on the page with the "yourid" class with the user ID.
It will also try to replace "but only you" in the content of any element with the "onlyyou" class with "but only you (USERNAME)".
It will then go through any ILL config present for the logged in user, and for every value, it will look for an element on the page with the matching ID,
and it will place the value of that config item as the value of the element (note as described below for saving, such elements should also have the "setting" class).
(if it is a boolean value the element should be a checkbox, and it will be checked or not depending on boolean value).

Any button with the "view" class will cause the UI view to change between divs with the "section" class.
The "view" class button goes to the next "section" div by default. If you also give the button the "previous" class it goes to the previous one.
If the "view" button has an href that is longer than 1 then the href value is assumed to be the ID of the div to show, or a classname for a set of things to show.
Any execution of a "view" button first hides all "section" divs then shows the previous or next or defined things.

Any button ("button" or "a" link tag) that has the "save" class will trigger a save
A save will look for any element with the "setting" class and will take the value of that element and try to use it as the config value corresponding to the ID of that element.
If the save button also has an attr called "preview" then it can be set to true to trigger an instantill preview run with a default value
If preview attr is set but is some value other than true, then the value of the preview attr will be used in the instantill box

Any button with the "preview" class will trigger the instantill box with a trial value. The value should be specified on the button
in an attr called "val" or else the html content of the button will be used as the value.
-->

<script src="/static/instantill.js"></script>
<script>
jQuery(document).ready(function() {
  $('#topnav').remove();
  $('#footer').remove();
  if ($('#rebrand').height() < $(window).height()) $('#rebrand').css({height:$(window).height()+'px'});

  var view = function(e,which) {
    if (e) e.preventDefault();
    if (which) {
      $('.section').hide();
      if (which.indexOf('.') !== 0 && which.indexOf('#') !== 0) which = '#' + which;
      $(which).show();
    } else if ($(this).attr('href') === undefined) {
      $('.section').hide();
      if (window.location.hash) {
        $(window.location.hash).show();
      } else {
        $('.section').first().show();
      }
    } else if ($(this).attr('href').length > 1) {
      $('.section').hide();
      which = $(this).attr('href');
      if (which.indexOf('.') !== 0 && which.indexOf('#') !== 0) which = '#' + which;
      $(which).show();
    } else {
      var movefrom = '#' + $('.section:visible').first().attr('id');
      $('.section').hide();
      $(this).hasClass('previous') ? $(movefrom).prev().show() : $(movefrom).next().show();
      which = '#' + $('.section:visible').first().attr('id');
    }
    try {
      var ch = $('.content:visible').height();
      if (ch < $(window).height()/5) ch = $(window).height()/5;
      var diff = $(window).height() - $('div.content:visible').offset().top - ch;
      if (diff > 0 && parseInt($('div.content:visible').css('padding-top').replace('px','')) < 10 ) {
        diff = Math.floor(diff/2 - $('div.content:visible').height() - 50) + 'px';
        $('div.content:visible').css({'padding-top':diff});
        //$('div.green:visible').css({'padding-top':diff});
      }
    } catch(err) {}
		if (which && 'pushState' in window.history) window.history.pushState("", which, which);
  }
  $('body').on('click','.view',view);
  $(window).on('popstate', view);
  view();

  var preview = function(e,val) {
    try { e.preventDefault(); } catch (err) {}
    if (typeof val !== 'string') {
      try {
        val = $(this).attr('val');
      } catch(err) {
        val = '10.1145/2908080.2908114';
      }
    }
    if (typeof val !== 'string' || val.length < 10) val = '10.1145/2908080.2908114';
    if (!$('#instantill').is(':visible')) {
      view(undefined,'#demo');
    }
    _instantill_restart();
    $('#oabutton_input').val(val);
    setTimeout(function() { $('#oabutton_find').trigger('click'); },500);
  }

  $('.preview').bind('click',function(e) {
    e.preventDefault();
    $('#oabutton_input').val($(this).attr('val') ? $(this).attr('val') : $(this).html());
    setTimeout(function() { $('#oabutton_find').trigger('click'); },500);
  });

  var _preview = false;
  var save = function(e,pvw) {
    try { e.preventDefault(); } catch (err) {}
    if (e === true || pvw || $(this).attr('preview') || $(this).hasClass('preview')) _preview = $(this).attr('preview') ? $(this).attr('preview') : (pvw ? pvw : true);
    var data = {};
    $('.setting').each(function(i, obj) {
      if ( $(this).is(':checkbox') ) {
        data[$(this).attr('id')] = $(this).is(':checked');
      } else if ( $(this).val() !== undefined ) {
        data[$(this).attr('id')] = $(this).val();
        if (['ill_redirect_base_url','terms','book','other'].indexOf($(this).attr('id')) !== -1 && data[$(this).attr('id')] !== '' && data[$(this).attr('id')].indexOf('http') !== 0) {
          data[$(this).attr('id')] = 'http://' + data[$(this).attr('id')];
          $(this).val(data[$(this).attr('id')]);
        }
      }
    });

    var opts = {
      url: api + '/ill/config',
      type:'POST',
      cache:false,
      processData:false,
      contentType: 'application/json',
      dataType: 'json',
      success: function(data) {
        if (_preview) {
          $('.save').hide().after('<p class="saved">Changes saved! Your preview will run shortly.</p>');
          setTimeout(function() { $('.saved').hide(); $('.save').show(); preview(undefined,_preview); }, 3000);
          _preview = false;
        } else {
          $('.save').hide().after('<p class="saved">Changes saved!</p>');
          setTimeout(function() { $('.saved').hide(); $('.save').show(); }, 4000);
        }
      },
      error: function(data) {
        $('#save').hide().after('<p class="saved">Sorry, changes could not be saved.</p>');
        setTimeout(function() { $('.saved').hide(); $('#save').show(); }, 4000);
        _preview = false;
      },
      beforeSend: function (request) { request.setRequestHeader("x-apikey", noddy.apikey); }
    }
    opts.data = JSON.stringify(data);
    if (noddy.apikey) {
      $.ajax(opts);
    } else {
      if (_preview) {
        $('.save').hide().after('<p class="saved">You need to login to save changes! Your preview will run shortly.</p>');
        setTimeout(function() { $('.saved').hide(); $('.save').show(); preview(undefined,_preview); }, 3000);
        _preview = false;
      } else {
        $('.save').hide().after('<p class="saved">You need to login to save changes!</p>');
        setTimeout(function() { $('.saved').hide(); $('.save').show(); }, 4000);
      }
    }
  }
  $('body').on('click','.save',save);

  noddy.afterLogin = function() {
    $('.promptsignup').hide();
    var uid = noddy.user.account._id;
    if ($('.yourid').length) $('.yourid').html($('.yourid').html().replace('instantill()','instantill({uid:"' + uid + '",api:"' + api + '"})'));
    if ($('.onlyyou').length) $('.onlyyou').html($('.onlyyou').html().replace('but only you ','but only you (' + noddy.user.account.profile.firstname + ') '));
    instantill({uid:uid, api:api});
    try {
      $('.email').attr('placeholder','default ' + (noddy.user.account.email ? noddy.user.account.email : noddy.user.account.emails[0].address));
    } catch(err) {}
    try {
      for (var k in noddy.user.account.service.openaccessbutton.ill.config) {
        if (typeof noddy.user.account.service.openaccessbutton.ill.config[k] === 'boolean') {
          if (noddy.user.account.service.openaccessbutton.ill.config[k] === true) $('#'+k).prop('checked',true);
        } else {
          $('#'+k).val(noddy.user.account.service.openaccessbutton.ill.config[k]);
        }
      }
    } catch(err) {}
    try {
      var q = {"size": 0, "query": {"filtered": {"query": {"bool": {"must": [{"term": {"plugin": "instantill"}},{"term": {"from": noddy.user.account._id}}]}}}}};
      q.aggregations = {"embeds": {"terms": {"field": "embedded.exact"}}};
      $.ajax({
        url: api + '/availabilities',
        type: 'POST',
        data: q,
        success: function(iia) {
          try {
            var eurl = iia.aggregations.embeds.buckets[0].key.split('?')[0].split('#')[0];
            var ex = 'For example using the following URL parameter on one of your current embed URLs would automatically trigger an instantill search:<br>';
            ex += eurl + '?doi=10.1145/2908080.2908114';
            $('#embeddedexample').html(ex).show();
          } catch(err) {}
        }
      });
    } catch(err) {}
    /*if (noddy.hasRole('root')) {
      $('#ill_config').prepend('<input style="border-color:red;" id="uid" type="text" class="form-control setting" placeholder="UID (ADMIN setting override)"><br>')
    }*/
  }
  noddy.nologin = function() {
    instantill({uid:'oab_site', api:api});
  }
  noddy.login();
});
</script>
