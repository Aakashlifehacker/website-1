<!-- TODO: Mark, can we get instantill.org/demo pointed here? -->
<!-- TODO: I think a general rule is that instantill should be visible on page load??? -->

<link rel="stylesheet" href="/static/oabutton_rebrand.css"> <!-- gets the new css (still also uses the old css, just overwrites where necessary) -->

<style>
  #topnav {
    display: none;
  }
  #footer {
    display: none;
  }

  .form-control {
    background-color:#edf8ed;
    color:#46b633;
    border:2px solid #46b633;
  }

  a {
    color:#46b633;
    font-weight:normal;
  }
  a:hover {
    color:#46b633;
  }

  .btn-hollow {
    border-color: #46b633;
    border-width: 2px;
    border-radius: 0px;
    color: #46b633;
    font-weight: bold;
    padding-top: 10px;
    padding-bottom: 10px;
  }
  .btn-hollow:hover {
    border-color: #46b633;
    border-width: 2px;
    border-radius: 0px;
    color: #46b633;
    font-weight: bold;
    padding-top: 10px;
    padding-bottom: 10px;
  }


</style>

<!--

<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
    <h1>
      I am the top of the page for fun marketting stuff!
    </h1>
    </div>
  </div>
</div>

-->

<div id="rebrand" class="container-fluid">

  <div id="demo" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">
        <div id="instantill"></div>
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <h2><span class="glyphicon glyphicon-arrow-left"></span> Try it now</h2>

          <p>
            This is a demo of InstantILL, it works just like it would on your website, placed wherever you normally have your ILL form.
          </p>
          <p>
          Let us show you InstantILL's main features!
          </p>

          <p><b>1. Try InstantILL with an Open Access article:</b></p>
          <p><a class="btn btn-hollow btn-block view preview" href="#part2" val="Exposing errors related to weak memory in GPU applications">Show me!</a></p>
          <!-- TODO: would be good to replace 'part2' and other 'parts' with nicer names -->
        </div>

        <div class="greenbottom">
          <p><a class="btn btn-rebrand btn-block" href="/instantill_alpha_rebrand">Install Now!</a></p>
          <!-- TODO: Remove this, as we don't have it yet! -->
          <p>Or, get a <a href="#tour" class="green">guided tour</a> and <a href="#examples" class="green">ask how others use it</a>.</p>

        </div>
      </div>
    </div>
  </div>

  <div id="part2" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">
        <!-- demo will be moved to here to show response-->
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <h2>Hurrah, thanks for trying InstantILL!</h2>
          <p>
            You just put an title into InstantILL, and we found a version that's Open Access, so you can go straight to the full text.
          </p>
          <p>
            We built this into the heart of InstantILL because patrons want to access content instantly, and often more than 20% of ILLs can be found Open Access, saving you money and time. We’ve been pioneers in delivery Open Access, and our content comes only from legal aggregators, such as Unpaywall, DOAJ, and many more.
          </p>
          <p><b>
            2. Why don't you try to make an ILL request? Hit 'Complete Request' to continue the demo.
          </b></p>
        </div>
        <div class="greenbottom">
          <p><a class="btn btn-rebrand btn-block" href="/instantill_alpha_rebrand">Install Now!</a></p>
          <p>Or, get a <a href="#tour" class="green">guided tour</a> and <a href="#examples" class="green">ask how others use it</a>.</p>

        </div>
      </div>
    </div>
  </div>

  <div id="fakeill" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">
        <p>UNIVERSITY OF YOU INTERLIBRARY LOAN FORM</p>
        <table class="table table-bordered" id="fakeilltable">
          <!-- TODO: how do we remove some things from this table? like cache -->
        </table>
        <!-- <p><a class="btn btn-rebrand" href="#part4">Continue demo!</a></p>-->
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <h2>Request made!</h2>
          <p>
            Since this a demo, we can't really make an ILL for you, so we're showing you all the article meta-data we'd pass to you instead. You can set-up InstantILL to point to your existing ILL form, where you can handle authentication and submission into your existing systems, or of course, submit it over email.
          </p>
          <p>
            We just made sure that patrons don't need to complete a long form, and when it arrives, you have everything you need to send the request for fulfilment.
          </p>
          <p>

          </p>
          <p><b>3. Next, try InstantILL with an article you’ve subscribed too:</b></p>
          <p><a class="btn btn-hollow btn-block view preview" href="#part4" val="10.1145/2908080.2908114">Show me!</a></p>

        </div>
        <div class="greenbottom">
          <p><a class="btn btn-rebrand btn-block" href="/instantill_alpha_rebrand">Install Now!</a></p>
          <p>Or, get a <a href="#tour" class="green">guided tour</a> and <a href="#examples" class="green">ask how others use it</a>.</p>
                  </div>
      </div>
    </div>
  </div>

  <div id="part4" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">
        <!-- demo will be moved to here to show response-->
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <h2>We got that too!</h2>
          <p>
            InstantILL knows the electronic resources you subscribe to, and can make sure patrons see them before making a request. If you have access, InstantILL will provide a direct link for the user to access through your proxy. Off campus, they’ll be nudged to login to access the content.</p>
          <p>
            Since this a demo, we're just linking you to an Open Access version of an article, but you get the idea!
          </p>
          <p>
            InstantILL can also be integrated inside your library search, and link resolver worflows in a couple of different ways.
          </p>
          <p><b>4. Let's test linking to a page with InstantILL on it:</b></p>
          <p><a class="btn btn-hollow btn-block view preview" href="#part5" val="Corrective gene transfer in the human skin disorder lamellar ichthyosis">https://dev.openaccessbutton.org/instantill_demo_rebrand#part5?doi=10.1126/science.196.4287.293</a></p>
          <!-- TODO: can the above work? openurl to anchor with instantill showing. OR, this could be a gif. -->
          <!-- TODO: add pings for tracking -->
          <!-- TODO: I need to make sure this is the stays in the button -->
        </div>
        <div class="greenbottom">
          <p><a class="btn btn-rebrand btn-block" href="/instantill_alpha_rebrand">Install Now!</a></p>
          <p>Or, get a <a href="#tour" class="green">guided tour</a> and <a href="#examples" class="green">ask how others use it</a>.</p>

        </div>
      </div>
    </div>
  </div>

  <div id="part5" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">
        <!-- demo will be moved to here to show response-->
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <h2>Nearly finished!</h2>
          <p>
            InstantILL can work like a link resolver, so you can link to it and it can be embedded into link resolvers and let patrons know what they can get. This makes it a great replacement in 'request a copy' buttons, or for embedding into link resolvers.
          </p>
          <p>
            Also, the article we tested there isn't available there, so all you can do is submit an Interlibrary Loan.
          </p>
          <p><b>5. Finally, see what it takes to set InstantILL up!:</b></p>
          <p><a class="btn btn-hollow btn-block view preview" href="#part6" val="10.1145/2908080.2908114">Show me!</a></p>
          <!-- TODO: add pings to me -->
        </div>
        <div class="greenbottom">
          <p><a class="btn btn-rebrand btn-block" href="/instantill_alpha_rebrand">Install Now!</a></p>
          <p>Or, get a <a href="#tour" class="green">guided tour</a> and <a href="#examples" class="green">ask how others use it</a>.</p>

        </div>
      </div>
    </div>
  </div>

  <div id="part6" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">
        <!-- demo will be moved to here to show response-->
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <h2>It's pretty easy...</h2>
          <p>
            All it takes is three steps. Pretty rad, right?
          </p>
          <ul>
            <li>Tell us your ILL form link (if you have one)</li>
            <li>Tell us your link resolver URL</li>
            <li>Copy and paste a line of code onto your website</li>
          </ul>
          <p>
            No coding, or special systems knowledge required. Of course, you can tweak a dozen settings too, so everything works just right.
          </p>
          <p>
            So, you can get started today with your systems:
          </p>
          <p><a class="btn btn-rebrand btn-block" href="/instantill_alpha_rebrand">Install Now!</a></p>
          <p>Or, if you're not sure yet you can... </p>
        </div>
        <div class="greenbottom">
          <!--
          <p><a class="btn btn-rebrand btn-block" href="/instantill_alpha_rebrand">Install Now!</a></p>
          <p>Or, get a <a href="#tour" class="green">guided tour</a> and <a href="#examples" class="green">ask how others use it</a>.</p>
        -->
        </div>
      </div>
    </div>
  </div>



  <!-- GUIDED TOUR -->

  <div id="tour" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">

        <!-- TODO: JOE, what goes here? -->

          <!--
        <iframe width="560" height="315" src="https://www.youtube.com/embed/1xyvk68iWqU" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
          -->
      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <p><a class="green view previous" href="#demo"><span class="glyphicon glyphicon-arrow-left"></span>  Go back</a></p>
          <h2>Schedule a demo`</h2>

          <p>
            Want to speak with someone before you move ahead? No problem!
          </p>
          <p>
            <a class="btn btn-hollow btn-block" href="https://doodle.com/joemcarthur">Let's find a time</a>
          </p>

        </div>
        <div class="greenbottom">

        </div>
      </div>
    </div>
  </div>

  <!-- EXAMPLES OF PEOPLE USING IT -->

  <div id="examples" class="section">
    <div class="row">
      <div class="col-md-6 col-md-offset-1 content">

        <!-- TODO: JOE, what goes here? -->

      </div>

      <div class="col-md-4 col-md-offset-1 green">
        <div class="greenery">
          <p><a class="green view" href="#demo"><span class="glyphicon glyphicon-arrow-left"></span>  Go back</a></p>
          <h2>Ask how others use InstantILL</h2>

          <p>
            The following colleagues have kindly agreed to share their experience on request. They’re happy to let you know how InstantILL works for them.
          </p>

          <p>
            Please be respectful of their generosity by ensuring you've read the website, checked the FAQ, and direct any technical questions to us before emailing.
          </p>

          <p>
            <ul>
              <li>
                Tina Baich & Mike Paxton, IUPUI. <a href="https://ulib.iupui.edu/services/ILL" target="_blank">See their set up</a>.
              </li>
            </ul>
          </p>

        </div>
        <div class="greenbottom">

        </div>
      </div>
    </div>
  </div>

</div>



<!--
<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
    <h1>
      I am the bottom of the page for fun marketting stuff!
    </h1>
    </div>
  </div>
</div>
-->


<!-- functions you can trigger:

Put a div with ID "instantill" in the place where you want the instantill demo to show up. Note this can only appear in one place at a time.

The page tries to execute a login on page load.
If it succeeds it will try to replace the content of any element on the page with the "yourid" class with the user ID.
It will also try to replace "but only you" in the content of any element with the "onlyyou" class with "but only you (USERNAME)".
And it will look for any section with the class "yourid" and will replace any text that contains instantill() with the instantill({SETTINGS})
suitable for the logged in user (their user ID).

It will then go through any ILL config present for the logged in user, and for every value, it will look for an element on the page with the matching ID,
and it will place the value of that config item as the value of the element (note as described below for saving, such elements should also have the "setting" class).
(if it is a boolean value the element should be a checkbox, and it will be checked or not depending on boolean value).

Any button with the "view" class will cause the UI view to change between divs with the "section" class.
The "view" class button goes to the next "section" div by default. If you also give the button the "previous" class it goes to the previous one.
If the "view" button has an href that is longer than 1 then the href value is assumed to be the ID of the div to show, or a classname for a set of things to show.
Any execution of a "view" button first hides all "section" divs then shows the previous or next or defined things.

If you want the section that you switch to with the "view" button to show the #instantill demo in it, you
can add the "pull" class to the button. Then, once the view has switched to the specified section, the #instantill
demo div will be appended to the content section of the currently visible section.

Any button ("button" or "a" link tag) that has the "save" class will trigger a save
A save will look for any element with the "setting" class and will take the value of that element and try to use it as the config value corresponding to the ID of that element.
If the save button also has an attr called "preview" then it can be set to true to trigger an instantill preview run with a default value
If preview attr is set but is some value other than true, then the value of the preview attr will be used in the instantill box

Any button with the "preview" class will trigger the instantill box with a trial value. The value should be specified on the button
in an attr called "val" or else the html content of the button will be used as the value.

NOTE: if you want the view to change when a preview is triggered, put the view class BEFORE the preview class.
That way the view will change, the preview will run, and if the preview is not visible it will be pulled forward
into the view you have changed to.
-->

<script src="/static/instantill.js"></script>
<script>
jQuery(document).ready(function() {
  $('#topnav').remove();
  $('#footer').remove();
  if ($('#rebrand').height() < $(window).height()) $('#rebrand').css({'min-height':$(window).height()+'px'});
  $('div.green').css({'min-height':$(window).height()+'px'});

  var _ill_response = undefined;
  var fakeill = function(e) {
    if (e) e.preventDefault();
    $('#fakeilltable').html('');
    try {
      for ( var i in _ill_response.meta.article) {
        if (['started','ended','took'].indexOf(i) === -1) {
          if (i === 'author') {
            var append = '<tr><td>Author(s)</td><td><input class="form-control" type="text" value="';
            for (var a in _ill_response.meta.article.author) {
              try {
                if (a !== '0') append += ', ';
                append += _ill_response.meta.article.author[a].given + ' ' + _ill_response.meta.article.author[a].family
              } catch(err) {}
            }
            $('#fakeilltable').append(append + '"></td></tr>');
          } else {
            try {
              $('#fakeilltable').append('<tr><td>' + i.substring(0,1).toUpperCase() + (['doi','issn'].indexOf(i.toLowerCase()) !== -1 ? i.substring(1).toUpperCase() : i.substring(1)) + '</td><td><input class="form-control" type="text" value="' + _ill_response.meta.article[i] + '"></td></tr>');
            } catch(err) {}
          }
        }
      }
    } catch(err) {}
    if (($('#fakeill').height() + $('#fakeill').offset().top) > $(window).height()) {
      var diff = Math.floor(($(window).height() - $('#fakeill').height())/2)-20;
      if (diff < 20) diff = 20;
      $('#fakeill').children('div.content').css({'padding-top':diff+'px'});
    }
    view(undefined,'#fakeill');
  }

  $(document).ajaxComplete(function(e,xhr) {
    if (xhr && xhr.responseJSON && xhr.responseJSON.data && xhr.responseJSON.data.match !== undefined) {
      _ill_response = xhr.responseJSON.data;
      // an availability check finished, reposition the instantill window if necessary
      if (($('#instantill').height() + $('#instantill').offset().top) > ($(window).height()*.95)) {
        var diff = Math.floor(($(window).height() - $('#instantill').height())/2)-20;
        if (diff < 20) diff = 20;
        $('div.content:visible').css({'padding-top':diff+'px'});
      }
      $('.oabutton_ill').off();
      $('body').on('click','.oabutton_ill',fakeill);
    }
  });

  var view = function(e,which) {
    if (e) e.preventDefault();
    if (which) {
      $('.section').hide();
      if (which.indexOf('.') !== 0 && which.indexOf('#') !== 0) which = '#' + which;
      $(which).show();
    } else if ($(this).attr('href') === undefined) {
      $('.section').hide();
      if (window.location.hash) {
        $(window.location.hash).show();
      } else {
        $('.section').first().show();
      }
    } else if ($(this).attr('href').length > 1) {
      $('.section').hide();
      which = $(this).attr('href');
      if (which.indexOf('.') !== 0 && which.indexOf('#') !== 0) which = '#' + which;
      $(which).show();
    } else {
      var movefrom = '#' + $('.section:visible').first().attr('id');
      $('.section').hide();
      $(this).hasClass('previous') ? $(movefrom).prev().show() : $(movefrom).next().show();
      which = '#' + $('.section:visible').first().attr('id');
    }
    if ($(this).hasClass('pull') && $('#instantill','.section:visible').length !== 1) $('#instantill').appendTo($('.content','.section:visible'));
    try {
      var ch = $('div.content:visible').height();
      if (ch < $(window).height()/5) ch = $(window).height()/5;
      var diff = $(window).height() - $('div.content:visible').offset().top - ch;
      if (diff > 0 && parseInt($('div.content:visible').css('padding-top').replace('px','')) < 10 ) {
        diff = Math.floor(diff/2 - $('div.content:visible').height() - 50) + 'px';
        $('div.content:visible').css({'padding-top':diff});
      }
    } catch(err) {}
    $('div.green:visible').css({'min-height':$(document).height()+'px'});
		if (which && 'pushState' in window.history) window.history.pushState("", which, which);
  }
  $('body').on('click','.view',view);
  $(window).on('popstate', view);
  view();

  var preview = function(e,val) {
    try { e.preventDefault(); } catch (err) {}
    if ($(this).hasClass('save') && val === undefined) {
      // do nothing, the save will call this again once ready to run the preview with new values
    } else {
      if (typeof val !== 'string') {
        try {
          val = $(this).attr('val');
        } catch(err) {
          val = '10.1145/2908080.2908114';
        }
      }
      if (typeof val !== 'string' || val.length < 10) val = '10.1145/2908080.2908114';
      if ($(this).hasClass('view')) {
        if ($('#instantill','.section:visible').length !== 1) {
          $('#instantill').appendTo($('.content','.section:visible'));
        }
      } else if (!$('#instantill').is(':visible')) {
        view(undefined,'#demo');
      }
      _instantill_restart();
      $('#oabutton_input').val(val);
      setTimeout(function() { $('#oabutton_find').trigger('click'); },300);
    }
  }
  $('body').on('click','.preview',preview);

  var _preview = false;
  var save = function(e,pvw) {
    try { e.preventDefault(); } catch (err) {}
    if (e === true || pvw || $(this).attr('preview') || $(this).hasClass('preview')) _preview = $(this).attr('preview') ? $(this).attr('preview') : (pvw ? pvw : true);
    var data = {};
    $('.setting').each(function(i, obj) {
      if ( $(this).is(':checkbox') ) {
        data[$(this).attr('id')] = $(this).is(':checked');
      } else if ( $(this).val() !== undefined ) {
        data[$(this).attr('id')] = $(this).val();
        if (['ill_redirect_base_url','terms','book','other'].indexOf($(this).attr('id')) !== -1 && data[$(this).attr('id')] !== '' && data[$(this).attr('id')].indexOf('http') !== 0) {
          data[$(this).attr('id')] = 'http://' + data[$(this).attr('id')];
          $(this).val(data[$(this).attr('id')]);
        }
      }
    });

    var opts = {
      url: api + '/ill/config',
      type:'POST',
      cache:false,
      processData:false,
      contentType: 'application/json',
      dataType: 'json',
      success: function(data) {
        if (_preview) {
          $('.save').hide().after('<p class="saved">Changes saved! Your preview will run shortly.</p>');
          setTimeout(function() { $('.saved').hide(); $('.save').show(); preview(undefined,_preview); }, 3000);
          _preview = false;
        } else {
          $('.save').hide().after('<p class="saved">Changes saved!</p>');
          setTimeout(function() { $('.saved').hide(); $('.save').show(); }, 4000);
        }
      },
      error: function(data) {
        $('#save').hide().after('<p class="saved">Sorry, changes could not be saved.</p>');
        setTimeout(function() { $('.saved').hide(); $('#save').show(); }, 4000);
        _preview = false;
      },
      beforeSend: function (request) { request.setRequestHeader("x-apikey", noddy.apikey); }
    }
    opts.data = JSON.stringify(data);
    if (noddy.apikey) {
      $.ajax(opts);
    } else {
      if (_preview) {
        $('.save').hide().after('<p class="saved">You need to login to save changes! Your preview will run shortly.</p>');
        setTimeout(function() { $('.saved').hide(); $('.save').show(); preview(undefined,_preview); }, 3000);
        _preview = false;
      } else {
        $('.save').hide().after('<p class="saved">You need to login to save changes!</p>');
        setTimeout(function() { $('.saved').hide(); $('.save').show(); }, 4000);
      }
    }
  }
  $('body').on('click','.save',save);

  noddy.afterLogin = function() {
    $('.promptsignup').hide();
    var uid = noddy.user.account._id;
    if ($('.stickidin').length) {
      var uid = noddy.user.account._id;
      var repstr = 'instantill({uid:"' + uid + '"';
      if (api.indexOf('dev.') !== -1) repstr += ',api:"' + api + '"';
      repstr += '})';
      $('.stickidin').html($('.stickidin').html().replace('instantill()',repstr));
    }
    if ($('.onlyyou').length) $('.onlyyou').html($('.onlyyou').html().replace('but only you ','but only you (' + noddy.user.account.profile.firstname + ') '));
    instantill({uid:uid, api:api});
    try {
      $('.email').attr('placeholder','default ' + (noddy.user.account.email ? noddy.user.account.email : noddy.user.account.emails[0].address));
    } catch(err) {}
    try {
      for (var k in noddy.user.account.service.openaccessbutton.ill.config) {
        if (typeof noddy.user.account.service.openaccessbutton.ill.config[k] === 'boolean') {
          if (noddy.user.account.service.openaccessbutton.ill.config[k] === true) $('#'+k).prop('checked',true);
        } else {
          $('#'+k).val(noddy.user.account.service.openaccessbutton.ill.config[k]);
        }
      }
    } catch(err) {}
    try {
      var q = {"size": 0, "query": {"filtered": {"query": {"bool": {"must": [{"term": {"plugin": "instantill"}},{"term": {"from": noddy.user.account._id}}]}}}}};
      q.aggregations = {"embeds": {"terms": {"field": "embedded.exact"}}};
      $.ajax({
        url: api + '/availabilities',
        type: 'POST',
        data: q,
        success: function(iia) {
          try {
            var eurl = iia.aggregations.embeds.buckets[0].key.split('?')[0].split('#')[0];
            var ex = 'For example using the following URL parameter on one of your current embed URLs would automatically trigger an instantill search:<br>';
            ex += eurl + '?doi=10.1145/2908080.2908114';
            $('#embeddedexample').html(ex).show();
          } catch(err) {}
        }
      });
    } catch(err) {}
    /*if (noddy.hasRole('root')) {
      $('#ill_config').prepend('<input style="border-color:red;" id="uid" type="text" class="form-control setting" placeholder="UID (ADMIN setting override)"><br>')
    }*/
  }
  noddy.nologin = function() {
    instantill({uid:'oab_site', api:api});
  }
  noddy.login();
});
</script>
