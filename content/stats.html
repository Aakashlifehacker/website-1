
<script type="text/javascript" src="/static/holder/jquery.holder.js"></script>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <img class="holder loading" src="/static/spin_orange.svg" style="width:100%;display:none;" />
    </div>
  </div>
</div>

<div class="container-fluid" id="availability" style="margin-bottom:200px;max-width:1200px;width:100%;">
  <div class="row">
    <div class="col-md-12">
      <input type="text" class="form-control holder search" style="display:none;">
      <div id="results">
        <p style="text-align:center;">Stats are only available to administrators. Please try <a href="/account?next=/stats">logging in</a> if you are an admin and the stats do not display.</p>
      </div>
    </div>
  </div>
</div>


<script type="text/javascript" src="//static.cottagelabs.com/d3/d3.v4.min.js"></script>
<script>
  jQuery(document).ready(function() {
    
    var _ids = [];
    var getemails = function() {
      $.ajax({
        url: api + '/stats/emails',
        type: 'POST',
        processData: false,
        cache: false,
        contentType: "application/json; charset=utf-8",
        dataType: 'JSON',
        data: JSON.stringify(_ids),
        success: function(rs) {
          for (var id in rs) $('#id_'+id).html(id + ' ' + rs[id])
        },
        beforeSend: function (request) { request.setRequestHeader("X-apikey", noddy.apikey); }        
      });
    }

  	var fill = d3.scaleOrdinal(d3.schemeCategory10);
    var line = function(data,tgt) {
      var svg = d3.select(tgt),
        margin = {top: 10, right: 5, bottom: 10, left: 50},
        width = +svg.attr("width") - margin.left - margin.right,
        height = +svg.attr("height") - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

      var x = d3.scaleTime()
        .rangeRound([0, width]);
      var y = d3.scaleLinear()
        .rangeRound([height, 0]);

      var line = d3.line()
        .x(function(d) { return x(d.date); })
        .y(function(d) { return y(d.val); });

      x.domain(d3.extent(data, function(d) { return d.date; })).range([0, width - margin.left - margin.right]);
      y.domain(d3.extent(data, function(d) { return d.val; })).nice().range([height - margin.top - margin.bottom, 0]);

      g.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + y.range()[0] + ")")
        .call(d3.axisBottom(x)
  				.ticks( 10 )
  				.tickSizeOuter(0)
  			);

      g.append("g")
        .attr("class", "axis")
        .call(d3.axisLeft(y)
  				.ticks( 10 )
  				.tickSizeOuter(0)
  			);

      g.append("path")
        .datum(data)
        .attr("class", "line values")
        .attr("d", line)
  			.style('fill', 'none' )
        .attr("stroke", function(d) { return fill(d.key); })
  			.style('stroke-width', '1.3px' );

      svg.selectAll("dot")
        .data(data)
        .enter().append("circle")
        .attr("r", 2.5)
        .attr("cx", function(d) { return x(d.date) + margin.left; })
        .attr("cy", function(d) { return y(d.val) + margin.top; })
  			.attr("class","holder dot")
        .attr("stroke", function(d) { return fill(d.key); })
        .attr("fill", function(d) { return fill(d.key); })
  			.attr("do", "add")
  			.attr("key","createdAt")
  			.attr("val",function(d) { return d.date.valueOf(); })
  			.style('cursor', 'pointer' )
        .append("title")
        .text(function(d) { return d.val + " on " + (d.text ? d.text : d.date); });
  	}

    var lineit = function(data,tgt) {
  		var points = [];
  		var t = tgt === 'svg.rrline' ? data.aggregations.received.buckets : data.aggregations.availabilities.buckets;
      for ( var d in t ) {
        var text = moment.unix(t[d].key/1000).format('DD/MM/YYYY');
        points.push({text:text,date:t[d].key,val:t[d].doc_count});
      }
      if (points.length) {
        $(tgt).show();
      	if ( !$(tgt).attr('height') ) $(tgt).attr('height',200);
      	if ( !$(tgt).attr('width') ) $(tgt).attr('width',$('#results').width());
        line(points,tgt);
      } else {
        $(tgt).prev().append(' 0');
      }
  	}

    var status;
    var tool;

    var availability = function(data) {
      var info = '<h2>Stats' + (tool ? ' for ' + tool : '') + '</h2>\
      <p>Filter: <a class="filter" href="/stats#illiad">illiad</a> | <a class="filter" href="/stats#clio">clio</a> | <a class="filter" href="/stats#embedoa">embedoa</a> | <a class="filter" href="/stats#all">all</a> </p>\
      <p>\
        We have been recording usage statistics since we switched to our new system, on 24th October 2016. \
        We don\'t track individual users usage, and we allow most features of our service to be used anonymously. \
        So we have more data about overall usage, and a bit about certain types of usage.\
      </p>\
      <h3>Our Goals</h3>\
      <p>\
        We have goals. Let\'s keep them in mind before getting wrapped up in the figures. I\'m looking at you... JOE.\
      </p>\
      \
      \
      <table>\
<tbody>\
<tr>\
<td>\
<p><b><span style="font-weight: 300;">Activity</span></b></p>\
</td>\
<td>\
<p><b><span style="font-weight: 300;">Year 1 Outputs / Objectives</span></b></p>\
</td>\
<td>\
<p><b><span style="font-weight: 300;">Year 2 Outputs / Objectives</span></b></p>\
</td>\
</tr>\
<tr>\
<td>\
<p><span style="font-weight: 300;">1. Accelerate the development and adoption of tools, resources, and cultures that\ make campuses less reliant on subscriptions to access content</span></p>\
</td>\
<td>\
<p><span style="font-weight: 300;">1a. Usage of our ILL tools at 30 institutions.</span></p>\
<br />\
<p><span style="font-weight: 300;">1b. Rapid prototypes, alpha&rsquo;s and feedback from institutions for key elements of\ GetPDF and InstantILL.</span></p>\
<br />\
<p><span style="font-weight: 300;">1c. The citation of our tools to help campuses access content, and reduce reliance on subscriptions.</span></p>\
</td>\
<td>\
<p><span style="font-weight: 300;">1d. Beta releases for ILL tools. Adoption by 60 institutions. </span></p>\
<br />\
<p><span style="font-weight: 300;">1e. Beta releases for GetPDF and InstantILL on 10 campuses.</span></p>\
</td>\
</tr>\
<tr>\
<td>\
<p><span style="font-weight: 300;">2. Accelerate the development and adoption of tools, resources, and cultures that\ enable dramatic growth of self-archiving</span></p>\
</td>\
<td>\
<p><span style="font-weight: 300;">2a. Sharing 6 experiments, creation of internal and external resources for better\ self-archiving and technical improvements to the request system. </span></p>\
<br />\
<p><span style="font-weight: 300;">2b. Rapid prototypes, alpha&rsquo;s and feedback from institutions for how to integrate\ self-archiving requests into ILL.</span></p>\
<br />\
<p><span style="font-weight: 300;">2c. It is 5 times more scalable than our current system, 1.5 times more effective, and\ </span></p>\
<br />\
<p><span style="font-weight: 300;">2d. We see emerging practice in ILL of making requests.</span></p>\
</td>\
<td>\
<p><span style="font-weight: 300;">2e. Sharing 6 experiments, creation of internal and external resources for better\ self-archiving and technical improvements to the request system. </span></p>\
<br />\
<p><span style="font-weight: 300;">2f. Integration of requests for Open Access into production ILL tools. Usage at 20\ institutions.</span></p>\
<br />\
<p><span style="font-weight: 300;">2g. Establish the Open Access Button request system as a modern (i.e citable, automated, effective and timely), state of the art, mechanism for making research outputs (primarily articles)\ available.</span></p>\
<br />\
<p><span style="font-weight: 300;">2h. It is 10 times more scalable than our current system, two times more effective, and we see strong emerging practice in ILL of making requests.</span></p>\
</td>\
</tr>\
<tr>\
<td>\
<p><span style="font-weight: 300;">3. Accelerating open, community-owned structures to sustain these efforts.</span></p>\
</td>\
<td>\
<p><span style="font-weight: 300;">3a. Pilot, with ~15 institutions, the Open Access Button&rsquo;s membership model with\ institutions. </span></p>\
<br />\
<p><span style="font-weight: 300;">3b. Advisory board created. Successful contact with key collaborators.</span></p>\
</td>\
<td>\
<p><span style="font-weight: 300;">3c. Open the Open Access Button membership program to more institutions. </span></p>\
<br />\
<p><span style="font-weight: 300;">3d. We can can grow slowly on service fees,</span></p>\
<br />\
<p><span style="font-weight: 300;">3e. Announcement of structures ensuring community ownership</span></p>\
<br />\
<p><span style="font-weight: 300;">3f. Build a healthy community aligned around our purpose</span></p>\
</td>\
</tr>\
</tbody>\
</table>\
      ';

      info += '<h3>Requests</h3>';
      if (tool === undefined || tool === 'all') {
        info += '<p>We have ' + status.requests + ' requests. '; //, ' + status.article + ' for articles and ' + status.data + ' for data. ';
        info += status.requests_with_story + ' have stories, ';
        info += status.received + ' have been successful, ' + status.progress + ' are in progress, and ' + status.refused + ' were refused. ';
        info += 'The rest are going through our moderation process. 6184 of these requests in moderation are imports from our old system.</p>';
      } else {
        info += '<p>We have ' + status.requests_with_story + ' requests with story from ' + tool + '.</p>'
      }
      info += '<p>Total requests with stories over time, grouped by week:</p>';
      info += '<svg style="display:none;" class="tline"></svg>';
      info += '<p>New requests over the last two years, grouped by week:</p>';
      info += '<svg style="display:none;" class="rline"></svg>';
      info += '<p>New requests with stories over the last two years, grouped by week:</p>';
      info += '<svg style="display:none;" class="rsline"></svg>';
      info += '<p>Successful requests over the last two years, grouped by week:</p>';
      info += '<svg style="display:none;" class="rrline"></svg>';

      var found = 0;
      for ( var sc in data.facets.sources.terms) {
        if ( data.facets.sources.terms[sc].term !== 'false') found += data.facets.sources.terms[sc].count;
      }

      info += '<iframe width="1200" height="600" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vShmAixPfqHwrhuAjQZQAJxHiY4uR_CCn_fygDbk66iMLLlQtgnZmylcGaj7bkkQDUp4ug3bukecZhZ/pubchart?oid=1196007224&amp;format=interactive"></iframe>';
      info += '<iframe width="1200" height="600" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vShmAixPfqHwrhuAjQZQAJxHiY4uR_CCn_fygDbk66iMLLlQtgnZmylcGaj7bkkQDUp4ug3bukecZhZ/pubchart?oid=1181193312&amp;format=interactive"></iframe>'

      info += '<h3>Availability</h3>';
      info += '<p>We have done ' + data.hits.total + ' availability checks' + (tool !== undefined && tool !== 'all' ? ' for ' + tool : '') + ', and we have found ' + found;
      info += '. That\'s a find success rate of ' + Math.ceil((found/data.hits.total)*100) + '% ';
      info += '(people tend to search for things that are NOT available so we expect this to be low). ';
      info += data.facets.email.missing + ' checks were made anonymously, ';
      info += 'and ' + (data.hits.total - data.facets.email.missing) + ' were made by signed in users. ';
      info += data.aggregations.emails.value + ' users have used the availability service whilst signed in.</p>';
      info += '<p>Availability checks over time, grouped by week:</p>';
      info += '<svg style="display:none;" class="line"></svg>';

      if (tool === undefined || tool === 'all') {
        info += '<h3>Institutional Interest</h3>';
        info += '<iframe width="1200" height="600" seamless frameborder="0" scrolling="no" src="https://docs.google.com/spreadsheets/d/e/2PACX-1vS3WaJOIBtTGFg81W9VKEdr78Tt-5sA_pZ-WogwB-SFBG721MjUszxRmT5rcfQog3DIk0R7-8ME-hi1/pubchart?oid=823347277&amp;format=interactive"></iframe>';
      }

      if (tool === undefined || tool === 'all') {
        info += '<h3>Users</h3>';
        info += '<p>We have ' + status.users + ' users in total, and ' + status.requested + ' have made requests while signed in. ' + status.supports;
        info += ' users have added their support to requests that someone else made. ' + data.aggregations.tm1.tm1v.value + ' users have done an availability ';
        info += ' check whilst signed in during the last month, and ' + data.aggregations.tm3.tm3v.value + ' greater than 1 month but less than 3 months ago.</p>';
      } else {
        info += '<h3>Users of ' + tool + '</h3>';
      }

      var plugins = {api:{all:data.facets.plugin.missing,week:data.facets.plugin_week.missing,month:data.facets.plugin_month.missing,threemonth:data.facets.plugin_3month.missing,june18:data.facets.plugin_june18.missing}};
      var alltotal = 0 + plugins.api.all;
      var weektotal = 0 + plugins.api.week;
      var monthtotal = 0 + plugins.api.month;
      var threemonthtotal = 0 + plugins.api.threemonth;
      var june18total = 0 + plugins.api.june18
      if (tool !== undefined && tool !== 'all') {
        plugins = {}
      }
      if (tool === undefined || tool === 'all' || tool === 'embedoa') {
        for ( var p in data.facets.plugin.terms ) {
          var pl = data.facets.plugin.terms[p];
          if (pl.term.indexOf('test') === -1) {
            var at = pl.term.split('_')[0].replace('oabutton','plugin').replace('oab','plugin');
            if (pl.term.indexOf('firefox') !== -1) at = 'firefox_plugin';
            if (plugins[at] === undefined) plugins[at] = {all:0,week:0,month:0,threemonth:0,june18:0}
            plugins[at].all += pl.count;
            alltotal += pl.count;
          }
        }
        for ( var wp in data.facets.plugin_week.terms ) {
          var pw = data.facets.plugin_week.terms[wp];
          if (pw.term.indexOf('test') === -1) {
            var wt = pw.term.split('_')[0].replace('oabutton','plugin').replace('oab','plugin');
            if (pw.term.indexOf('firefox') !== -1) wt = 'firefox_plugin';
            if (plugins[wt] === undefined) plugins[wt] = {all:0,week:0,month:0,threemonth:0,june18:0}
            plugins[wt].week += pw.count;
            weektotal += pw.count;
          }
        }
        for ( var wp in data.facets.plugin_month.terms ) {
          var pw = data.facets.plugin_month.terms[wp];
          if (pw.term.indexOf('test') === -1) {
            var wt = pw.term.split('_')[0].replace('oabutton','plugin').replace('oab','plugin');
            if (pw.term.indexOf('firefox') !== -1) wt = 'firefox_plugin';
            if (plugins[wt] === undefined) plugins[wt] = {all:0,week:0,month:0,threemonth:0,june18:0}
            plugins[wt].month += pw.count;
            monthtotal += pw.count;
          }
        }
        for ( var wp in data.facets.plugin_3month.terms ) {
          var pw = data.facets.plugin_3month.terms[wp];
          if (pw.term.indexOf('test') === -1) {
            var wt = pw.term.split('_')[0].replace('oabutton','plugin').replace('oab','plugin');
            if (pw.term.indexOf('firefox') !== -1) wt = 'firefox_plugin';
            if (plugins[wt] === undefined) plugins[wt] = {all:0,week:0,month:0,threemonth:0,june18:0}
            plugins[wt].threemonth += pw.count;
            threemonthtotal += pw.count;
          }
        }
        for ( var wp in data.facets.plugin_june18.terms ) {
          var pw = data.facets.plugin_june18.terms[wp];
          if (pw.term.indexOf('test') === -1) {
            var wt = pw.term.split('_')[0].replace('oabutton','plugin').replace('oab','plugin');
            if (pw.term.indexOf('firefox') !== -1) wt = 'firefox_plugin';
            if (plugins[wt] === undefined) plugins[wt] = {all:0,week:0,month:0,threemonth:0,june18:0}
            plugins[wt].june18 += pw.count;
            june18total += pw.count;
          }
        }
      }

      if (tool === undefined || tool === 'all') {
        info += '<p>Users have been using these tools:</p>';
      }

      info += '<table class="table table-bordered table-striped" style="background-color:white;"><thead><tr><th></th>';
      for ( var plug in plugins ) info += '<th>' + (plug === 'widget' ? 'embedoa<br>(widget)' : plug) + '</th>';
      if (tool === undefined || tool === 'all') {
        info += '<th>illiad</th><th>clio</th><th>integration</th>'
        info += '<th>TOTAL</th>';
      } else if (tool !== 'embedoa') {
        info += '<th>' + tool + '</th>';
      }
      info += '</tr></thead><tbody><tr><td><b>all-time</b></td>';
      for ( var pla in plugins ) info += '<td>' + plugins[pla].all + '</td>';
      if (tool === undefined || tool === 'all') {
        info += '<td>ILLIADALLCOUNT</td><td>CLIOALLCOUNT</td><td>INTEGRATIONALLCOUNT</td>';
        info += '<td>' + alltotal + '</td>';
      } else if (tool !== 'embedoa') {
        info += '<td>' + tool.toUpperCase() + 'ALLCOUNT</td>';
      }
      info += '</tr><tr><td><b>the last week</b></td>';
      for ( var plw in plugins ) info += '<td>' + plugins[plw].week + '</td>';
      if (tool === undefined || tool === 'all') {
        info += '<td>ILLIADWEEKCOUNT</td><td>CLIOWEEKCOUNT</td><td>INTEGRATIONWEEKCOUNT</td>';
        info += '<td>' + weektotal + '</td>';
      } else if (tool !== 'embedoa') {
        info += '<td>' + tool.toUpperCase() + 'WEEKCOUNT</td>';
      }
      info += '</tr><tr><td><b>the last month</b></td>';
      for ( var plm in plugins ) info += '<td>' + plugins[plm].month + '</td>';
      if (tool === undefined || tool === 'all') {
        info += '<td>ILLIADMONTHCOUNT</td><td>CLIOMONTHCOUNT</td><td>INTEGRATIONMONTHCOUNT</td>';
        info += '<td>' + monthtotal + '</td>';
      } else if (tool !== 'embedoa') {
        info += '<td>' + tool.toUpperCase() + 'MONTHCOUNT</td>';
      }
      info += '</tr><tr><td><b>the last 3 months</b></td>';
      for ( var pl3m in plugins ) info += '<td>' + plugins[pl3m].threemonth + '</td>';
      if (tool === undefined || tool === 'all') {
        info += '<td>ILLIAD3MONTHCOUNT</td><td>CLIO3MONTHCOUNT</td><td>INTEGRATION3MONTHCOUNT</td>';
        info += '<td>' + threemonthtotal + '</td>';
      } else if (tool !== 'embedoa') {
        info += '<td>' + tool.toUpperCase() + '3MONTHCOUNT</td>';
      }
      info += '</tr><tr><td><b>since June 2018</b></td>';
      for ( var plj18 in plugins ) info += '<td>' + plugins[plj18].june18 + '</td>';
      if (tool === undefined || tool === 'all') {
        info += '<td>ILLIADJUNE18COUNT</td><td>CLIOJUNE18COUNT</td><td>INTEGRATIONJUNE18COUNT</td>';
        info += '<td>' + june18total + '</td>';
      } else if (tool !== 'embedoa') {
        info += '<td>' + tool.toUpperCase() + 'JUNE18COUNT</td>';
      }
      info += '</tr></tbody></table>';

      if (false) { //tool === undefined || tool === 'all') {
        if (data.facets.embeds.terms.length) info += '<h4>We have embedded availability checks from the following locations:</h4>';
        for ( var e in data.facets.embeds.terms ) {
          var em = data.facets.embeds.terms[e];
          info += '<p>' + em.term + ' (' + em.count  + ')</p>';
        }
      }

      // "website" in the table is where our front page sends an availability check with from:website
      // "oab_site" in the listing is where instantill or embedoa are triggered from our site and use the placeholder uid:oab_site which gets passed 
      // as from:oab_site in their availability checks
      // integration is anything that passes from:integration
      if (data.aggregations.users.buckets && (tool === undefined || tool === 'all')) {
        info += '<h4><br>We also have availability checks from the following services (and from some user IDs):</h4>';
        info += '<p><a id="emails" href="#">Get user email addresses</a></p>';
        _ids = [];
      }
      for ( var f in data.aggregations.users.buckets ) {
        var fr = data.aggregations.users.buckets[f];
        if (tool === undefined || tool === 'all') {
          info += '<p><span id="id_' + fr.key + '">' + fr.key + '</span> ' + fr.firsts.buckets[0].key_as_string.split(' ')[0] + ' (' + fr.doc_count  + ')</p>';
          _ids.push(fr.key);
        }
        if (fr !== undefined && fr.key === 'illiad') info = info.replace('ILLIADALLCOUNT',fr.doc_count)
        if (fr !== undefined && fr.key === 'clio') info = info.replace('CLIOALLCOUNT',fr.doc_count)
        if (fr !== undefined && fr.key === 'integration') info = info.replace('INTEGRATIONALLCOUNT',fr.doc_count)
      }
      info = info.replace('ILLIADALLCOUNT',0)
      info = info.replace('CLIOALLCOUNT',0)
      info = info.replace('INTEGRATIONALLCOUNT',0)

      for ( var fw in data.facets.from_week.terms ) {
        var fm = data.facets.from_week.terms[fw];
        if (fm !== undefined && fm.term === 'illiad') info = info.replace('ILLIADWEEKCOUNT',fm.count)
        if (fm !== undefined && fm.term === 'clio') info = info.replace('CLIOWEEKCOUNT',fm.count)
        if (fm !== undefined && fm.term === 'integration') info = info.replace('INTEGRATIONWEEKCOUNT',fm.count)
      }
      info = info.replace('ILLIADWEEKCOUNT',0)
      info = info.replace('CLIOWEEKCOUNT',0)
      info = info.replace('INTEGRATIONWEEKCOUNT',0)

      for ( var fom in data.facets.from_month.terms ) {
        var fm = data.facets.from_month.terms[fom];
        if (fm !== undefined && fm.term === 'illiad') info = info.replace('ILLIADMONTHCOUNT',fm.count)
        if (fm !== undefined && fm.term === 'clio') info = info.replace('CLIOMONTHCOUNT',fm.count)
        if (fm !== undefined && fm.term === 'integration') info = info.replace('INTEGRATIONMONTHCOUNT',fm.count)
      }
      info = info.replace('ILLIADMONTHCOUNT',0)
      info = info.replace('CLIOMONTHCOUNT',0)
      info = info.replace('INTEGRATIONMONTHCOUNT',0)

      for ( var f3m in data.facets.from_3month.terms ) {
        var fm = data.facets.from_3month.terms[f3m];
        if (fm !== undefined && fm.term === 'illiad') info = info.replace('ILLIAD3MONTHCOUNT',fm.count)
        if (fm !== undefined && fm.term === 'clio') info = info.replace('CLIO3MONTHCOUNT',fm.count)
        if (fm !== undefined && fm.term === 'integration') info = info.replace('INTEGRATION3MONTHCOUNT',fm.count)
      }
      info = info.replace('ILLIAD3MONTHCOUNT',0)
      info = info.replace('CLIO3MONTHCOUNT',0)
      info = info.replace('INTEGRATION3MONTHCOUNT',0)

      for ( var fj18 in data.facets.from_june18.terms ) {
        var fm = data.facets.from_june18.terms[fj18];
        if (fm !== undefined && fm.term === 'illiad') info = info.replace('ILLIADJUNE18COUNT',fm.count)
        if (fm !== undefined && fm.term === 'clio') info = info.replace('CLIOJUNE18COUNT',fm.count)
        if (fm !== undefined && fm.term === 'integration') info = info.replace('INTEGRATIONJUNE18COUNT',fm.count)
      }
      info = info.replace('ILLIADJUNE18COUNT',0)
      info = info.replace('CLIOJUNE18COUNT',0)
      info = info.replace('INTEGRATIONJUNE18COUNT',0)

      $('#results').html(info);
      if ( $('#emails').length ) $('#emails').bind('click',function(e) { e.preventDefault(); getemails(); });
      $('.filter').bind('click',function(e) { e.preventDefault(); window.location = $(this).attr('href'); window.location.reload(); });
      lineit(data,"svg.line");
    }

    var must = [];
    if (window.location.hash) {
      tool = window.location.hash.replace('#','');
      must = [];
      if (tool === 'illiad') {
        must.push({term:{from:'illiad'}});
      } else if (tool === 'clio') {
        must.push({term:{from:'clio'}});
      } else if (tool === 'embedoa') {
        must.push({term:{plugin:'widget'}});
      }
    }

    var tm1 = new Date();
    var m = tm1.getMonth();
    tm1.setMonth(tm1.getMonth() - 1);
    if (tm1.getMonth() === m) tm1.setDate(0);
    tm1.setHours(0, 0, 0);
    tm1.setMilliseconds(0);

    var tm3 = new Date();
    tm3.setMonth(tm3.getMonth() - 3);
    if (tm3.getMonth() === m) tm3.setDate(0);
    tm3.setHours(0, 0, 0);
    tm3.setMilliseconds(0);

    var tmwk = new Date();
    tmwk.setDate(tmwk.getDate() - 7);
    tmwk.setHours(0, 0, 0);
    tmwk.setMilliseconds(0);

    var tmj18 = 1527811200000;

    var qry = {"size": 0, "query": {"filtered": {"query": {"bool": {"must": must}}}}};
    var getstatus = function(data) {
      if (status === undefined) {
        // get the status, and also the first requests query, because it updates status
        $.ajax({
          url: api + '/status',
          success: function(rs) {
            status = rs;
            // get total requests with stories
            qry.query.filtered.query.bool.must.push({"query_string": {"query": "story:*"}});
            $.ajax({
              //url: api + '/requests?&source=%7B%22size%22%3A0%2C%22query%22%3A%7B%22filtered%22%3A%7B%22query%22%3A%7B%22bool%22%3A%7B%22must%22%3A%5B%7B%22query_string%22%3A%7B%22query%22%3A%22story%3A*%22%7D%7D%5D%7D%7D%7D%7D%2C%22from%22%3A0%7D',
              url: api + '/requests',
              type: 'POST',
              data: qry,
              success: function(d) {
                status.requests_with_story = d.hits.total;
                availability(data);

                // get / calculate total new requests with stories over time, grouped by week
                qry.aggregations = {"availabilities": {"date_histogram": {"field": "createdAt","interval": "week"}}}
                $.ajax({
                  //url: api + '/requests?&source=%7B%22size%22%3A0%2C%22query%22%3A%7B%22filtered%22%3A%7B%22query%22%3A%7B%22bool%22%3A%7B%22must%22%3A%5B%7B%22query_string%22%3A%7B%22query%22%3A%22story%3A*%22%7D%7D%5D%7D%7D%7D%7D%2C%22aggregations%22%3A%7B%22availabilities%22%3A%7B%22date_histogram%22%3A%7B%22field%22%3A%22createdAt%22%2C%22interval%22%3A%22week%22%7D%7D%7D%2C%22from%22%3A0%7D',
                  url: api + '/requests',
                  type: 'POST',
                  data: qry,
                  success: function(d) {
                		var total = 0;
                    for ( var r in d.aggregations.availabilities.buckets ) {
                      total += d.aggregations.availabilities.buckets[r].doc_count;
                      d.aggregations.availabilities.buckets[r].doc_count = total;
                    }
                    lineit(d,"svg.tline");
                  }
                });

                // get new requests with stories over the last 2 years, grouped by week
                var twoyearsago = Date.now() - (31536000000*2);
                var lq = qry.query.filtered.query.bool.must.pop();
                lq['query_string'].query += ' AND createdAt:>' + twoyearsago;
                qry.query.filtered.query.bool.must.push(lq);
                $.ajax({
                  //url: api + '/requests?&source=%7B%22size%22%3A0%2C%22query%22%3A%7B%22filtered%22%3A%7B%22query%22%3A%7B%22bool%22%3A%7B%22must%22%3A%5B%7B%22query_string%22%3A%7B%22query%22%3A%22story%3A* AND createdAt:>' + twoyearsago + '%22%7D%7D%5D%7D%7D%7D%7D%2C%22aggregations%22%3A%7B%22availabilities%22%3A%7B%22date_histogram%22%3A%7B%22field%22%3A%22createdAt%22%2C%22interval%22%3A%22week%22%7D%7D%7D%2C%22from%22%3A0%7D',
                  url: api + '/requests',
                  type: 'POST',
                  data: qry,
                  success: function(d) {
                    lineit(d,"svg.rsline");
                  }
                });

                // get new requests over last 2 years, and successful requests over last 2 years, grouped by week
                var elq = qry.query.filtered.query.bool.must.pop();
                elq['query_string'].query = 'createdAt:>' + twoyearsago;
                qry.query.filtered.query.bool.must.push(elq);
                qry.aggregations.received = {"date_histogram": {"field": "received.date","interval": "week"}}
                $.ajax({
                  //url: api + '/requests?&source=%7B%22size%22%3A0%2C%22query%22%3A%7B%22filtered%22%3A%7B%22query%22%3A%7B%22bool%22%3A%7B%22must%22%3A%5B%7B%22query_string%22%3A%7B%22query%22%3A%22createdAt:>' + twoyearsago + '%22%7D%7D%5D%7D%7D%7D%7D%2C%22aggregations%22%3A%7B%22availabilities%22%3A%7B%22date_histogram%22%3A%7B%22field%22%3A%22createdAt%22%2C%22interval%22%3A%22week%22%7D%7D%2C%22received%22%3A%7B%22date_histogram%22%3A%7B%22field%22%3A%22received.date%22%2C%22interval%22%3A%22week%22%7D%7D%7D%2C%22from%22%3A0%7D',
                  url: api + '/requests',
                  type: 'POST',
                  data: qry,
                  success: function(dt) {
                    lineit(dt,"svg.rline");
                    lineit(dt,"svg.rrline");
                  }
                });

                if (tool === undefined || tool === 'all' || tool === 'embedoa') {
                  // get embedoa data
                  var m = [{term: {plugin: 'widget'}}];
                  var q = {"size": 0, "query": {"filtered": {"query": {"bool": {"must": m}}}}};
                  q.aggregations = {"users": {"terms": {"field": "from.exact", "size": 10000}}};
                  q.aggregations.users.aggs = {"firsts": {"terms": {"field":"created_date", "size": 1, "order": {"_term": "asc"}}}};
                  q.aggregations.users.aggs.oa = {"filter": {"bool": {"must_not": [{"term": {"discovered.article": false}}]}}, "aggs": {"from": {"terms": {"field": "from.exact"}}}};
                  q.aggregations.users.aggs.embeds = {"terms": {"field": "embedded.exact", "size": 100}};
                  $.ajax({
                    url: api + '/availabilities',
                    type: 'POST',
                    data: q,
                    success: function(iia) {
                      var oq = {"size": 0, "query": {"filtered": {"query": {"query_string": {"query": "*"}}}}};
                      oq.aggregations = {"users": {"terms": {"field": "from.exact", "size": 10000}}};

                      var oainfo = '<h3>EmbedOA (widget) usage</h3>';
                      oainfo += '<table class="table table-bordered table-striped" style="background-color:white;"><thead>';
                      oainfo += '<tr><th>User ID</th><th>Embeds</th><th>First use</th><th>Total checks</th><th>OA provided</th></tr>';
                      oainfo += '</thead><tbody>';
                      for (var a in iia.aggregations.users.buckets) {
                        var bk = iia.aggregations.users.buckets[a];
                        oainfo += '<tr>';
                        oainfo += '<td>' + bk.key + '</td>';
                        oainfo += '<td>';
                        try {
                          var el = ''
                          for (var e in bk.embeds.buckets) {
                            var tk = bk.embeds.buckets[e].key.split('?')[0].split('#')[0];
                            if (el.indexOf(tk) === -1) {
                              if (e !== "0") el += '<br>';
                              el += tk;
                            }
                          }
                          oainfo += el;
                        } catch(err) {}
                        oainfo += '</td>';
                        oainfo += '<td>';
                        try { oainfo += bk.firsts.buckets[0].key_as_string.split(' ')[0].split('-').reverse().join('/'); } catch(err) {}
                        oainfo += '</td>';
                        oainfo += '<td>' + bk.doc_count + '</td>';
                        oainfo += '<td>';
                        try { oainfo += bk.oa.doc_count; } catch(err) {}
                        oainfo += '</td>';
                        oainfo += '</tr>';
                      }
                      oainfo += '</tbody></table>';
                      $('#results').append(oainfo);
                    }
                  });
                }

                if (tool === undefined || tool === 'all') {
                  // get pings data
                  $.ajax({
                    url: noddy.api + '/pings?q=service:openaccessbutton&sort=createdAt:asc&size=100000',
                    success: function(dp) {
                      var order = ['alltime','week','month','threemonth','june18'];
                      var pinginfo = '<h3>Resource pings</h3>';
                      pinginfo += '<table class="table table-bordered table-striped" style="background-color:white;"><thead>';
                      pinginfo += '<tr><th></th><th>all-time</th><th>last week</th><th>last month</th><th>last 3 months</th><th>since June 2018</th></tr>';
                      pinginfo += '</thead><tbody>';

                      var actions = {alltime:{},week:{},month:{},threemonth:{},june18:{}}
                      for ( var h in dp.hits.hits) {
                        var hr = dp.hits.hits[h]._source;
                        if (hr.action !== 'undefined') {
                          if (actions.alltime[hr.action] === undefined) actions.alltime[hr.action] = 0
                          actions.alltime[hr.action] += 1;
                          if (hr.createdAt > tmwk.valueOf()) {
                            if (actions.week[hr.action] === undefined) actions.week[hr.action] = 0
                            actions.week[hr.action] += 1;
                          }
                          if (hr.createdAt > tm1.valueOf()) {
                            if (actions.month[hr.action] === undefined) actions.month[hr.action] = 0
                            actions.month[hr.action] += 1;
                          }
                          if (hr.createdAt > tm3.valueOf()) {
                            if (actions.threemonth[hr.action] === undefined) actions.threemonth[hr.action] = 0
                            actions.threemonth[hr.action] += 1;
                          }
                          if (hr.createdAt > tmj18) {
                            if (actions.june18[hr.action] === undefined) actions.june18[hr.action] = 0
                            actions.june18[hr.action] += 1;
                          }
                        }
                      }

                      var sorts = [];
                      for ( var kv in actions.alltime ) sorts.push([kv, actions.alltime[kv]]);
                      sorts.sort(function(a, b) { return a[1] - b[1]; });
                      for (var s in sorts) {
                        pinginfo += '<tr>';
                        pinginfo += '<td>' + sorts[s][0] + '</td>';
                        pinginfo += '<td>' + sorts[s][1] + '</td>';
                        pinginfo += '<td>' + (actions.week[sorts[s][0]] ? actions.week[sorts[s][0]] : 0) + '</td>';
                        pinginfo += '<td>' + (actions.month[sorts[s][0]] ? actions.month[sorts[s][0]] : 0) + '</td>';
                        pinginfo += '<td>' + (actions.threemonth[sorts[s][0]] ? actions.threemonth[sorts[s][0]] : 0) + '</td>';
                        pinginfo += '<td>' + (actions.june18[sorts[s][0]] ? actions.june18[sorts[s][0]] : 0) + '</td>';
                        pinginfo += '</tr>';
                      }
                      pinginfo += '</tbody></table>';
                      $('#results').append(pinginfo);
                    }
                  });

                  // get instantill data
                  var m = [{term: {plugin: 'instantill'}}];
                  var q = {"size": 0, "query": {"filtered": {"query": {"bool": {"must": m}}}}};
                  q.aggregations = {"users": {"terms": {"field": "from.exact", "size": 10000}}};
                  q.aggregations.users.aggs = {"firsts": {"terms": {"field":"created_date", "size": 1, "order": {"_term": "asc"}}}};
                  q.aggregations.users.aggs.oa = {"filter": {"bool": {"must_not": [{"term": {"discovered.article": false}}]}}, "aggs": {"from": {"terms": {"field": "from.exact"}}}};
                  q.aggregations.users.aggs.subs = {"filter": {"query": {"query_string": {"query": "ill.subscription.url:*"}}}, "aggs": {"from": {"terms": {"field": "from.exact"}}}};
                  q.aggregations.users.aggs.wrong = {"filter": {"term": {"wrong": true}}, "aggs": {"from": {"terms": {"field": "from.exact"}}}};
                  q.aggregations.users.aggs.embeds = {"terms": {"field": "embedded.exact", "size": 100}};
                  $.ajax({
                    url: api + '/availabilities',
                    type: 'POST',
                    data: q,
                    success: function(iia) {
                      var oq = {"size": 0, "query": {"filtered": {"query": {"query_string": {"query": "*"}}}}};
                      oq.aggregations = {"users": {"terms": {"field": "from.exact", "size": 10000}}};
                      oq.aggregations.issn = {"filter": {"query": {"query_string": {"query": "metadata.title:* AND metadata.journal:* AND metadata.year:* AND metadata.issn:*"}}}, "aggs": {"users": {"terms": {"field": "from.exact", "size": 10000}}}};
                      oq.aggregations.forwarded = {"filter": {"term": {"forwarded": true}}, "aggs": {"users": {"terms": {"field": "from.exact", "size": 10000}}}};
                      var illopts = {
                        url: api + '/ills?all=true',
                        type: 'POST',
                        processData: false,
                        cache: false,
                        contentType: "application/json; charset=utf-8",
                        dataType: 'JSON',
                        data: JSON.stringify(oq),
                        success: function(iii) {
                          var ills = {};
                          for ( var i in iii.aggregations.users.buckets ) ills[iii.aggregations.users.buckets[i].key] = iii.aggregations.users.buckets[i].doc_count;
                          var withissn = {};
                          for ( var u in iii.aggregations.issn.users.buckets) withissn[iii.aggregations.issn.users.buckets[u].key] = iii.aggregations.issn.users.buckets[u].doc_count;
                          var forwarded = {};
                          for ( var f in iii.aggregations.forwarded.users.buckets) forwarded[iii.aggregations.forwarded.users.buckets[f].key] = iii.aggregations.forwarded.users.buckets[f].doc_count;
                          var illinfo = '<h3>InstantILL usage</h3>';
                          illinfo += '<table class="table table-bordered table-striped" style="background-color:white;"><thead>';
                          illinfo += '<tr><th>User ID</th><th>Embeds</th><th>First use</th><th>Total checks</th><th>OA provided</th><th>Subs provided</th><th>Wrong hits</th><th>ILLs submitted</th><th>ILLs forwarded</th><th>With title, journal, year, ISSN</th></tr>';
                          illinfo += '</thead><tbody>';
                          for (var a in iia.aggregations.users.buckets) {
                            var bk = iia.aggregations.users.buckets[a];
                            illinfo += '<tr>';
                            illinfo += '<td style="font-size:0.8em;">' + bk.key + '</td>';
                            illinfo += '<td style="font-size:0.8em;">';
                            try {
                              var el = ''
                              for (var e in bk.embeds.buckets) {
                                var tk = bk.embeds.buckets[e].key.split('?')[0].split('#')[0];
                                if (el.indexOf(tk) === -1) {
                                  if (e !== "0") el += '<br>';
                                  el += '<a target="_blank" href="' + tk + '">' + tk.split('://')[1] + '</a>';
                                }
                              }
                              illinfo += el;
                            } catch(err) {}
                            illinfo += '</td>';
                            illinfo += '<td>';
                            try { illinfo += bk.firsts.buckets[0].key_as_string.split(' ')[0].split('-').reverse().join('/'); } catch(err) {}
                            illinfo += '</td>';
                            illinfo += '<td>' + bk.doc_count + '</td>';
                            illinfo += '<td>';
                            try { illinfo += bk.oa.doc_count; } catch(err) {}
                            illinfo += '</td>';
                            illinfo += '<td>';
                            try { illinfo += bk.subs.doc_count; } catch(err) {}
                            illinfo += '</td>';
                            illinfo += '<td>';
                            try { illinfo += bk.wrong.doc_count; } catch(err) {}
                            illinfo += '</td>';
                            illinfo += '<td>' + (ills[bk.key] ? ills[bk.key] : 0) + '</td>';
                            var fn = 0;
                            try {
                              fn = Math.ceil((forwarded[bk.key] / ills[bk.key])*100);
                              if (isNaN(fn)) fn = 0;
                            } catch(err) {}
                            illinfo += '<td>' + fn + '%</td>';
                            var pn = 0;
                            try {
                              pn = Math.ceil((withissn[bk.key] / ills[bk.key])*100);
                              if (isNaN(pn)) pn = 0;
                            } catch(err) {}
                            illinfo += '<td>' + pn + '%</td>';
                            illinfo += '</tr>';
                          }
                          illinfo += '</tbody></table>';
                          $('#results').append(illinfo);
                        }
                      }
                      if (noddy.apikey) illopts.beforeSend = function (request) { request.setRequestHeader("X-apikey", noddy.apikey); }
                      $.ajax(illopts);
                    }
                  });
                }
              }
            });
          }
        });
      } else {
        availability(data);
      }
    }

    var dostats = function() {
      $('.holder.loading').show();
      $('#availability').holder({
        class: 'holder',
        url: api + "/availabilities",
        datatype: 'JSON',
        defaultquery: {
          size:0,
          query: {
            filtered: {
              query: {
                bool: {
                  must: must
                }
              },
              filter: {
                bool: {
                  must:[]
                }
              }
            }
          },
          aggregations: {
            "users": {
              "terms": {"field": "from.exact", "size": 10000},
              "aggs": {"firsts": {"terms": {"field":"created_date", "size": 1, "order": {"_term": "asc"}}}}
            },
            "availabilities" : {
              "date_histogram" : {
                "field" : "createdAt",
                "interval" : "week"
              }
            },
            "emails" : {
              "cardinality" : {
                "field" : "email.exact"
              }
            },
            "tm1" : {
              "filter": { "range" : { "createdAt" : { "gt" : tm1.valueOf() } } },
              "aggs": {
                "tm1v": {
                  "cardinality" : {
                    "field" : "email.exact"
                  }
                }
              }
            },
            "tm3" : {
              "filter": { "range" : { "createdAt" : { "gt" : tm3.valueOf(), "lte": tm1.valueOf() } } },
              "aggs": {
                "tm3v": {
                  "cardinality" : {
                    "field" : "email.exact"
                  }
                }
              }
            }
          }
        },
        pushstate: false,
        review: getstatus,
        facets: {
          plugin: { terms: { "field": "plugin.exact", "size": 500 } },
          plugin_week: { terms: { "field": "plugin.exact", "size": 500 }, "facet_filter" : { "range" : { "createdAt" : { "gt" : tmwk.valueOf() } } } },
          plugin_month: { terms: { "field": "plugin.exact", "size": 500 }, "facet_filter" : { "range" : { "createdAt" : { "gt" : tm1.valueOf() } } } },
          plugin_3month: { terms: { "field": "plugin.exact", "size": 500 }, "facet_filter" : { "range" : { "createdAt" : { "gt" : tm3.valueOf() } } } },
          plugin_june18: { terms: { "field": "plugin.exact", "size": 500 }, "facet_filter" : { "range" : { "createdAt" : { "gt" : 1527811200000 } } } },
        	email: { terms: { "field": "email.exact", "size": 1 } },
          sources: { terms: { "field": "source.article", "size": 500 } },
          embeds: { terms: { "field": "embedded.exact", "size": 500 } },
          from_week: { terms: { "field": "from.exact", "size": 500 }, "facet_filter" : { "range" : { "createdAt" : { "gt" : tmwk.valueOf() } } } },
          from_month: { terms: { "field": "from.exact", "size": 500 }, "facet_filter" : { "range" : { "createdAt" : { "gt" : tm1.valueOf() } } } },
          from_3month: { terms: { "field": "from.exact", "size": 500 }, "facet_filter" : { "range" : { "createdAt" : { "gt" : tm3.valueOf() } } } },
          from_june18: { terms: { "field": "from.exact", "size": 500 }, "facet_filter" : { "range" : { "createdAt" : { "gt" : tmj18 } } } }
        }
      });
    }

    noddy.afterLogin = function() {
      if (noddy.hasRole('openaccessbutton.admin')) {
        dostats();
      }
    }
    noddy.login();

  });
</script>
