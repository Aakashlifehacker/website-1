<script src="/static/instantill.js"></script>
<script>
jQuery(document).ready(function() {
  $('.tryit').bind('click',function(e) {
    e.preventDefault();
    $('#oabutton_input').val($(this).html());
    setTimeout(function() {
      $('#oabutton_find').trigger('click');
    },500)
  });
  
  var addsubscription = function(e) {
    try {e.preventDefault(); } catch(err) {}
    if ($('.subscription').last().val() && $('.subscription_type').last().val()) {
      $('.subscription').last().clone().val('').insertBefore($('#addsubscription'));
      $('.subscription_type').last().clone().val('').insertBefore($('#addsubscription'));
    } else {
      $('.subscription').last().focus();
    }
  }
  $('body').on('click','#addsubscription',addsubscription);

  var guesssubscription = function(e) {
    if ($(this).val().indexOf('sfx.') !== -1) {
      $(this).next('.subscription_type').val('sfx');
    } else if ($(this).val().indexOf('ebscohost.') !== -1) {
      $(this).next('.subscription_type').val('eds');
    } else if ($(this).val().indexOf('serialssolutions.') !== -1) {
      $(this).next('.subscription_type').val('serialssolutions');
    }
  }
  $('body').on('change','.subscription',guesssubscription);

  var save = function(e) {
    if (e) e.preventDefault();
    var data = {};
    $('.setting').each(function(i, obj) {
      if ( $(this).is(':checkbox') ) {
        data[$(this).attr('id')] = $(this).is(':checked');
      } else if ( $(this).hasClass('subscription') ) {
        if ($(this).val()) {
          if (data.subscription === undefined) data.subscription = [];
          data.subscription.push($(this).val())
        } else {
          $(this).remove();
        }
      } else if ( $(this).hasClass('subscription_type') ) {
        if ($(this).val()) {
          if (data['subscription_type'] === undefined) data['subscription_type'] = [];
          data['subscription_type'].push($(this).val())
        } else {
          $(this).remove();
        }
      } else if ( $(this).val() !== undefined ) {
        data[$(this).attr('id')] = $(this).val();
        if (['ill_redirect_base_url','terms','book','other'].indexOf($(this).attr('id')) !== -1 && data[$(this).attr('id')] !== '' && data[$(this).attr('id')].indexOf('http') !== 0) {
          data[$(this).attr('id')] = 'http://' + data[$(this).attr('id')];
          $(this).val(data[$(this).attr('id')]);
        }
      }
    });

    var opts = {
      url: api + '/ill/config',
      type:'POST',
      cache:false,
      processData:false,
      contentType: 'application/json',
      dataType: 'json',
      success: function(data) {
        $('.save').hide().after('<span class="saved">Changes saved! Refresh the page to reload the demo above and see it with changes applied.</span>');
        setTimeout(function() { $('.saved').hide(); $('.save').show(); }, 5000);
      },
      error: function(data) {
        $('#save').hide().after('<span id="saved">Sorry, changes could not be saved.</span>');
        setTimeout(function() { $('.saved').hide(); $('#save').show(); }, 5000);
      },
      beforeSend: function (request) { request.setRequestHeader("x-apikey", noddy.apikey); }
    }
    opts.data = JSON.stringify(data);
    $.ajax(opts);
  }

  noddy.afterLogin = function() {
    $('.promptsignup').hide();
    $('.installit').show();
    var uid = noddy.user.account._id;
    var repstr = 'instantill({uid:"' + uid + '"';
    if (api.indexOf('dev.') !== -1) repstr += ',api:"' + api + '"';
    repstr += '})';
    $('.stickidin').html($('.stickidin').html().replace('instantill()',repstr));
    $('#onlyyou').html($('#onlyyou').html().replace('but only you ','but only you (' + noddy.user.account.profile.firstname + ') '));
    instantill({uid:uid, api:api});
    try {
      $('#email').attr('placeholder','default ' + (noddy.user.account.email ? noddy.user.account.email : noddy.user.account.emails[0].address));
    } catch(err) {}
    try {
      var uc = noddy.user.account.service.openaccessbutton.ill.config;
      for (var k in uc) {
        if (typeof uc[k] === 'boolean') {
          if (uc[k] === true) $('#'+k).prop('checked',true);
        } else if (k === 'subscription') {
          if (typeof uc.subscription === 'string') uc.subscription = uc.subscription.split(',');
          for ( var s in uc.subscription) {
            if (parseInt(s) !== 0) addsubscription();
            if (typeof uc.subscription[s] === 'object') {
              var url = uc.subscription[s].url;
              var type = uc.subscription[s].type;
            } else {
              var url = uc.subscription[s];
              try {
                var type = uc.subscription_type[s];
              } catch(err) {
                var type = 'unknown';
              }
            }
            $('.subscription').last().val(url);
            $('.subscription_type').last().val(type);
          }
        } else if (k !== 'subscription_type') {
          $('#'+k).val(uc[k]);
        }
      }
    } catch(err) {}
    $('.save').bind('click',save);
    try {
      var q = {"size": 0, "query": {"filtered": {"query": {"bool": {"must": [{"term": {"plugin": "instantill"}},{"term": {"from.exact": noddy.user.account._id}}]}}}}};
      q.aggregations = {"embeds": {"terms": {"field": "embedded.exact"}}};
      $.ajax({
        url: api + '/availabilities',
        type: 'POST',
        data: q,
        success: function(iia) {
          try {
            var eurl = iia.aggregations.embeds.buckets[0].key.split('?')[0].split('#')[0];
            var ex = 'For example using the following URL parameter on one of your current embed URLs would automatically trigger an instantill search:<br>';
            ex += eurl + '?doi=10.1145/2908080.2908114';
            $('#embeddedexample').html(ex).show();
          } catch(err) {}
        }
      });
    } catch(err) {}
    if (noddy.hasRole('root')) {
      $('#ill_config').prepend('<input style="border-color:red;" id="uid" type="text" class="form-control setting" placeholder="UID (ADMIN setting override)"><br>')
    }
  }
  noddy.nologin = function() {
    instantill({uid:'oab_site', api:api});
  }
  noddy.login();
});
</script>

<style>
  #instantill {
    border-top: 1px solid #ccc;
    border-bottom: 1px solid #ccc;
  }
</style>

<div class="container-fluid">
  <div class="row">
    <div class="col-md-6">
      <h1 style="font-size:2em;">InstantILL: Form filled, document delivered Instant<b>ILL</b>y</h1>
      <p>
        We've heard from patrons and librarians that they want ILL to be faster, friendlier, cheaper and to advance Open Access. In response, weâ€™re planning a next generation ILL form, codenamed InstantILL, that can:
      </p>
      <ul>
        <li>
          Instantly fill forms, cutting your fields down to just one
        </li>
        <li>
          Instantly deliver content from subscriptions and with Open Access
        </li>
        <li>
          Instantly submit requests, with correct metadata, to your existing ILL system
        </li>
        <li>
          Instantly lighten the load on staff by pre-checking requests against your subscriptions and for Open Access availability
        </li>
        <li>
          Instantly start testing and delivering content without lengthy set-up processes
        </li>
        <li>
          Instantly power a fairer, more open publishing system and cheaper ILL system by working with authors to share their research for free
        </li>
      </ul>
      <p>
        Expect many of InstantILL's features to be provided as free, Open Source, hosted software provided by a library-aligned non-profit. To sustain the work we'll build additional layers of optional paid for features.
      </p>
      <p>
        We need support from libraries to advance this effort, in big and small ways, through helping us build and fund this effort, or sharing your ideas, requirements, and if you'd use it. As we co-design this infrastructure with libraries, learning and building as we go, details may change and initial versions not deliver on all of the above.
      </p>
    </div>

    <div class="col-md-6">
      <div id="tryit">
        <h2>Try it now</h2>

        <div id="instantill"></div>

        <p style="margin-top:10px;">Test it with:
          <ul>
            <li>a DOI: <a class="tryit" href="#">10.1145/2908080.2908114</a></li>
            <li>a title: <a class="tryit" href="#">Ribulose bisphosphate carboxylase: a two-layered, square-shaped molecule of symmetry 422</a></li>
          </ul>
        </p>
      </div>

      <h2>1. Install your own</h2>

      <p class="promptsignup">Please <a href="/account?next=/instantill_alpha" class="label label-info">sign up / sign in</a> so we can customise an InstantILL widget for you.</p>

      <div class="installit" style="display:none;">
        <p id="onlyyou">InstantILL can be installed on your website for general use, but only you will be able to configure it.</p>
        <p>To get started, include the following in the source code (HTML) of your page:</p>
        <pre class="stickidin">
&lt;script src="{{site_url}}/static/instantill.js"&gt;&lt;/script&gt;&lt;script&gt;jQuery(document).ready(function(){instantill();});&lt;/script&gt;
&lt;div id="instantill"&gt;&lt;/div&gt;</pre>

        <p>You should now be good to go!</p>

        <p>If you still can't see the search box on your page you may need to manually include jquery by adding the following line <b>above</b> the one you already added:</p>
        <pre>
&lt;script src="https://openaccessbutton.org/static/jquery-1.10.2.min.js"&gt;&lt;/script&gt;</pre>

        <p>You can control where the search widget gets displayed by moving:</p>
          <pre>
&lt;div id="instantill"&gt;&lt;/div&gt;</pre>

      </div>

      <div class="installit" style="display:none;">

        <h2>2. Configure how you receive ILLs <small>(optional)</small></h2>

        <p>We can forward OpenURL requests (or any request) to your email address or to a URL of your choice, to trigger your ILL workflow.
        Just set your base URL, any necessary URL params that must always be present, <!--, request method,-->
        and the URL parameter keys you would like us to put the various bits of metadata in, if our defaults are not suitable.
        (Our defaults are OpenURL compatible, so these can be used without changes if all you need is OpenURL compatibility.)
        If you don't set a base URL we will just email you by default - for that case, you can provide a URL to your terms
        and conditions so the user can agree to them berore sending their ILL request.</p>

        <p id="ill_config">
          Name of your institution<br>
          <input id="ill_institution" type="text" class="form-control setting" placeholder="Institution name"><br>

          ILL base URL (required)<br>
          <input id="ill_redirect_base_url" type="text" class="form-control setting" placeholder="URL (required)"><br>
          Add any additional params your base URL needs, such as a=b&c=d<br>
          <input id="ill_redirect_params" type="text" class="form-control setting" placeholder="Add any additional params your base URL needs"><br>
          <!--<input id="method" type="text" class="form-control setting" placeholder="default GET"><br>-->
          Add the param used to provide a service ID (which will be InstantILL)<br>
          <input id="sid" type="text" class="form-control setting" placeholder="default sid"><br>

          Title<br>
          <input id="title" type="text" class="form-control setting" placeholder="default atitle"><br>
          Journal title<br>
          <input id="journal" type="text" class="form-control setting" placeholder="default title"><br>
          DOI<br>
          <input id="doi" type="text" class="form-control setting" placeholder="default rft_id"><br>
          Author<br>
          <input id="author" type="text" class="form-control setting" placeholder="default au"><br>
          ISSN<br>
          <input id="issn" type="text" class="form-control setting" placeholder="default issn"><br>
          Volume<br>
          <input id="volume" type="text" class="form-control setting" placeholder="default volume"><br>
          Issue<br>
          <input id="issue" type="text" class="form-control setting" placeholder="default issue"><br>
          Page<br>
          <input id="page" type="text" class="form-control setting" placeholder="default pages"><br>
          Published<br>
          <input id="published" type="text" class="form-control setting" placeholder="default date"><br>
          PMID<br>
          <input id="pmid" type="text" class="form-control setting" placeholder="default pmid"><br>
          <!--<input id="pmcid" type="text" class="form-control setting" placeholder="default pmcid"><br>-->
          Year
          <input id="year" type="text" class="form-control setting" placeholder="default rft.year"><br>

          What do your article ILLs cost, please include your currency symbol? e.g $4
          <input id="cost" type="text" class="form-control setting" placeholder="default free"><br>
          How long do your ILLs take to process on average? e.g 24 hours
          <input id="time" type="text" class="form-control setting" placeholder="default 24 hours"><br>

          What email address do you want ILLs forwarded to? (optional for email alternative)
          <input id="email" type="text" class="form-control setting" placeholder="default is your OAB account email address"><br>
          What email address do you want users referred to? (optional for if there is a problem)
          <input id="problem_email" type="text" class="form-control setting" placeholder="no default, the user will be told to contact their library"><br>

          Terms and conditions URL (optional for email alternative)
          <input id="terms" type="text" class="form-control setting" placeholder=""><br>

          Book request URL (optional for if the user wants a book)
          <input id="book" type="text" class="form-control setting" placeholder="e.g https://ill.ulib.iupui.edu/ILLiad/IUP/illiad.dll?Action=10&Form=21"><br>
          Other request URL (optional for if the user wants something other than article or book)
          <input id="other" type="text" class="form-control setting" placeholder="e.g https://ill.ulib.iupui.edu/ILLiad/IUP/illiad.dll?Action=10&Form=10"><br>

          Insert your WMS URL. We can then give you direct links inside email notifications into WMS to aid loan processing.
          <input id="search" type="text" class="form-control setting" placeholder="e.g  https://ambslibrary.share.worldcat.org/wms/cmnd/nd/discover/items/search"><br>

          <h2>3. Configure your subscription lookup<small>(optional)</small></h2>

          Do you have a subscription lookup URL where you send requests to find out if you have access to content?
          For example an SFX, EDS, or serialssolutions URL? If so, enter it below. Note we also need any required URL parameters
          to be added here, but not article metadata parameters. If you have more than one subscription
          service to check, you can add additional ones below.
          <input type="text" class="form-control subscription setting" placeholder="e.g http://rx8kl6yf4x.search.serialssolutions.com">
          <select class="form-control subscription_type setting">
            <option value="">select subscription type...</option>
            <option value="sfx">SFX</option>
            <option value="eds">EDS / Ebsco</option>
            <option value="serialssolutions">Serials Solutions</option>
          </select>
          <a class="btn btn-primary" id="addsubscription" href="#">Add another</a>
          <br>
          
          An example SFX URL:<br>
          https://cricksfx.hosted.exlibrisgroup.com/crick?sid=Elsevier:Scopus&_service_type=getFullTxt
          <br>An example EDS URL:<br>
          http://resolver.ebscohost.com/openurl
          <br>An example serialssolutions URL:<br>
          http://rx8kl6yf4x.search.serialssolutions.com
          <br><br>Please note, it is also possible that for us to use these URLs our server IP address will have to be whitelisted with your library.
          If this is the case, as we know it often is for EDS for example, please contact us to discuss further. Also, if you have a subscription service
          that we have not shown an example for here, let us know and we will add it for you.
          <br><br>

        </p>

        <p><a class="btn btn-primary btn-block save" href="#">Save your settings</a></p>

        <p>If anything is wrong, <a href="mailto:help@openaccessbutton.org?Subject=Trouble%20setting%20up%20InstantILL&body=Please%20send%20us%20the%20URL%20of%20the%20page%20you're%20working%20on,%20or%20a%20screenshot%20of%20what%20you're%20seeing%20and%20a%20copy%20of%20the%20page's%20code%20-%20right-click%20on%20the%20page%20and%20View%20Page%20Source.">get in touch</a>.</p>

        <h2>4. Configure your openurl link resolver <small>(optional)</small></h2>
        <p>
          If you embed instantill on a web page on your site, you can have it automatically run whenever certain URL parameters
          are present in the web page address. By default this will happen if any of
          'doi','title','url','atitle','rft_id','journal','issn','year','author' are supplied. You can configure these options below.
        </p>
        <p id="embeddedexample" style="display:none;"></p>
        <p>
          <input id="autorun" type="checkbox" class="setting">
          Do not automatically run instantill when identifiable URL parameters are present on the page it is embedded on (this is on by default)
        </p>
        <p>
          Which parameters should trigger instantill automatically. The defaults listed above will be used if this box is left empty.
          Enter any that you want to use, separated by a comma. If you want to use a custom parameter to pass to one of our defaults listed above,
          provide your parameter name followed by an "=" and the default name you want it to match. For example if you wanted to use our default "doi"
          and "title" but with your own custom journal parameter, you could specify this as doi,title,mycustomparam=journal.
        </p>
        <p>
          <input id="autorunparams" type="text" class="form-control setting" placeholder="defaults as above"><br>
        </p>
        <p>
          <input id="intropara" type="checkbox" class="setting">
          Do not show the introductory paragraph before the instantill search box (this is on by default)
        </p>
        <p>
          <input id="norequests" type="checkbox" class="setting">
          Do not generate Open Access Button requests for submitted ILLs (by default we may also create requests to get access when an ILL is generated)
        </p>
        <p>
          <input id="noillifoa" type="checkbox" class="setting">
          Do not allow ILLs if an open access article is found
        </p>
        <p>
          <input id="noillifsub" type="checkbox" class="setting">
          Do not allow ILLs if a subscription article is found
        </p>
        <p>
          <input id="saypaper" type="checkbox" class="setting">
          Use the word "paper" in InstantILL wording instead of the word "article".
        </p>
        <p><a class="btn btn-primary btn-block save" href="#">Save your settings</a></p>
      </div>

    </div>
  </div>



  </div>
</div>




<!-- Code to pull in alpha release banner -->
<script src="https://www.w3schools.com/lib/w3.js"></script>
<div w3-include-html="/static/alpha.html"></div>

<script>
w3.includeHTML();
</script>
