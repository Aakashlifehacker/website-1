<script type="text/javascript" src="//static.cottagelabs.com/d3/d3.v4.min.js"></script>
<script type="text/javascript" src="/static/oabutton_request_holder.js"></script>
<script type="text/javascript" src="//static.cottagelabs.com/holdernew/display/facets.js"></script>

<style>
  .row{
    padding-top:0px;
    padding-bottom:0px;
  }
  body{
    margin-top:80px;
  }
</style>

<div class="holder loading" style="margin:0px;padding:0px;position:fixed;top:80px;left:0;right:0;bottom:0;display:none;z-index:100;min-height:700px;">
  <div style="margin:60px auto 0px auto;width:400px;">
    <img src="/static/spin_orange.svg" style="width:100%;padding-left:100px;">
  </div>
</div>

<div class="container-fluid" style="max-width:1000px;margin:0px auto 10px auto;min-height:500px;display:none;" id="stories">
  <div class="row">
    <div class="col-md-3">
      <div id="fixer" style="position:fixed;max-width:230px;border-radius:3px;padding-left:3px;padding-right:3px;margin-top:30px;">
        <a id="help" href="#" class="btn btn-block btn-action">Help us with requests</a>
        <a id="viewrequests" class="btn btn-block btn-action cloggedin" href="/request" style="display:none;margin-top:5px;">View your requests</a>
        <a href="/" class="btn btn-block btn-action" style="margin-top:5px;margin-bottom:5px;">Start a request</a>
        <div class="holder facets">

        </div>
      </div>
    </div>
    <div class="col-md-9" style="margin-bottom:30px;">
      <div class="holder results from0"></div>
    </div>
  </div>
</div>



<script>
jQuery(document).ready(function() {

  var api = 'https://api.openaccessbutton.org';
  if (window.location.host.indexOf('openaccessbutton.org') === -1 || window.location.host.indexOf('dev.openaccessbutton.org') !== -1) {
    api = 'https://dev.api.cottagelabs.com/service/oab';
    clogin.api = 'https://dev.api.cottagelabs.com/accounts';
    $.fn.holder.use.oabutton.url = api + '/requests';
  }

  var user = clogin.loggedin();
  if (user) {
    $('#viewrequests').bind('click',function(e) {
      e.preventDefault();
      $('.holder.search').val('user.id:'+user.userId).trigger('change');
    });    
  }
  
  var help = function(e) {
    if (e) e.preventDefault();
    $('select.holder[key="status.exact"]').val('help').trigger('change');
  }
  $('#help').bind('click',help);
  
  if ( $(window).width() < 1000 ) {
    // move the search bar out of top nav
  }

  var startup = function() {
    var id;
    if (window.location.href.indexOf('url=') !== -1) id = decodeURIComponent(window.location.href.split('url=')[1].split('&')[0]);
    if (window.location.href.indexOf('doi=') !== -1) id = decodeURIComponent(window.location.href.split('doi=')[1].split('&')[0]);
    if (window.location.href.indexOf('pmid=') !== -1) id = decodeURIComponent(window.location.href.split('pmid=')[1].split('&')[0]);
    if (window.location.href.indexOf('pmc=') !== -1) id = decodeURIComponent(window.location.href.split('pmc=')[1].split('&')[0]);
    if (window.location.href.indexOf('pmcid=') !== -1) id = decodeURIComponent(window.location.href.split('pmcid=')[1].split('&')[0]);
    if (window.location.href.indexOf('title=') !== -1) id = decodeURIComponent(window.location.href.split('title=')[1].split('&')[0]);
    if (window.location.href.indexOf('citation=') !== -1) id = decodeURIComponent(window.location.href.split('citation=')[1].split('&')[0]);
    if (window.location.href.indexOf('identifier=') !== -1) id = decodeURIComponent(window.location.href.split('identifier=')[1].split('&')[0]);
    if (window.location.href.indexOf('ident=') !== -1) id = decodeURIComponent(window.location.href.split('ident=')[1].split('&')[0]);
    if (window.location.href.indexOf('id=') !== -1) id = decodeURIComponent(window.location.href.split('id=')[1].split('&')[0]);
    if (id) {
      $('#footer').hide();
      $('.loading').append('<h3 style="text-align:center;">Starting a new request... one moment please</h3>').show();
      var opts = {
        type: 'POST',
        url: api+'/request',
        dataType: 'json',
        contentType: 'application/json',
        processData: false,
        cache: false,
        data: JSON.stringify({
          url: id,
          type: window.location.href.indexOf('?type=') !== -1 ? window.location.href.split('?type=')[1].split('&')[0] : 'article'
        }),
        success: function(data) {
          window.location = '/request/' + data._id;
        },
        error: function(err) {
          window.location = '/request';
        }
      };
      try { opts.beforeSend = function (request) { request.setRequestHeader("x-apikey", clogin.apikey); } } catch(err) {}
      console.log(opts)
      $.ajax(opts);
    } else {
      var srch = '<li><div id="holder" class="holder" style="width:720px;"> \
        <div class="input-group" style="margin-top:10px;"> \
          <input type="text" class="form-control holder search" do="add" placeholder="Open Access Button - search" style="min-width:600px;"> \
          <div class="input-group-btn"> \
            <a class="btn btn-action btn-block holder" do="add" href="#" style="padding:7px 10px 5px 10px;"><i class="glyphicon glyphicon-search"></i></a> \
          </div> \
        </div> \
        <div class="holder searches" style="margin-top:5px;margin-left:-5px;"></div> \
      </div></li>';
      $('#stories').show();
      $('#navopts').html(srch);
      $('.holder.search').focus();
      $('#holder').holder();
    }
  }

  clogin.afterFailure = startup;
  clogin.afterLogin = startup;
  clogin.login();

});
</script>

