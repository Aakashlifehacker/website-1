
<div class="container-fluid">
  <div class="row">
    <div class="col-md-8 col-md-offset-2">
      <div id="info">
        
      </div>
      <div id="supports" style="margin-top:80px;">
        
      </div>
    </div>
  </div>
</div>



<script>
  jQuery(document).ready(function() {
    var api = 'https://api.openaccessbutton.org';
    if (window.location.host.indexOf('openaccessbutton.org') === -1 || window.location.host.indexOf('dev.openaccessbutton.org') !== -1) {
      api = 'https://dev.api.cottagelabs.com/service/oab';
      clogin.api = 'https://dev.api.cottagelabs.com/accounts';
    }

    var rid = window.location.pathname.split('/')[2];

    var twatit = function() {
      window.twttr = (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0],
          t = window.twttr || {};
        if (d.getElementById(id)) return t;
        js = d.createElement(s);
        js.id = id;
        js.src = "https://platform.twitter.com/widgets.js";
        fjs.parentNode.insertBefore(js, fjs);

        t._e = [];
        t.ready = function(f) {
          t._e.push(f);
        };

        return t;
      }(document, "script", "twitter-wjs"));
    }

    var blacklist = function(e) {
      e.preventDefault();
      var email = $('#email').val();
      $('#email').val("");
      var opts = {
        type:'POST',
        url: api+'/dnr?refuse=false&email=' + email,
        cache:false,
        contentType: 'application/json',
        dataType: 'json'
      }
      $.ajax(opts);
      $("#emailissue").html(email + " blacklisted and removed. Provide a new email address, and/or save this request.").show();
    }
    var submit = function(e) {
      if (e) e.preventDefault();
      var data = {};
      if ( $('#email').length ) data.email = $('#email').val();
      if ( $('#status').length ) data.status = $('#status').val();
      if ( $('#rating').length ) data.rating = $('#rating').val();
      if ( $('#url').length ) data.url = $('#url').val();
      if ( $('#title').length ) data.title = $('#title').val();
      if ( $('#doi').length ) data.doi = $('#doi').val();
      if ( $('#story').length ) data.story = $('#story').val();
      if ( $('#adminstory').length ) data.story = $('#adminstory').val();
      if ( $('#test').length ) {
        $('#test').is(':checked') ? data.test = true : data.test = false;
      }
      var url = api+'/request/'+rid;
      var opts = {
        type:'POST',
        url: url,
        cache:false,
        processData:false,
        contentType: 'application/json',
        dataType: 'json',
        success: function(data) {
          window.location = window.location.href;
        },
        beforeSend: function (request) { request.setRequestHeader("x-apikey", clogin.apikey); }
      }
      opts.data = JSON.stringify(data);
      $.ajax(opts);
    }
    var checkemailthensubmit = function(e) {
      if (e) e.preventDefault();
      $('#emailissue').html("").hide();
      if ( $('#email').length && $('#email').val() && $('#email').val().length ) {
        var email = $('#email').val();
        var opts = {
          type:'GET',
          url: api+'/dnr?validate=true&email=' + email + '&request=' + rid + '&user=' + clogin.user.account._id,
          cache:false,
          contentType: 'application/json',
          dataType: 'json',
          success: function(data) {
            if (data.data.dnr === false) {
              submit(e);
            } else {
              var issue = 'Sorry, ' + email + ' ';
              if (typeof data.data.dnr === 'object') {
                issue += 'was added to our block list on ' + data.data.dnr.created_date.split(' ')[0].split('-').reverse().join('/') + '. We cannot send requests to this email.';
              } else if (data.data.dnr === 'creator') {
                issue += 'matches the creator of this request, so this cannot be the author email address we should contact.';
              } else if (data.data.dnr === 'user') {
                issue += "is your email address! We need the author's email. Are you the author? If so, please see below.";
              } else if (data.data.dnr === 'supporter') {
                issue += 'matches the address of someone who already supports this request. They cannot be a suitable author to contact to request access.';
              } else if (data.data.dnr === 'invalid') {
                issue += 'is not a valid address.';
                if (data.data.validation.did_you_mean) issue += ' Did you mean ' + data.data.validation.did_you_mean + '?';
              }
              $('#email').val("").attr("placeholder",email + " is an unsuitable author email address - please try another");
              $('#emailissue').html(issue).show();
            }
          },
          error: function() {submit(e); } // if we can't do the validation for some reason, just submit anyway
        }
        $.ajax(opts);
      } else {
        submit(e);
      }
    }
    
    var deleteitem = function() {
      $.ajax({
        type:'DELETE',
        url:api+'/request/'+rid,
        beforeSend: function (request) { request.setRequestHeader("x-apikey", clogin.apikey); },
      });
      $('#admin').html('<p>This request has been deleted. You will be redirected to the requests page.</p>');
      setTimeout(function() { window.location = '/request'; }, 2000);
    }
    
    var scrape = function() {
      var url = $('#titlelink').attr('href');
      if (url) {
        $.ajax({
          type:'GET',
          url:api+'/scrape?url='+encodeURIComponent(url),
          success: function(data) {
            if (data.data) {
              if (data.data.title) $('#title').val(data.data.title);
              if (data.data.doi) $('#doi').val(data.data.doi);
              if (data.data.email && data.data.email.length > 0) $('#email').val(data.data.email[0]);
              $('#admin').show();
            }
          }
        });
      }
    }

    var addsupport = function(e) {
      e.preventDefault();
      var opts = {
        type:'POST',
        url: api+'/support/'+rid,
        cache:false,
        processData:false,
        data: JSON.stringify({
          story:$('#supportstory').val()
        }),
        contentType: 'application/json',
        dataType: 'json',
        success: function(data) {
          window.location = window.location.href;
        }
      }
      try { opts.beforeSend = function (request) { request.setRequestHeader("x-apikey", clogin.apikey); } } catch(err) {}
      $.ajax(opts);
    }

    var own = function(e) {
      if (e) e.preventDefault();
      if (clogin.loggedin()) { // nobody will get to the button that triggers this if not logged in
        var opts = {
          type:'POST',
          url: api+'/own/'+rid,
          success: function(data) {
            window.location = window.location.href.split('?')[0];
          },
          beforeSend: function (request) { request.setRequestHeader("x-apikey", clogin.apikey); }
        }
        $.ajax(opts);
      }
    }
    
    var admin = function(record) {
      var dets = '';
      dets += '<p>Status: <select id="status" class="form-control" style="width:150px;display:inline;">';
      var statuses = ['help','moderate','progress','hold','refused','received','closed'];
      for ( var s in statuses ) {
        dets += '<option value="' + statuses[s] + '"';
        if (record.status === statuses[s]) dets += ' selected="selected"';
        dets += '>' + statuses[s] + '</option>';
      }
      dets += '</select>';
      dets += ' &nbsp;&nbsp;&nbsp;test: <input type="checkbox" id="test"';
      if (record.test === true) dets += ' checked="checked"';
      dets += '></p>';
      if (record.location && record.location.geo && record.location.geo.lat) {
        dets += '<p>Location: ' + record.location.geo.lat + ',' + record.location.geo.lon
        if (record.location.location) dets += ' - ' + record.location.location;
        dets += '</p>';
      }
      dets += '</p>';
      dets += '<div class="input-group" style="margin-bottom:10px;"><input type="text" id="email" value="' + record.email + '" placeholder="Author Email" class="form-control">';
      if (record.email) dets += '<div class="input-group-btn"><a id="blacklist" href="#" class="btn btn-action">Blacklist</a></div>';
      dets += '</div>';
      dets += '<p id="emailissue" style="display:none;font-size:0.9em;"></p>';
      dets += '<p><input type="text" id="title" class="form-control" placeholder="Title" value="';
      if (record.title) dets += record.title;
      dets += '"></p>';
      dets += '<p><input type="text" id="doi" class="form-control" placeholder="DOI" value="';
      if (record.doi) dets += record.doi;
      dets += '"></p>';
      dets += '<p><textarea id="adminstory" class="form-control" placeholder="Story" style="min-height:100px;">';
      if (record.story) dets += record.story;
      dets += '</textarea></p>';
      dets += '<p>Story rating: <select id="rating" class="form-control" style="width:100px;display:inline;">';
      var ratings = ["0","1","2","3","4","5"];
      for ( var r in ratings ) {
        dets += '<option value="' + ratings[r] + '"';
        if (record.rating === ratings[r]) dets += ' selected="selected"';
        dets += '>' + ratings[r] + '</option>';
      }
      dets += '</select>';
      dets += '<a class="btn btn-danger pull-right" id="delete" href="#">DELETE</a>';
      dets += '<input type="submit" id="submitchanges" value="Save changes" class="btn btn-action pull-right" style="margin-right:5px;">';
      dets += '</p>';
      dets += '<p style="margin-top:20px;"><a class="btn btn-action" href="/response/' + record.receiver + '">View the response page for this request</a> ';
      dets += '<a class="btn btn-action pull-right" href="/admin?request=' + rid + '">Send email via admin UI about this request</a></p>';
      return dets;
    }
    
    var details = function(data) {
      var rec = data.data;
      
      var sts = {
        moderate: {text:'Awaiting moderation',color:'#eee',highlight:'grey'},
        help: {text:'this request needs more info - can you fill in some blanks and update it?',color:'#fbdad0',highlight:'#f04717'},
        progress: {text:'In progress - read more, support it, provide it!',highlight:'grey',color:'white'},
        received: {text:'Success! This ' + rec.type + ' has been made available!',highlight:'#5cb85c',color:'#dcefdc'},
        refused: {text:'Refused - can you help us try again?',highlight:'#d9534f',color:'#f1c2c0'},
        closed: {text:'Closed - this request could not be completed',highlight:'grey',color:'#eee'}
      }
      var color = rec.status && sts[rec.status] && sts[rec.status].color ? sts[rec.status].color : '#eee';
      var status = rec.status && sts[rec.status] && sts[rec.status].text ? sts[rec.status].text : rec.status;
      var highlight = rec.status && sts[rec.status] && sts[rec.status].highlight ? sts[rec.status].highlight : '#eee';
      var text = rec.status && sts[rec.status] && sts[rec.status].highlight ? sts[rec.status].highlight : 'blue';
      
      var re = '';
      if (rec.status === 'received' && rec.received !== undefined) {
        re += '<div class="well" style="background-color:#dcefdc;margin-bottom:60px;padding-bottom:30px;"><h3 style="text-align:center;">This request has been successful.<br>The ' + rec.type + ' is now available ';
        var surl;
        if (rec.received.url) {
          re += 'at:<br>';
          surl = rec.received.url;
        } else if (rec.received.zenodo) {
          re += 'in Zenodo at:<br>';
          surl = rec.received.zenodo;
        } else if (rec.received.osf) {
          re += 'in the OSF at:<br>';
          surl = rec.received.osf;          
        }
        re += '<a target="_blank" href="' + surl + '" style="word-wrap:break-word;overflow-wrap:break-word;">' + surl + '</a></h3></div>';
      }
      re += '<div class="well" style="margin:30px auto 10px auto;background-color:' + color + '">';
      re += '<p>';
      if (rec.type && rec.type === 'data') re += 'Data for ';
      re += '<b>';
      if (rec.url && rec.url.indexOf('http') === 0) re += '<a id="titlelink" target="_blank" href="' + rec.url + '" style="word-wrap:break-word;overflow-wrap:break-word;">';
      re += rec.title ? rec.title : rec.url;
      if (rec.url && rec.url.indexOf('http') === 0) re += '</a>';
      re += '</b></p>';
      re += '<p style="color:' + text + ';">' + status + '</p>';
      if (rec.story ) re += '<p style="padding:10px 0px 10px 30px;color:#383838;font-style:italic;font-weight:bold;font-size:1.2em;">' + rec.story + '</p>';
      re += '<p>Requested';
      if ( rec.user && (rec.user.firstname || rec.user.username || rec.user.email) ) {
        re += ' by ';
        if (rec.user.firstname) {
          re += rec.user.firstname;
        } else if (rec.user.username) {
          re += rec.user.username;
        } else {
          re += rec.user.email;
        }
        if (rec.user.profession && rec.user.profession !== 'Other') re += ', ' + rec.user.profession;
        if (rec.user.affiliation && rec.user.affiliation.length > 1) re += ' at ' + rec.user.affiliation;
      }
      re += rec.created_date ? ' on ' + rec.created_date.split(' ')[0].split('-').reverse().join('/') : '';
      re += '</p>';
      if (rec.count && rec.count > 1) re += '<p>' + (rec.count - 1) + ' ' + (rec.count === 2 ? 'more person supports' : 'more people support') + ' this request</p>';
      re += '</div>';
      if (rec.user === undefined) {
        if (clogin.loggedin()) {
          re += '<p style="text-align:right;margin-bottom:40px;">This request needs an owner! <a href="#" id="own" class="btn btn-action">Take ownership</a></p>';
        } else {
          re += '<p style="text-align:right;margin-bottom:40px;">This request needs an owner! <a href="/account?next=' + encodeURIComponent('/request/' + rid + '?own=true') + '" class="btn btn-block btn-action">Login/signup and take ownership</a></p>';
        }
      }
      if (rec.status === 'help') {
        if (!rec.title) re += '<p><input class="form-control" type="text" id="title" placeholder="Please provide the article title"></p>';
        if (!rec.email) re += '<p><input class="form-control" type="text" id="email" placeholder="Please provide an article author email"></p>';
        if (!rec.doi) re += '<p><input class="form-control" type="text" id="doi" placeholder="Please provide the article DOI"></p>';
        if (!rec.story) re += '<p><textarea style="min-height:100px;" class="form-control" id="story" placeholder="How would getting access to this research help you? This message will be sent to the author, and helps them to understand why the research should be made available."></textarea></p>';
        if (!rec.title || !rec.email || !rec.doi || !rec.story) re += '<p style="margin-bottom:60px;"><a class="btn btn-action" href="#" id="update">Update</a></p>';
      } else {
        re += '<div class="clearfix" style="margin-bottom:40px;" id="sharebuttons"><a href="#" id="showembed" class="btn btn-xs btn-action panels pull-right" style="margin-left:20px;height:28px;font-size:0.9em;">Embed</a> \
          <div style="display:inline;margin-bottom:-10px;padding-left:20px;" class="pull-right"> \
            <a class="twitter-share-button" href="https://twitter.com/intent/tweet?text=Help us get access to research!" data-size="large"></a> \
          </div> \
          <a class="btn btn-xs btn-action pull-right" style="height:28px;font-size:0.9em;" id="fbshare" href="https://www.facebook.com/sharer/sharer.php?u=" target="_blank"><i class="fa fa-facebook-official"></i> facebook</a></div>';
        re += '<div id="embed" style="display:none;"> \
          <p>Request URL: <code>' + window.location.href + '</code></p> \
          <p>Widget embed code:</p> \
          <textarea id="widget" class="form-control" style="min-height:100px;margin-bottom:40px;" onclick="this.select()">\
          <div id="oab_insert"></div><script>var oabe = function() {var x = new XMLHttpRequest(); x.onreadystatechange = function() { if (x.readyState == 4 && x.status == 200) { document.getElementById("oab_insert").innerHTML = JSON.parse(x.responseText).data; } }; x.open("GET", "' + api+'/embed/'+rid + '", true); x.send(); }();<\/script>\
          </textarea>\
          </div>';
      }
      if (rec.status !== 'received') {
        if (clogin.loggedin() && rec.user && rec.user.id && clogin.user && clogin.user.account && clogin.user.account._id === rec.user.id) {
          // creator does not get asked to support or told that they support
        } else if (rec.user === undefined || !rec.supports || rec.supports === undefined || rec.supports.length === 0) {
          re += '<p>Do you also need this ' + rec.type + '? <a id="showsupport" href="#" style="text-decoration:underline;">Add your support</a></p>';
          re += '<div id="support" style="display:none;margin-top:40px;margin-bottom:40px;">';
          if (!clogin.loggedin()) {
            re += '<p>Support works best with attribution. Please consider <a href="/account?next=' + encodeURIComponent('/request/' + rid + '?support=true') + '">logging in or signing up</a> first.</p>';
          }
          re += '<p><textarea class="form-control" id="supportstory" style="min-height:100px;" placeholder="How would getting access to this research help you? This message will be sent to the author, and helps them to understand why the research should be made available."></textarea></p>';
          re += '<p><a id="addsupport" class="btn btn-action" href="#">Add your support</a></p>';
          re += '</div>';
        } else {
          re += '<p>You have added your support to this request.</p>';
        }
      }
      var ot = rec.type === 'data' ? 'an article' : 'a data';
      if (rec.other) {
        re += '<p>There is also ';
        re += ot + ' request open for this. <a style="text-decoration:underline;" href="/request/' + rec.other + '">View the ' + (rec.type === 'data' ? 'article' : 'data') + ' request</a></p>';
      } else {
        var tot = rec.type === 'data' ? 'article' : 'data';
        re += '<p>Do you want access to the ' + tot + ' as well? <a style="text-decoration:underline;" href="/?url=' + encodeURIComponent(rec.url) + '">Check ' + tot + ' availability</a></p>';
      }
      if (rec.status !== 'received') {
        if (clogin.loggedin() && rec.user && rec.user.id && clogin.user && clogin.user.account && clogin.user.account._id === rec.user.id) {
          // we don't ask the logged in user who created the thing if they can provide it - do we want to ask them anything else here?
        } else {
          re += '<p>Can you provide this ' + rec.type + '? If so we\'d love to hear from you - please <a style="text-decoration:underline;" href="mailto:requests@openaccessbutton.org">contact us</a>!</p>';
        }
      }
      if (clogin.hasRole('openaccessbutton.admin')) {
        re += '<p style="text-align:right;"><a href="#" id="showadmin" style="color:orange;">Admin</a></p>';
        re += '<div id="admin" class="well" style="display:none;background-color:orange;">';
        re += admin(rec);
        re += '</div>';
      }
      $('#info').append(re);
      $('#showembed').bind('click',function(e) { e.preventDefault(); $('#embed').toggle(); });
      if ($('#showadmin').length) $('#showadmin').bind('click',function(e) { e.preventDefault(); $('#admin').toggle(); });
      if ($('#showsupport').length) {
        $('#showsupport').bind('click',function(e) { e.preventDefault(); $('#support').show(); $('#showsupport').parent().hide(); });
        if (window.location.href.indexOf('support=') !== -1) $('#showsupport').trigger('click');
      }
      if ($('#addsupport').length) $('#addsupport').bind('click',addsupport);
      if ($('#own').length) $('#own').bind('click',own);
      if ($('#blacklist').length) $('#blacklist').bind('click',blacklist);
      if ($('#submitchanges').length) $('#submitchanges').bind('click',checkemailthensubmit);
      if ($('#update').length) $('#update').bind('click',submit);
      if ($('#delete').length) $('#delete').bind('click',deleteitem);
      //if (clogin.hasRole('root') && record.status !== 'received') $('#titlelink').bind('click',scrape);
      twatit();
    }
    
    
    // login not necessary but returns supports info if possible, so we try
    var rurl = api + '/request/' + rid;
    var runrequest = function() {
      $.ajax({
        type: 'GET',
        url: rurl,
        success: details,
        error: function() { $('#title').html("Sorry, we can't find a request with ID " + rid); }
      });

    }
    clogin.afterFailure = runrequest;
    if (clogin.loggedin()) {
      clogin.afterLogin = function() {
        if (window.location.href.indexOf('own=') !== -1) {
          own();
        } else {
          rurl += '?apikey=' + clogin.apikey;
          runrequest();          
        }
      };
      clogin.login();
    } else {
      runrequest();
    }
    
    $('#supports').holder({
      url: api + "/supports",
      datatype: 'JSON',
      defaultquery: {
        sort: [
          {
            createdAt: {order: 'desc'}
          }
        ],
        size:500,
        query: {
          filtered: {
            query: {
              bool: {
                must: [
                  {
                    query_string: {
                      query:'rid:'+rid
                    }
                  }
                ]
              }
            }
          }
        }
      },
      ui:false,
      pushstate: false,
      scroll: true,
      record: function(rec) {
        var out = '<hr><p><b>';
        if (rec.firstname) {
          out += rec.firstname;
        } else if (rec.username) {
          out += rec.username;
        } else if (rec.email) {
          out += rec.email;
        } else {
          out += 'Anonymous';
        }
        out += '</b> supports this request';
        if (rec.story) out += ':<br><b>' + rec.story + '</b>'
        out += '</p>';
        $('#supports').append(out);
      }
    });


  });
</script>

