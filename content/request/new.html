
<div class="container-fluid" style="min-height:500px;">
  <div class="row">
    <div class="col-md-12" style="z-index:5;" id="requestpanel">
      <div class="panel panel-default" style="border-color:#398bc5;margin-top:-10px;margin-bottom:200px;">
        <div class="panel-body">
          <div id="findarticle">
            <h3>What do you need?</h3>
            <p><input type="text" id="url" class="form-control" placeholder="Give us an article URL"></p>
            <input type="submit" id="find" value="Find it!" class="btn btn-action btn-block">
            <div class="alert alert-info" id="loadingavailability" style="display:none;margin-top:5px;">
              <img style="height:20px;" src="//static.cottagelabs.com/spinner.gif"> checking availability...
            </div>
          </div>

          <div id="moredetails" style="display:none;margin-top:50px;">
            <p>
              We need a few more details about you before you can make this request. Can you take a second to finish signing up?
            </p>
            <a id="moredetailslink" href="" class="btn btn-block btn-action">Complete your account details</a>
          </div>

          <div id="newrequest" style="display:none;margin-top:50px;">
            <h3 id="createheader">Create a request</h3>
            <div class="alert alert-info" id="loadingscrape" style="display:none;">
              <img style="height:20px;" src="//static.cottagelabs.com/spinner.gif">
              loading details...
            </div>
            <p id="request_article_choice"><input type="checkbox" id="request_article" class="types"> Request the article</p>
            <p id="request_data_choice"><input type="checkbox" id="request_data" class="types"> Request the data</p>

            <p><input type="text" id="title" class="form-control" placeholder="Title" value=""></p>
            <p><input type="text" id="doi" class="form-control" placeholder="DOI (optional, but useful)" value=""></p>
            <p><textarea id="story" class="form-control" placeholder="How would getting access to this research help you? This message will be sent to the author." style="min-height:100px;"></textarea></p>
            <button type="submit" class="btn btn-action btn-block" id="submit" style="margin-top:5px;background-color:#f04717;color:#212f3f;" disabled>
              Say why you need this in up to <br><span id="counter">25</span> words to create this request
            </button>
            <img id="savingspinner" style="height:20px;display:none;" src="//static.cottagelabs.com/spinner.gif">
            <div id="savesuccess" style="display:none;"><p>Saved</p></div>
          </div>

          <div id="loginpls" style="display:none;">
            <h3 id="logintoget" style="text-align:center;">The research you need isn’t available, but you can create a request!</h3>
            <p style="text-align:center;">
              You need to create an account first. Sign up now to begin making requests for articles and data. We’ll contact the author to request the research is made available - and then send you a link.
            </p>
            <p style="text-align:center;">
              Already have an account? Login now!
            </p>
            <a id="login" class="btn btn-action btn-block" href="/account?next=/request/new?url=">Sign up / login</a>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<script>
  jQuery(document).ready(function() {
    // this was copied from the chrome plugin which does not use jquery, hence why it is plain js
    document.getElementById('story').onkeyup = function () {
      var length = document.getElementById('story').value.replace(/  +/g,' ').split(' ').length;
      var left = 25 - length;
      if (left < 0) {
        left = 0;
      }
      if (length === 0) {
        document.getElementById('submit').innerHTML = 'Say why you need this in up to <br><span id="counter">25</span> words to support this request';
        document.getElementById('submit').style.backgroundColor = '#f04717';
      }
      if (length <= 5) {
        document.getElementById('submit').innerHTML = 'Tell us your reason with up to <span id="counter"></span><br> more words to support this request';
        document.getElementById('submit').style.backgroundColor = '#f04717';
      }
      if ( left < 25 && length > 5 ) {
        document.getElementById('submit').removeAttribute('disabled');
      } else {
        document.getElementById('submit').setAttribute('disabled',true);
      }
      if (length > 5 && length <= 10) {
        document.getElementById('submit').innerHTML = 'Great, <span id="counter"></span> words remaining!<br>Write a few more?';
        document.getElementById('submit').style.backgroundColor = '#ffff66';
      }
      if (length > 10 && length <= 20) {
        document.getElementById('submit').innerHTML = '<span id="counter"></span> words left! Or click to submit<br>now and create your request!';
        document.getElementById('submit').style.backgroundColor = '#99ff99';
      }
      if (length > 20) {
        document.getElementById('submit').innerHTML = '<span id="counter"></span>... Click now to submit your<br>reason and create your request';
        document.getElementById('submit').style.backgroundColor = '#99ff99';
      }
      document.getElementById('counter').innerHTML = left;
    };

    var api = 'https://api.openaccessbutton.org';
    if (window.location.host.indexOf('openaccessbutton.org') === -1) {
      api = 'https://dev.api.cottagelabs.com/service/oab';
      clogin.api = 'https://dev.api.cottagelabs.com/accounts';
    }
    clogin.login();

    $('.types').bind('change',function() {
      console.log('fire')
      if ($(this).attr('id') == 'request_data') {
        $('#request_article').prop('checked',false);
      } else {
        $('#request_data').prop('checked',false);
      }
    });

    var locsubmit = function(post,data) {
      /*try {
        if (navigator.geolocation) {
          var opts = {timeout: 5000};
          navigator.geolocation.getCurrentPosition(function (position) {
            data.location = {geo: {lat: position.coords.latitude, lon: position.coords.longitude}};
            post.data = JSON.stringify(data);
            $.ajax(post);
          }, function (error) {
            post.data = JSON.stringify(data);
            $.ajax(post);
          }, opts);
        } else {
          post.data = JSON.stringify(data);
          $.ajax(post);
        }
      } catch (e) {*/
      post.data = JSON.stringify(data);
      $.ajax(post);
      //}
    }

    var submit = function() {
      if ( $('.types:checked').length === 0 || !$('#url').val() || !$('#story').val() ) {
        $('#savesuccess').html('<p><br>Sorry, some information is missing. Please select at least one request type, and provide at least a URL and a story, and select the type of request you want to make.</p>').show();
        setTimeout(function() { $('#savesuccess').html('<p>Saved</p>').hide(); }, 5000);
      } else {
        $('#submit').hide();
        $('#savingspinner').show();
        var data = {};
        data.plugin = 'oab_site_1.0.0';
        data.email = $('#email').val();
        data.url = $('#url').val();
        data.title = $('#title').val();
        data.doi = $('#doi').val();
        data.story = $('#story').val();
        var url = api+'/request';
        var opts = {
          type:'POST',
          url: url,
          cache:false,
          processData:false,
          contentType: 'application/json',
          dataType: 'json',
          success: function(data) {
            var msg = '<p>Your new ' + data.type + ' request has been created. View it at <a href="/request/' + data._id + '">' + data._id + '</a></p>';
            $('#savesuccess').html() === '<p>Saved</p>' ? $('#savesuccess').html(msg) : $('#savesuccess').append(msg);
            if ($('.types:checked').length !== 2) window.location = '/request/' + data._id;
            $('#savesuccess').show();
          },
          beforeSend: function (request) { request.setRequestHeader("x-apikey", clogin.apikey); },
        }
        $('.types:checked').each(function() {
          data.type = $(this).attr('id').replace('request_','');
          locsubmit(opts,data);
        });
      }
    }

    var scrape = function() {
      $('#loadingscrape').show();
      $.ajax({
        type:'GET',
        url:api+'/scrape?url='+encodeURIComponent($('#url').val()),
        success: function(data) {
          $('#loadingscrape').hide();
          if (data.data) {
            if (data.data.title) $('#title').val(data.data.title);
            if (data.data.doi) $('#doi').val(data.data.doi);
            if (data.data.email && data.data.email.length > 0) $('#email').val(data.data.email[0]);
          }
        },
        error: function() { $('#loadingscrape').hide(); }
      });
    }

    var availability = function(e) {
      if ($(this).attr('id') === 'find' || e === undefined || e.keyCode === 13) {
        var url = $('#url').val().trim();
        if (url.lastIndexOf('.') === url.length-1) url = url.substring(0,url.length-1);
        if (url.indexOf('.') === -1 || url.indexOf('/') === -1) {
          // this does not appear to be a URL to a page we would likely check for availability
          // may add other checks here too
          alert('Sorry, what you have entered does not appear to be a vaild URL to a page on a website that we can check for you. Please try again.');
          return false;
        }
        $('#find').hide();
        $('#loadingavailability').show();
        var opts = {
          type:'GET',
          url:api+'/availability?url='+encodeURIComponent(url),
          success: function(data) {
            $('#loadingavailability').hide();
            var create = 'articledata';
            if (data.data.availability.length > 0) {
              for ( var a in data.data.availability ) {
                var ar = data.data.availability[a];
                $('#request_'+ar.type+'_choice').hide();
                $('#url').after('<br><a style="margin-top:5px;" href="' + ar.url + '" class="btn btn-block btn-action">This ' + ar.type + ' is already available!</a> ');
                create = create.replace(ar.type,'');
                // TODO add a share button back in, saying please share that we helped you find this
              }
            }
            if (data.data.requests.length > 0) {
              for ( var r in data.data.requests ) {
                var rr = data.data.requests[r];
                $('#request_'+rr.type).hide();
                $('#url').after('<br><a style="margin-top:5px;" href="' + rr._id + '" class="btn btn-block btn-action">There is already a request for this ' + rr.type + ' - add your support!</a> ');
                create = create.replace(rr.type,'');
              }
            }
            if (create) {
              if (clogin.loggedin()) {
                var acc = clogin.user && clogin.user.account ? clogin.user.account : undefined;
                if (acc && ( !acc.username || !acc.service.openaccessbutton.profile.profession || !acc.profile.name ) ) {
                  $('#moredetailslink').attr('href','/account?next=/request/new?url='+encodeURIComponent($('#url').val()));
                  $('#moredetails').show();
                } else {
                  $('#submit').bind('click',submit);
                  $('#newrequest').show();
                  if (create == 'data') {
                    $('#request_article_choice').hide();
                    $('#request_data_choice').hide();
                    $('#request_data').prop('checked',true);
                    $('#createheader').html('Create a new data request').after("<p>Sorry we couldn't find any data</p>");
                  } else if (create == 'article') {
                    $('#request_article_choice').hide();
                    $('#request_data_choice').hide();
                    $('#request_article').prop('checked',true);
                    $('#createheader').html('Create a new article request').after("<p>Sorry we couldn't find an article</p>");
                  } else {
                    $('#createheader').after("<p>Sorry we couldn't find anything for that URL</p>");
                  }
                  scrape();
                }
              } else {
                if (create === 'data') {
                  $('#logintoget').html("The data isn't available, but you can create a request!");
                } else if (create === 'article') {
                  $('#logintoget').html("The article isn't available, but you can create a request!");
                }
                $('#loginpls').show();
                $('#login').attr('href','/account?next=/request/new?url='+encodeURIComponent($('#url').val()));
              }
            }
          },
          error: function() {
            $('#loadingavailability').hide();
            $('#findarticle').after('<p>Sorry, something went wrong. ');
          }
        };
        if (clogin.apikey) {
          opts.beforeSend = function (request) { request.setRequestHeader("x-apikey", clogin.apikey); };
          opts.type = 'POST';
          opts.url = api+'/availability';
          opts.cache = false;
          opts.processData = false;
          opts.contentType = 'application/json';
          opts.dataType = 'json';
          opts.data = JSON.stringify({url:$('#url').val()});
        }
        $.ajax(opts);
      }
    }
    $('#url').bind('keyup',availability);
    $('#find').bind('click',availability);

    if (window.location.href.indexOf('?url=') !== -1) {
      var url = decodeURIComponent(window.location.href.split('?url=')[1]);
      $('#url').val(url);
      availability();
    }
  });
</script>
