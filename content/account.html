<script>
jQuery(document).ready(function() {
  // on this page, an installed plugin should:
  // look for #apikey field to read api key, after suitable delay to wait for data returned from server
  // hide the download buttons
  // set button as already downloaded, if not already set as such
  // verify that the plugin is successfully installed and has registered the api key

  if (window.innerWidth > 991) {
    $('#cloginArea .well').css('min-height','250px');
  }

  var savecheck = function() {
    if ( $('#username').val() && $('#profile\\.name').val() && $('#service\\.openaccessbutton\\.profile\\.profession').val() && $('#service\\.openaccessbutton\\.profile\\.confirm_public').is(':checked') && $('#service\\.openaccessbutton\\.profile\\.confirm_terms').is(':checked') ) {
      return true;
    } else {
      $('#cloginSaveMessages').html('<p>Some information is missing. Please confirm you have completed all the fields and checked the boxes. Then save again.</p>');
      return false;
    }
  }
  var setvalues = function() {
    if (clogin.user.account.username) {
      $('.username').html(clogin.user.account.username);
      $('#downloads').show();
      if (window.location.href.indexOf('next=') !== -1) {
        $('#tonext').attr('href',window.location.href.split('next=')[1]);
        $('#tonextalert').show();
      }
    } else {
      $('#downloads').hide();
    }
    if (clogin.apikey) $('#apikey').html(clogin.apikey);
    try {
      var p = clogin.user.account.profile ? clogin.user.account.profile : {};
      var s = clogin.user.account.service.openaccessbutton.profile ? clogin.user.account.service.openaccessbutton.profile : {};
      if (!clogin.user.account.username || !p.name || !s.profession || !s.confirm_public || !s.confirm_terms ) {
        if (clogin.user.account.username) {
          $('#username').val(clogin.user.account.username);
        }
        if (p.name) $('#profile\\.name').val(p.name);
        //if (s.orcid) $('#service\\.openaccessbutton\\.profile\\.orcid').val(s.orcid);
        if (s.affiliation) $('#service\\.openaccessbutton\\.profile\\.affiliation').val(s.affiliation);
        if (s.profession) $('#service\\.openaccessbutton\\.profile\\.profession').val(s.profession);
        $('#setinfo').show();
      }
    } catch(err) {
      $('#setinfo').show();
    }
  }
  var aftersave = function() {
    $('#setinfo').hide();
    $('#downloads').show();
    $('.username').html($('#username').val());
    if (window.location.href.indexOf('next=') !== -1) {
      $('#tonext').attr('href',window.location.href.split('next=')[1]);
      $('#tonextalert').show();
    }
  }
  clogin.init({api:'https://dev.api.cottagelabs.com/accounts',afterLogin: setvalues, saveValidate: savecheck, afterSave: aftersave });

  if (window.location.href.indexOf('email=') !== -1) {
    $('#cloginEmail').val(window.location.href.split('next=')[0].split('email=')[1]);
    setTimeout(function() { $('#cloginSubmit').trigger('click'); }, 100);
  }

  var mobileCheck = function() {
    // checks if browser is a mobile or tablet browser
    var check = false;
    (function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4))) check = true;})(navigator.userAgent||navigator.vendor||window.opera);
    return check;
  };
  var mobile = mobileCheck();
  var b = 'bk';
  if (navigator.userAgent.match(/chrome/i) && !mobile) b = '.ch';
  if (navigator.userAgent.match(/firefox/i) && !mobile) b = '.ff';
  if (mobile) b = 'mob';
  $('.dl').hide();
  $('.dl'+b).show();

  var chromeinstall = function(e) {
    e.preventDefault();
    chrome.webstore.install();
  }
  $('#chromeinstall').bind('click',chromeinstall);

  $('#viewrequests').bind('click',function(e) {
    $(this).attr('href','/request?q=user.username.exact:'+clogin.user.account.username);
  });
});
</script>

<div class="container-fluid notcloggedin" id="cloginArea">
  <div class="row">
    <div class="col-md-12">
      <div class="jumbotron" style="margin-top:-10px;">
        <div id="cloginEmailArea">
          <h2 style="text-align:center;">Sign in to your account</h2>
          <p style="text-align:center;">
            No account yet? Just enter your email address to get started.<br>
            We use a password free system.

          </p>
          <input type="text" class="form-control" id="cloginEmail" placeholder="Enter your email address">
          <button id="cloginSubmit" type="submit" class="btn btn-action btn-block" style="border:1px solid white;margin-top:10px;">Sign up / Login</button>
        </div>
        <div id="cloginTokenArea" style="display:none;">
          <h2 style="text-align:center;">Go check your email!</h2>
          <p style="text-align:center;">
            We use a password free system.<br>
            It's magical, more secure, and means you have one less password to remember. The link expires in 30 minutes so be sure to use it soon.
          </p>
          <input type="text" class="form-control" id="cloginToken" placeholder="Enter your login code">
          <p style="text-align:center;">
            <br>If you don't receive an email within a few minutes, check your spam folder. Contact us at
            <a style="color:white;" href="mailto:help@openaccessbutton.org">help@openaccessbutton.org</a> if you don't receive an email.
          </p>
        </div>
        <div id="cloginMessages" style="margin-top:5px;"></div>
        <div id="cloginLoading" style="display:none;"><img style="height:30px;" src="//static.cottagelabs.com/spinner.gif"></div>
      </div>
    </div>
  </div>
</div>


<div class="container-fluid cloggedin" id="userinfo" style="display:none;">
  <div id="tonextalert" class="row" style="display:none;">
    <div class="col-md-12">
      <div class="alert alert-info">
        <h4><a id="tonext" href="">Click here to return to the page you were viewing.</a></h4>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <div class="jumbotron" style="margin-top:-10px;">
        <h1>Hello <span class="username"></span></h1>
        <p><button id="cloginLogout" class="btn btn-danger" style="margin-bottom:5px;">Logout</button></p>
        <p id="apikey" style="display:none;"></p>

        <div id="setinfo" style="display:none;">
          <h1>Thanks for signing up!</h1>
          <input type="text" id="username" class="form-control cloginSave" placeholder="Choose a username (required)">
          <input style="margin-top:5px;" type="text" id="profile.name" class="form-control cloginSave" placeholder="Full name (required)">
          <input style="margin-top:5px;" type="text" id="service.openaccessbutton.profile.affiliation" class="form-control cloginSave" placeholder="Affiliation (University name, Business name etc)">
          <select id="service.openaccessbutton.profile.profession" class="form-control cloginSave" style="margin-top:5px;">
            <option value="">Select the profession which best describes you (required)</option>
            <option value="Student">Student</option>
            <option value="Doctor">Doctor</option>
            <option value="Patient">Patient</option>
            <option value="Advocate">Advocate</option>
            <option value="Academic">Academic</option>
            <option value="Researcher">Researcher</option>
            <option value="Librarian">Librarian</option>
            <option value="Other">Other</option>
            <option value="Undisclosed">Prefer not to say</option>
          </select>
          <p>
            <input id="service.openaccessbutton.profile.confirm_public" type="checkbox" class="cloginSave">
            I understand that information obtained by the Open Access Button will be publicly accessible
          </p>
          <p>
            <input id="service.openaccessbutton.profile.confirm_terms" type="checkbox" class="cloginSave">
            I have read the Open Access Button
            <a target="_blank" href="/privacy" style="color:white;text-decoration:underline;">privacy policy</a>
            and I agree to the
            <a target="_blank" href="/terms" style="color:white;text-decoration:underline;">terms of service</a>
          </p>
          <button id="cloginSave" type="button" class="btn btn-action" style="margin-top:5px;border:1px solid white;">Save your details</button>
          <div id="cloginSaveMessages"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid cloggedin" id="downloads" style="margin-bottom:50px;display:none;">
  <div class="row">
    <div class="col-md-6">
      <h3>Get Started</h3>
      <div id="plugin_messages"></div>
      <a id="chromeinstall" class="btn btn-action btn-block dl ch" target="_blank" href="https://chrome.google.com/webstore/detail/open-access-button/gknkbkaapnhpmkcgkmdekdffgcddoiel">Get your Open Access Button</a>
      <a id="firefoxinstall" class="btn btn-action btn-block dl ff disabled" target="_blank" href="https://addons.mozilla.org/en-GB/firefox/addon/openaccessbutton/">Firefox Plugin Coming Soon</a>
      <p class="dl mob">Doing research on the move? We'd like to make an app for your phone. But, right now you can use it in your browser. Check back when you're by your computer for our plugins.</p>
      <a class="btn btn-action btn-block dl bk">Drag me to your bookmark bar</a>
      <a class="btn btn-action btn-block" href="/request/new">Use the Button in your Browser</a>
      <a class="btn btn-action btn-block" id="viewrequests" href="/request">View your requests</a>
    </div>

    <div class="col-md-6">
      <h3>Instructions</h3>
      <p>We’ve worked hard to make the Button easy to use. Here’s what you need to know:</p>
      <ol>
        <li>The Button works from <a href="https://en.wikipedia.org/wiki/Academic_journal"target="_blank" >Journal articles</a>. You can request the full article from a paywall, and the data from a paywall or full text page.</li>
        <li>If you get an email from us, it’s important.</li>
        <li>If you need help, email us at <a href="mailto:help@openaccessbutton.org">help@openaccessbutton.org</a></li>
      </ol>
      <p>Want to test it out? Try searching for <a href="http://science.sciencemag.org/content/293/5530/629" target="_blank">this article</a>.</p>
    </div>
  </div>
</div>
