<script>
jQuery(document).ready(function() {
  // on this page, an installed plugin should:
  // look for #apikey field to read api key, after suitable delay to wait for data returned from server
  // hide the download buttons
  // set button as already downloaded, if not already set as such
  // verify that the plugin is successfully installed and has registered the api key

  if (window.innerWidth > 991) {
    $('#cloginArea .well').css('min-height','250px');
  }

  var savecheck = function() {
    if ( $('#username').val() && $('#profile\\.name').val() && $('#service\\.openaccessbutton\\.profile\\.profession').val() && $('#service\\.openaccessbutton\\.profile\\.confirm_public').is(':checked') && $('#service\\.openaccessbutton\\.profile\\.confirm_terms').is(':checked') ) {
      return true;
    } else {
      $('#cloginSaveMessages').html('<p>Some information is missing. Please confirm you have completed all the fields and checked the boxes. Then save again.</p>');
      return false;
    }
  }
  var setvalues = function() {
    if (clogin.user.account.username) $('.username').html(clogin.user.account.username);
    if (clogin.apikey) $('#apikey').html(clogin.apikey);
    try {
      var p = clogin.user.account.profile ? clogin.user.account.profile : {};
      var s = clogin.user.account.service.openaccessbutton.profile ? clogin.user.account.service.openaccessbutton.profile : {};
      if (!clogin.user.account.username || !p.name || !s.profession || !s.confirm_public || !s.confirm_terms ) {
        if (clogin.user.account.username) {
          $('#username').val(clogin.user.account.username);
        }
        if (p.name) $('#profile\\.name').val(p.name);
        //if (s.orcid) $('#service\\.openaccessbutton\\.profile\\.orcid').val(s.orcid);
        if (s.affiliation) $('#service\\.openaccessbutton\\.profile\\.affiliation').val(s.affiliation);
        if (s.profession) $('#service\\.openaccessbutton\\.profile\\.profession').val(s.profession);
        $('#setinfo').show();
      }
    } catch(err) {
      $('#setinfo').show();
    }
  }
  var aftersave = function() {
    $('#setinfo').hide();
  }
  clogin.init({api:'https://dev.api.cottagelabs.com/accounts',afterLogin: setvalues, saveValidate: savecheck, afterSave: aftersave });

  var getUrlParameter = function getUrlParameter(sParam) {
    var sPageURL = decodeURIComponent(window.location.search.substring(1)),
      sURLVariables = sPageURL.split('&'),
      sParameterName,
      i;
    for (i = 0; i < sURLVariables.length; i++) {
      sParameterName = sURLVariables[i].split('=');
      if (sParameterName[0] === sParam) {
        return sParameterName[1] === undefined ? true : sParameterName[1];
      }
    }
  };
  var next = getUrlParameter('next');
  if (next) {
    $('#tonext').attr('href',next);
    $('#tonextalert').show();
  }

  var e = getUrlParameter('e');
  if (e) {
    $('#cloginEmail').val(e);
    setTimeout(function() { $('#cloginSubmit').trigger('click'); }, 100);
  }

  var b = navigator.userAgent.match(/chrome/i) ? '.ch' : '.ff';
  $('.dl').hide();
  $('.dl'+b).show();

  var chromeinstall = function(e) {
    e.preventDefault();
    chrome.webstore.install();
  }
  $('#chromeinstall').bind('click',chromeinstall);

});
</script>

<div class="container-fluid notcloggedin" id="cloginArea">
  <div class="row">
    <div class="col-md-12">
      <div class="jumbotron" style="margin-top:-10px;">
        <div id="cloginEmailArea">
          <h2 style="text-align:center;">Sign in to your account</h2>
          <p style="text-align:center;">
            No account yet? Just enter your email address to get started.<br>
            We use a password free system.

          </p>
          <input type="text" class="form-control" id="cloginEmail" placeholder="Enter your email address">
          <button id="cloginSubmit" type="submit" class="btn btn-action btn-block" style="border:1px solid white;margin-top:10px;">Sign up / Login</button>
        </div>
        <div id="cloginTokenArea" style="display:none;">
          <h2 style="text-align:center;">Go check your email!</h2>
          <p style="text-align:center;">
            We use a password free system.<br>
            It's magical, more secure, and means you have one less password to remember. The link expires in 30 minutes so be sure to use it soon.
          </p>
          <input type="text" class="form-control" id="cloginToken" placeholder="Enter your login code">
          <p style="text-align:center;">
            <br>If you don't receive an email within a few minutes, check your spam folder. Contact us at
            <a style="color:white;" href="mailto:hello@openaccessbutton.org">hello@openaccessbutton.org</a> if you don't receive an email.
          </p>
        </div>
        <div id="cloginMessages" style="margin-top:5px;"></div>
        <div id="cloginLoading" style="display:none;"><img style="height:30px;" src="//static.cottagelabs.com/spinner.gif"></div>
      </div>
    </div>
  </div>
</div>


<div class="container-fluid cloggedin" id="userinfo" style="display:none;">
  <div id="tonextalert" class="row" style="display:none;">
    <div class="col-md-12">
      <div class="alert alert-info">
        <h4><a id="tonext" href="">Thanks for signing in. Click here to return to the page you were viewing</a></h4>
      </div>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <div class="jumbotron" style="margin-top:-10px;">
        <h1>Hello <span class="username"></span></h1>
        <p><button id="cloginLogout" class="btn btn-danger" style="margin-bottom:5px;">Logout</button></p>
        <p id="apikey" style="display:none;"></p>

        <div id="setinfo" style="display:none;">
          <h1>Thanks for signing up!</h1>
          <input type="text" id="username" class="form-control cloginSave" placeholder="Choose a username (required)">
          <input style="margin-top:5px;" type="text" id="profile.name" class="form-control cloginSave" placeholder="Full name (required)">
          <input style="margin-top:5px;" type="text" id="service.openaccessbutton.profile.affiliation" class="form-control cloginSave" placeholder="Affiliation (University name, Business name etc">
          <select id="service.openaccessbutton.profile.profession" class="form-control cloginSave" style="margin-top:5px;">
            <option value="">Select the profession which best describes you (required)</option>
            <option value="Student">Student</option>
            <option value="Doctor">Doctor</option>
            <option value="Patient">Patient</option>
            <option value="Advocate">Advocate</option>
            <option value="Academic">Academic</option>
            <option value="Researcher">Researcher</option>
            <option value="Librarian">Librarian</option>
            <option value="Other">Other</option>
            <option value="Undisclosed">Prefer not to say</option>
          </select>
          <input id="service.openaccessbutton.profile.confirm_public" type="checkbox" class="cloginSave">
          <label class="confirm-label">I understand that information obtained by the Open Access Button will be publicly accessible</label><br>
          <input id="service.openaccessbutton.profile.confirm_terms" type="checkbox" class="cloginSave">
          <label class="confirm-label">
            I have read the Open Access Button
            <a target="_blank" href="/privacy" style="color:white;text-decoration:underline;">privacy policy</a>
            and I agree to the
            <a target="_blank" href="/terms" style="color:white;text-decoration:underline;">terms of service</a>
          </label><br>
          <button id="cloginSave" type="button" class="btn btn-action" style="margin-top:5px;border:1px solid white;">Save your details</button>
          <div id="cloginSaveMessages"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="container-fluid cloggedin" id="downloads" style="margin-bottom:50px;">
  <div class="row">
    <div class="col-md-12">
      <div id="plugin_messages"></div>
      <a id="chromeinstall" class="btn btn-action btn-block dl ch" target="_blank" href="https://chrome.google.com/webstore/detail/open-access-button/gknkbkaapnhpmkcgkmdekdffgcddoiel">Get Open Access Button for Chrome</a>
      <a id="firefoxinstall" class="btn btn-action btn-block dl ff" target="_blank" href="https://addons.mozilla.org/en-GB/firefox/addon/openaccessbutton/">Get Open Access Button for Firefox</a>
      <a class="btn btn-action btn-block" target="_blank" href="/request/new">Use the Button in your Browser</a>
    </div>
  </div>
</div>

<!-- if user has requested or supported, show links to filters of requests on their ones -->
<!-- otherwise show a getting started prompt-->
<!-- show the getting started button, in case people want to read instructions, whether new users or not -->
